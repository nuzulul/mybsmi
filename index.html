<!DOCTYPE html>
<html lang="id" class="notranslate" translate="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#f00">
  <meta http-equiv="Content-Security-Policy" content="default-src * 'self' 'unsafe-inline' 'unsafe-eval' data: blob:">
  <meta name="google" content="notranslate">
  <title>MyBSMI</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="web-app-origin-association" href="/.well-known/web-app-origin-association">
  <link rel="stylesheet" href="https://unpkg.com/framework7@7.1.2/framework7-bundle.min.css">
  <link rel="stylesheet" href="https://unpkg.com/framework7-icons">
  <script src='https://www.google.com/recaptcha/api.js'></script>
  <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async=""></script>
  
  <!--------------------------Style-------------------------------------->
  <style>
    :root {
      --f7-panel-transition-duration: 250ms;
      --f7-bars-bg-color: #fff;
      --f7-page-bg-color: #f2f3f8;
      --f7-navbar-border-color: transparent;
      --f7-navbar-shadow-image: linear-gradient(to bottom,
        rgba(0,0,0,0.15) 0%,
        rgba(0,0,0,0.08) 40%,
        rgba(0,0,0,0.04) 50%,
        rgba(0,0,0,0) 90%,
        rgba(0,0,0,0) 100%
      );

    }
    .aurora {
      --f7-list-item-text-font-size: 13px;
      --f7-list-item-text-line-height: 18px;
      --f7-panel-collapsed-width: 44px;
    }
    .ios {
      --f7-panel-collapsed-width: 58px;
    }
    .md {
      --f7-panel-collapsed-width: 60px;
    }
    
    @media (min-width: 1024px) {
      .panel-open[data-panel="left"] {
        display: none !important;
      }
    }
    .panel-left.dark {
      --f7-list-chevron-icon-color: rgba(255,255,255,0.4);
    }
    .panel-left .list .icon,
    .panel-left .treeview .icon {
      color: #fff;
    }
    .panel-left .active-link {
      background-color: var(--f7-theme-color);
      --f7-list-link-hover-bg-color: var(--f7-theme-color-tint);
      --f7-list-link-pressed-bg-color: var(--f7-theme-color-shade);
    }

    .dashboard-cards {
      --f7-card-margin-vertical: 0px;
      --f7-card-margin-horizontal: 0px;
      --f7-card-box-shadow: 0px 0px 13px 0px rgba(82, 63, 105, 0.1);
    }

    .product-image {
      width: 56px;
      height: 56px;
      border-radius: 4px;
    }

    .avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
    }

    @media (min-width: 768px) {
      .card-content.scrollable {
        overflow: auto;
        -webkit-overflow-scrolling: touch;
        height: 260px;
      }
    }

    .timeline-item-divider {
      background: var(--f7-theme-color);
    }
    .timeline-item-divider:after,
    .timeline-item-divider:before {
      width: 2px;
    }

    @media (min-width: 768px) {
      .events-col .card {
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      .events-col .card-content {
        flex-shrink: 10;
        min-height: 0;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
      }
    }
    @media (max-width: 767px) {
      .events-col {
        height: auto !important;
      }
    }

    .tasks-list {
      --f7-list-item-title-white-space: normal;
      --f7-list-item-title-font-weight: 500;
    }
    .aurora .tasks-list {
      --f7-list-item-padding-vertical: 8px;
      --f7-badge-size: 14px;
    }
    .tasks-list .item-media {
      width: 4px;
      min-width: 0 !important;
      margin-right: 5px;
    }
    .tasks-list .category-icon {
      height: 24px;
      width: 4px;
      border-radius: 2px;
      background: var(--f7-theme-color);
    }
    
    img {
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg width='1200' height='630' viewBox='0 0 1200 630' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='1200' height='630' fill='%23DFE5EC' fill-opacity='0.5'/%3e%3cpath d='M760 175H440C428.94 175 420 183.94 420 195V435C420 446.039 428.94 455 440 455H760C771.06 455 780 446.04 780 435V195C780 183.961 771.06 175 760 175V175ZM664.999 245.003C678.799 245.003 689.999 256.203 689.999 270.003C689.999 283.803 678.799 295.002 664.999 295.002C651.199 295.002 639.999 283.803 639.999 270.003C639.999 256.203 651.199 245.003 664.999 245.003ZM479.998 395.007L546.278 242.627L621.657 364.666L686.277 332.565L719.997 395.006H479.999L479.998 395.007Z' fill='%23ACBCCD' fill-opacity='0.5'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: center;
    background-size: cover;
    }

    #my-aktivasi-screen .list .item-after
    {
      margin-left:inherit;
    }

    :root {
      --f7-theme-color: #f00;
      --f7-theme-color-shade: #d60000;
      --f7-theme-color-tint: #ff2929;
      --f7-theme-color-rgb: 255, 0, 0;
    }

  </style>
</head>
<body class="color-theme-red">
  <div id="app">
    <div class="panel panel-left panel-reveal panel-init dark" data-visible-breakpoint="1024" data-collapsed-breakpoint="1">
      <div class="view">
        <div class="page">
          <div class="list">
            <ul>
              <li>
                <a href="/" class="item-content item-link panel-close mybsmi-menu">
                  <div class="item-media">
                    <i class="icon f7-icons">square_grid_2x2_fill</i>
                  </div>
                  <div class="item-inner">
                    <div class="item-title">Beranda</div>
                  </div>
                </a>
              </li>
            </ul>
          </div>

          <div class="list">
            <ul>
              <li>
                <a href="/profilku/" class="item-content item-link panel-close mybsmi-menu">
                  <div class="item-media">
                    <i class="icon f7-icons">person_circle_fill</i>
                  </div>
                  <div class="item-inner">
                    <div class="item-title">Profilku</div>
                  </div>
                </a>
              </li>
            </ul>
          </div>

          <div class="list">
            <ul>
              <li>
                <a href="/ekta/" class="item-content item-link panel-close mybsmi-menu">
                  <div class="item-media">
                    <i class="icon f7-icons">creditcard_fill</i>
                  </div>
                  <div class="item-inner">
                    <div class="item-title">e-KTA</div>
                  </div>
                </a>
              </li>
            </ul>
          </div>

          <div class="list">
            <ul>
              <li>
                <a href="/aktivitas/" class="item-content item-link panel-close mybsmi-menu">
                  <div class="item-media">
                    <i class="icon f7-icons">person_2_square_stack_fill</i>
                  </div>
                  <div class="item-inner">
                    <div class="item-title">Aktivitas</div>
                  </div>
                </a>
              </li>
            </ul>
          </div>

          <div class="list">
            <ul>
              <li>
                <a href="/bukusaku/" class="item-content item-link panel-close mybsmi-menu">
                  <div class="item-media">
                    <i class="icon f7-icons">bookmark_fill</i>
                  </div>
                  <div class="item-inner">
                    <div class="item-title">Buku Saku</div>
                  </div>
                </a>
              </li>
            </ul>
          </div>
<!--
          <div class="list">
            <ul>
              <li>
                <a href="/riwayat/" class="item-content item-link panel-close">
                  <div class="item-media">
                    <i class="icon f7-icons">clock</i>
                  </div>
                  <div class="item-inner">
                    <div class="item-title">Riwayat</div>
                  </div>
                </a>
              </li>
            </ul>
          </div>
-->
<!--
          <div class="list">
            <ul>
              <li>
                <a href="#" class="item-content item-link panel-close my-logout">
                  <div class="item-media">
                    <i class="icon f7-icons">power</i>
                  </div>
                  <div class="item-inner">
                    <div class="item-title">Logout</div>
                  </div>
                </a>
              </li>
            </ul>
          </div>
-->

          <div class="list mybsmi-verifikatormenu" style="display:none">
            <ul>
              <li>
                <a href="/verifikator/" class="item-content item-link panel-close mybsmi-menu">
                  <div class="item-media">
                    <i class="icon f7-icons">checkmark_2</i>
                  </div>
                  <div class="item-inner">
                    <div class="item-title">Verifikator</div>
                  </div>
                </a>
              </li>
            </ul>
          </div>

          <div class="list mybsmi-adminmenu" style="display:none">
            <ul>
              <li>
                <a href="/admin/" class="item-content item-link panel-close mybsmi-menu">
                  <div class="item-media">
                    <i class="icon f7-icons">chart_pie_fill</i>
                  </div>
                  <div class="item-inner">
                    <div class="item-title">Admin</div>
                  </div>
                </a>
              </li>
            </ul>
          </div>

<!--
          <div class="list">
            <ul>
              <li>
                <a href="#" class="item-content item-link">
                  <div class="item-media">
                    <i class="icon f7-icons">folder_fill</i>
                  </div>
                  <div class="item-inner">
                    <div class="item-title">Categories</div>
                  </div>
                </a>
              </li>
              <li>
                <a href="#" class="item-content item-link">
                  <div class="item-media">
                    <i class="icon f7-icons">cart_fill</i>
                  </div>
                  <div class="item-inner">
                    <div class="item-title">Products</div>
                  </div>
                </a>
              </li>
            </ul>
          </div>

          <div class="list">
            <ul>
              <li>
                <a href="#" class="item-content item-link">
                  <div class="item-media">
                    <i class="icon f7-icons">bag_fill</i>
                  </div>
                  <div class="item-inner">
                    <div class="item-title">Sales</div>
                  </div>
                </a>
              </li>
              <li>
                <a href="#" class="item-content item-link">
                  <div class="item-media">
                    <i class="icon f7-icons">graph_circle_fill</i>
                  </div>
                  <div class="item-inner">
                    <div class="item-title">Analytics</div>
                  </div>
                </a>
              </li>
            </ul>
          </div>

          <div class="block block-strong no-padding-horizontal padding-vertical-half">
            <div class="treeview">
              <div class="treeview-item">
                <div class="treeview-item-root treeview-item-toggle">
                  <div class="treeview-toggle"></div>
                  <div class="treeview-item-content">
                    <div class="treeview-item-label">Departments</div>
                  </div>
                </div>
                <div class="treeview-item-children">
                  <div class="treeview-item">
                    <a href="#" class="treeview-item-root">
                      <div class="treeview-item-content">
                        <div class="treeview-item-label">New York</div>
                      </div>
                    </a>
                  </div>
                  <div class="treeview-item">
                    <a href="#" class="treeview-item-root">
                      <div class="treeview-item-content">
                        <div class="treeview-item-label">London</div>
                      </div>
                    </a>
                  </div>
                  <div class="treeview-item">
                    <a href="#" class="treeview-item-root">
                      <div class="treeview-item-content">
                        <div class="treeview-item-label">Beijing</div>
                      </div>
                    </a>
                  </div>
                  <div class="treeview-item">
                    <a href="#" class="treeview-item-root">
                      <div class="treeview-item-content">
                        <div class="treeview-item-label">Tokyo</div>
                      </div>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
-->
          
          
          
        </div>
      </div>
    </div>
    <div class="view view-main view-init">
      <div class="page">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner">
            <div class="left">
              <a class="link panel-open icon-only" data-panel="left">
                <i class="icon f7-icons">bars</i>
              </a>
            </div>
            <div class="title">Beranda</div>
            <div class="right">
              <a class="link popover-open" data-popover=".profile-popover">
                <span class="margin-right-half"></span>
                <img src="avatar.png" class="avatar mybsmi-avatar"><span class="badge color-blue mybsmi-avatar-badge" style="left:-8px;bottom:-5px;display:none;"><i class="icon f7-icons" style="font-size:12px;">checkmark_seal</i></span>
              </a>
            </div>
            <div class="title-large">
              <div class="title-large-text display-flex align-items-center">
                <i class="icon f7-icons margin-right-half" style="font-size: 24px">square_grid_2x2_fill</i>
                <span>Beranda</span>
              </div>
            </div>
          </div>
        </div>
        <div class="popover profile-popover">
          <div class="popover-inner">
            <h3 class="text-align-center mybsmi-currentusernama">User</h3>
            <div class="list no-hairlines no-hairlines-between">
              <ul>
                <li>
                  <a href="/riwayat/" class="item-link item-content link popover-close" data-popover=".profile-popover">
                    <div class="item-media">
                      <i class="icon f7-icons">clock</i>
                    </div>
                    <div class="item-inner">
                      <div class="item-title">Riwayat</div>
                    </div>
                  </a>
                </li>
                <li>
                  <a href="/pesan/" class="item-link item-content link popover-close" data-popover=".profile-popover">
                    <div class="item-media">
                      <i class="icon f7-icons">envelope_fill</i>
                    </div>
                    <div class="item-inner">
                      <div class="item-title">Pesan</div>
                    </div>
                  </a>
                </li>
                <li>
                  <a href="#" class="item-link item-content link popover-close mybsmi-install display-none" data-popover=".profile-popover">
                    <div class="item-media">
                      <i class="icon f7-icons">tray_arrow_down_fill</i>
                    </div>
                    <div class="item-inner">
                      <div class="item-title">Install</div>
                    </div>
                  </a>
                </li>
                <li>
                  <a href="#" target="_blank" class="item-link item-content link popover-close mybsmi-bukaapp display-none" data-popover=".profile-popover">
                    <div class="item-media">
                      <i class="icon f7-icons">app</i>
                    </div>
                    <div class="item-inner">
                      <div class="item-title">Buka App</div>
                    </div>
                  </a>
                </li>
                <li>
                  <a href="#" target="_blank" class="item-link item-content link popover-close mybsmi-refresh" data-popover=".profile-popover">
                    <div class="item-media">
                      <i class="icon f7-icons">arrow_clockwise_circle</i>
                    </div>
                    <div class="item-inner">
                      <div class="item-title">Refresh</div>
                    </div>
                  </a>
                </li>
              </ul>
            </div>

            <div class="list no-hairlines no-hairlines-between margin-bottom">
              <ul>
                <li>
                  <a href="#" class="item-link item-content my-logout">
                    <div class="item-media">
                      <i class="icon f7-icons">exit_fill</i>
                    </div>
                    <div class="item-inner">
                      <div class="item-title">Logout</div>
                    </div>
                  </a>
                </li>
              </ul>
            </div>

          </div>
        </div>
        <div class="toolbar toolbar-bottom">
          <div class="toolbar-inner">
            2023 &copy; MyBSMI
          </div>
        </div>
        <div class="page-content hide-toolbar-on-scroll">
          <div class="dashboard-cards">
            <div class="row margin-horizontal">
              
              <div class="col-100 medium-66 margin-top charts-col">
                <div class="row">
                  <div class="col-50">
                    <div class="card">
                      <div class="card-header">Cabang</div>
                      <div class="card-content card-content-padding text-align-center">
                        <div
                          class="gauge gauge-init"
                          id="mybsmi-cabang" 
                          data-type="circle"
                          data-value="0.00"
                          data-value-text="0"
                          data-label-text="Kota/Kabupaten"
                          data-value-text-color="#f44336"
                          data-border-color="#f44336"
                          data-border-width="30"
                        ></div>
                      </div>
                    </div>
                  </div>
                  <div class="col-50">
                    <div class="card">
                      <div class="card-header">Relawan</div>
                      <div class="card-content card-content-padding text-align-center">
                        <div
                          class="gauge gauge-init"
                          id="mybsmi-relawan" 
                          data-type="circle"
                          data-value="0.00"
                          data-value-text="0"
                          data-label-text="Orang"
                          data-value-text-color="#ff9800"
                          data-border-color="#ff9800"
                          data-border-width="30"
                        ></div>
                      </div>
                    </div>
                  </div>

                </div>
              </div>
              
              
<!--              
              <div class="col-100 medium-33 margin-top events-col">
                <div class="card">
                  <div class="card-header">Latest Events</div>
                  <div class="card-content card-content-padding">
                    <div class="timeline no-margin no-padding">
                      <div class="timeline-item">
                        <div class="timeline-item-date">10:00</div>
                        <div class="timeline-item-divider"></div>
                        <div class="timeline-item-content">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Dolor fugiat ipsam hic</div>
                      </div>
                      <div class="timeline-item">
                        <div class="timeline-item-date">11:00</div>
                        <div class="timeline-item-divider"></div>
                        <div class="timeline-item-content">Another text goes here</div>
                      </div>
                      <div class="timeline-item">
                        <div class="timeline-item-date">14:45</div>
                        <div class="timeline-item-divider"></div>
                        <div class="timeline-item-content">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Dolor fugiat ipsam hic porro enim, accusamus perferendis, quas commodi alias quaerat eius nemo deleniti. Odio quasi quos quis iure, aperiam pariatur?</div>
                      </div>
                      <div class="timeline-item">
                        <div class="timeline-item-date">16:24</div>
                        <div class="timeline-item-divider"></div>
                        <div class="timeline-item-content">One more text here</div>
                      </div>
                      <div class="timeline-item">
                        <div class="timeline-item-date">17:11</div>
                        <div class="timeline-item-divider"></div>
                        <div class="timeline-item-content">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Dolor fugiat ipsam hic</div>
                      </div>
                      <div class="timeline-item">
                        <div class="timeline-item-date">17:28</div>
                        <div class="timeline-item-divider"></div>
                        <div class="timeline-item-content">Another text goes here</div>
                      </div>
                      <div class="timeline-item">
                        <div class="timeline-item-date">18:00</div>
                        <div class="timeline-item-divider"></div>
                        <div class="timeline-item-content">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Dolor fugiat ipsam hic porro enim, accusamus perferendis, quas commodi alias quaerat eius nemo deleniti. Odio quasi quos quis iure, aperiam pariatur?</div>
                      </div>
                      <div class="timeline-item">
                        <div class="timeline-item-date">19:19</div>
                        <div class="timeline-item-divider"></div>
                        <div class="timeline-item-content">One more text here</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
-->              
              
              
              
            </div>
            
<!--            <div class="row margin-horizontal">
              <div class="col-100 medium-66 margin-top">
                <div class="card">
                  <div class="card-header">
                    <span>Best Sellers</span>
                    <div class="segmented">
                      <a class="button button-small button-outline tab-link-active tab-link" style="width:auto">Today</a>
                      <a class="button button-small button-outline tab-link" style="width:auto">Week</a>
                      <a class="button button-small button-outline tab-link" style="width:auto">Month</a>
                    </div>
                  </div>
                  <div class="card-content card-content-padding scrollable">
                    <div class="list media-list">
                      <ul>
                        <li class="item-content">
                          <div class="item-media">
                            <img class="product-image" src="https://placeimg.com/112/112/1">
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">Logo Design</div>
                              <div class="item-after">12 sales</div>
                            </div>
                            <div class="item-text">Design</div>
                          </div>
                        </li>
                        <li class="item-content">
                          <div class="item-media">
                            <img class="product-image" src="https://placeimg.com/112/112/2">
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">Website Design</div>
                              <div class="item-after">10 sales</div>
                            </div>
                            <div class="item-text">Design</div>
                          </div>
                        </li>
                        <li class="item-content">
                          <div class="item-media">
                            <img class="product-image" src="https://placeimg.com/112/112/3">
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">PSD to HTML</div>
                              <div class="item-after">8 sales</div>
                            </div>
                            <div class="item-text">Coding</div>
                          </div>
                        </li>
                        <li class="item-content">
                          <div class="item-media">
                            <img class="product-image" src="https://placeimg.com/112/112/4">
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">Business Card</div>
                              <div class="item-after">7 sales</div>
                            </div>
                            <div class="item-text">Design</div>
                          </div>
                        </li>
                        <li class="item-content">
                          <div class="item-media">
                            <img class="product-image" src="https://placeimg.com/112/112/5">
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">Sketch to HTML</div>
                              <div class="item-after">5 sales</div>
                            </div>
                            <div class="item-text">Coding</div>
                          </div>
                        </li>
                        <li class="item-content">
                          <div class="item-media">
                            <img class="product-image" src="https://placeimg.com/112/112/5">
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">Vecotor assets</div>
                              <div class="item-after">4 sales</div>
                            </div>
                            <div class="item-text">Design</div>
                          </div>
                        </li>
                        <li class="item-content">
                          <div class="item-media">
                            <img class="product-image" src="https://placeimg.com/112/112/6">
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">50 Twitter Folowers Pack</div>
                              <div class="item-after">3 sales</div>
                            </div>
                            <div class="item-text">Social</div>
                          </div>
                        </li>
                        <li class="item-content">
                          <div class="item-media">
                            <img class="product-image" src="https://placeimg.com/112/112/6">
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">100 Twitter Folowers Pack</div>
                              <div class="item-after">2 sales</div>
                            </div>
                            <div class="item-text">Social</div>
                          </div>
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
-->

              
<!--
              <div class="col-100 medium-33 margin-top">
                <div class="card">
                  <div class="card-header">New Users</div>
                  <div class="card-content card-content-padding scrollable">
                    <div class="list media-list">
                      <ul>
                        <li class="item-content">
                          <div class="item-media">
                            <img class="avatar" src="https://i.pravatar.cc/56?u=1">
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">John Doe</div>
                            </div>
                            <div class="item-text">john@doe.com</div>
                          </div>
                        </li>
                        <li class="item-content">
                          <div class="item-media">
                            <img class="avatar" src="https://i.pravatar.cc/56?u=2">
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">Jane Doe</div>
                            </div>
                            <div class="item-text">jane@doe.com</div>
                          </div>
                        </li>
                        <li class="item-content">
                          <div class="item-media">
                            <img class="avatar" src="https://i.pravatar.cc/56?u=3">
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">Kate</div>
                            </div>
                            <div class="item-text">kate@athome.app</div>
                          </div>
                        </li>
                        <li class="item-content">
                          <div class="item-media">
                            <img class="avatar" src="https://i.pravatar.cc/56?u=4">
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">Mary</div>
                            </div>
                            <div class="item-text">-</div>
                          </div>
                        </li>
                        <li class="item-content">
                          <div class="item-media">
                            <img class="avatar" src="https://i.pravatar.cc/56?u=5">
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">Frame Work</div>
                            </div>
                            <div class="item-text">frame@work7.com</div>
                          </div>
                        </li>
                        <li class="item-content">
                          <div class="item-media">
                            <img class="avatar" src="https://i.pravatar.cc/56?u=1">
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">John Doe</div>
                            </div>
                            <div class="item-text">john@doe.com</div>
                          </div>
                        </li>
                        <li class="item-content">
                          <div class="item-media">
                            <img class="avatar" src="https://i.pravatar.cc/56?u=2">
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">Jane Doe</div>
                            </div>
                            <div class="item-text">jane@doe.com</div>
                          </div>
                        </li>
                        <li class="item-content">
                          <div class="item-media">
                            <img class="avatar" src="https://i.pravatar.cc/56?u=3">
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">Kate</div>
                            </div>
                            <div class="item-text">kate@athome.app</div>
                          </div>
                        </li>
                        <li class="item-content">
                          <div class="item-media">
                            <img class="avatar" src="https://i.pravatar.cc/56?u=4">
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">Mary</div>
                            </div>
                            <div class="item-text">-</div>
                          </div>
                        </li>
                        <li class="item-content">
                          <div class="item-media">
                            <img class="avatar" src="https://i.pravatar.cc/56?u=5">
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">Frame Work</div>
                            </div>
                            <div class="item-text">frame@work7.com</div>
                          </div>
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
-->




            <div class="row margin-horizontal margin-bottom">
              <div class="col-100 medium-66 margin-top">
                <div class="card data-table">
                  <div class="card-header">Statistik</div>
                  <div class="card-content">
                    <table>
                      <thead>
                        <tr>
                          <th class="label-cell">BSMI Provinsi</th>
                          <th class="numeric-cell">Relawan</th>
                        </tr>
                      </thead>
                      <tbody class="mybsmi-rekapitulasiprov">
                        <!--<tr>
                          <td class="label-cell">BSMI Kota Surabaya</td>
                          <td class="numeric-cell">1000</td>
                        </tr>-->
                      </tbody>
                    </table>
                    <table>
                      <thead>
                        <tr>
                          <th class="label-cell">BSMI Kota/Kabupaten</th>
                          <th class="numeric-cell">Relawan</th>
                        </tr>
                      </thead>
                      <tbody class="mybsmi-rekapitulasicabang">
                        <!--<tr>
                          <td class="label-cell">BSMI Kota Surabaya</td>
                          <td class="numeric-cell">1000</td>
                        </tr>-->
                      </tbody>
                    </table>
                    <div class="data-table-footer">
                      <!--<div class="data-table-rows-select">
                        Rows per page:
                        <div class="input input-dropdown input-with-value">
                          <select class="input-with-value">
                            <option value="5">5</option>
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="all">All</option>
                          </select>
                        </div>
                      </div>
                      <div class="data-table-pagination">
                        <span class="data-table-pagination-label">1-5 of 10</span>
                        <a href="#" class="link disabled">
                          <i class="icon icon-prev color-gray"></i>
                        </a>
                        <a href="#" class="link">
                          <i class="icon icon-next color-gray"></i>
                        </a>
                      </div>-->
                    </div>
                  </div>

                </div>
              </div>
            </div>



<!--
            <div class="row margin-horizontal margin-bottom">
              <div class="col-100 medium-33 margin-top">
                <div class="card">
                  <div class="card-header">Notifications</div>
                  <div class="card-content card-content-padding scrollable">
                    <div class="list media-list">
                      <ul>
                        <li class="item-content">
                          <div class="item-media">
                            <i class="icon f7-icons text-color-yellow">exclamationmark_triangle_fill</i>
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">Server access error</div>
                              <div class="item-after">15:45</div>
                            </div>
                            <div class="item-text">Lorem ipsum dolor sit amet, consectetuer edipiscing elit</div>
                          </div>
                        </li>
                        <li class="item-content">
                          <div class="item-media">
                            <i class="icon f7-icons text-color-green">cart_fill</i>
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">New order received</div>
                              <div class="item-after">13:20</div>
                            </div>
                            <div class="item-text">Lorem ipsum dolor sit amet, consectetuer edipiscing elit</div>
                          </div>
                        </li>
                        <li class="item-content">
                          <div class="item-media">
                            <i class="icon f7-icons text-color-green">cart_fill</i>
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">New order received</div>
                              <div class="item-after">11:11</div>
                            </div>
                            <div class="item-text">Lorem ipsum dolor sit amet, consectetuer edipiscing elit</div>
                          </div>
                        </li>
                        <li class="item-content">
                          <div class="item-media">
                            <i class="icon f7-icons text-color-blue">person_circle_fill</i>
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">New user registered</div>
                              <div class="item-after">10:16</div>
                            </div>
                            <div class="item-text">Lorem ipsum dolor sit amet, consectetuer edipiscing elit</div>
                          </div>
                        </li>
                        <li class="item-content">
                          <div class="item-media">
                            <i class="icon f7-icons text-color-teal">document_text_fill</i>
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">New report uploaded</div>
                              <div class="item-after">02:00</div>
                            </div>
                            <div class="item-text">Lorem ipsum dolor sit amet, consectetuer edipiscing elit</div>
                          </div>
                        </li>
                        <li class="item-content">
                          <div class="item-media">
                            <i class="icon f7-icons text-color-blue">person_circle_fill</i>
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">New user registered</div>
                              <div class="item-after">Yesterday at 22:56</div>
                            </div>
                            <div class="item-text">Lorem ipsum dolor sit amet, consectetuer edipiscing elit</div>
                          </div>
                        </li>
                        <li class="item-content">
                          <div class="item-media">
                            <i class="icon f7-icons text-color-blue">person_circle_fill</i>
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">New user registered</div>
                              <div class="item-after">Yesterday at 20:10</div>
                            </div>
                            <div class="item-text">Lorem ipsum dolor sit amet, consectetuer edipiscing elit</div>
                          </div>
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
-->

<!--
              <div class="col-100 medium-33 margin-top">
                <div class="card">
                  <div class="card-header">Tasks</div>
                  <div class="card-content card-content-padding scrollable">
                    <div class="list tasks-list">
                      <ul>
                        <li>
                          <label class="item-checkbox item-content">
                            <div class="item-media">
                              <span class="category-icon color-blue"></span>
                            </div>
                            <input type="checkbox"/>
                            <i class="icon icon-checkbox"></i>
                            <div class="item-inner">
                              <div class="item-title">Prepare docs for meeting</div>
                            </div>
                          </label>
                        </li>
                        <li>
                          <label class="item-checkbox item-content">
                            <div class="item-media">
                              <span class="category-icon color-blue"></span>
                            </div>
                            <input type="checkbox"/>
                            <i class="icon icon-checkbox"></i>
                            <div class="item-inner">
                              <div class="item-title">Add new HS spectrum module to Color Picker</div>
                            </div>
                          </label>
                        </li>
                        <li>
                          <label class="item-checkbox item-content">
                            <div class="item-media">
                              <span class="category-icon color-orange"></span>
                            </div>
                            <input type="checkbox"/>
                            <i class="icon icon-checkbox"></i>
                            <div class="item-inner">
                              <div class="item-title">Add year/month selector to Calendar component</div>
                            </div>
                          </label>
                        </li>
                        <li>
                          <label class="item-checkbox item-content">
                            <div class="item-media">
                              <span class="category-icon color-green"></span>
                            </div>
                            <input type="checkbox"/>
                            <i class="icon icon-checkbox"></i>
                            <div class="item-inner">
                              <div class="item-title">Add new experimental set</div>
                            </div>
                          </label>
                        </li>
                        <li>
                          <label class="item-checkbox item-content">
                            <div class="item-media">
                              <span class="category-icon color-pink"></span>
                            </div>
                            <input type="checkbox"/>
                            <i class="icon icon-checkbox"></i>
                            <div class="item-inner">
                              <div class="item-title">Add learning mode to instruments set</div>
                            </div>
                          </label>
                        </li>
                        <li>
                          <label class="item-checkbox item-content">
                            <div class="item-media">
                              <span class="category-icon color-blue"></span>
                            </div>
                            <input type="checkbox"/>
                            <i class="icon icon-checkbox"></i>
                            <div class="item-inner">
                              <div class="item-title">Prepare docs for meeting</div>
                            </div>
                          </label>
                        </li>
                        <li>
                          <label class="item-checkbox item-content">
                            <div class="item-media">
                              <span class="category-icon color-blue"></span>
                            </div>
                            <input type="checkbox"/>
                            <i class="icon icon-checkbox"></i>
                            <div class="item-inner">
                              <div class="item-title">Add new HS spectrum module to Color Picker</div>
                            </div>
                          </label>
                        </li>
                        <li>
                          <label class="item-checkbox item-content">
                            <div class="item-media">
                              <span class="category-icon color-orange"></span>
                            </div>
                            <input type="checkbox"/>
                            <i class="icon icon-checkbox"></i>
                            <div class="item-inner">
                              <div class="item-title">Add year/month selector to Calendar component</div>
                            </div>
                          </label>
                        </li>
                        <li>
                          <label class="item-checkbox item-content">
                            <div class="item-media">
                              <span class="category-icon color-green"></span>
                            </div>
                            <input type="checkbox"/>
                            <i class="icon icon-checkbox"></i>
                            <div class="item-inner">
                              <div class="item-title">Add new experimental set</div>
                            </div>
                          </label>
                        </li>
                        <li>
                          <label class="item-checkbox item-content">
                            <div class="item-media">
                              <span class="category-icon color-pink"></span>
                            </div>
                            <input type="checkbox"/>
                            <i class="icon icon-checkbox"></i>
                            <div class="item-inner">
                              <div class="item-title">Add learning mode to instruments set</div>
                            </div>
                          </label>
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
-->

<!--
              <div class="col-100 medium-33 margin-top">
                <div class="card">
                  <div class="card-header">Support Tickets</div>
                  <div class="card-content card-content-padding scrollable">
                    <div class="list media-list" style="--f7-list-item-text-max-lines: 5">
                      <ul>
                        <li class="item-content">
                          <div class="item-media">
                            <img class="avatar" src="https://i.pravatar.cc/56?u=1">
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">John Doe</div>
                              <div class="item-after"><span class="badge color-blue">Pending</span></div>
                            </div>
                            <div class="item-subtitle">1 hour ago</div>
                            <div class="item-text">Lorem ipsum dolor sit amet,consectetuer edipiscing elit,sed diam nonummy nibh euismod tinciduntut laoreet doloremagna aliquam erat volutpat.</div>
                          </div>
                        </li>
                        <li class="item-content">
                          <div class="item-media">
                            <img class="avatar" src="https://i.pravatar.cc/56?u=2">
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">Jane Doe</div>
                              <div class="item-after"><span class="badge color-green">Closed</span></div>
                            </div>
                            <div class="item-subtitle">6 hours ago</div>
                            <div class="item-text">Sed diam nonummy nibh euismod tinciduntut laoreet doloremagna aliquam erat volutpat.Ut wisi enim ad minim veniam,quis nostrud exerci tation ullamcorper.</div>
                          </div>
                        </li>
                        <li class="item-content">
                          <div class="item-media">
                            <img class="avatar" src="https://i.pravatar.cc/56?u=3">
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">Kate</div>
                              <div class="item-after"><span class="badge color-green">Closed</span></div>
                            </div>
                            <div class="item-subtitle">1 day ago</div>
                            <div class="item-text">Lorem ipsum dolor sit amet,consectetuer edipiscing elit,sed diam nonummy nibh euismod tinciduntut laoreet doloremagna aliquam erat volutpat.</div>
                          </div>
                        </li>
                        <li class="item-content">
                          <div class="item-media">
                            <img class="avatar" src="https://i.pravatar.cc/56?u=4">
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">Mary</div>
                              <div class="item-after"><span class="badge color-orange">Issue</span></div>
                            </div>
                            <div class="item-subtitle">3 days ago</div>
                            <div class="item-text">Sed diam nonummy nibh euismod tinciduntut laoreet doloremagna aliquam erat volutpat.Ut wisi enim ad minim veniam,quis nostrud exerci tation ullamcorper.</div>
                          </div>
                        </li>
                        <li class="item-content">
                          <div class="item-media">
                            <img class="avatar" src="https://i.pravatar.cc/56?u=5">
                          </div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">Frame Work</div>
                              <div class="item-after"><span class="badge color-blue">Pending</span></div>
                            </div>
                            <div class="item-subtitle">5 days ago</div>
                            <div class="item-text">Lorem ipsum dolor sit amet,consectetuer edipiscing elit,sed diam nonummy nibh euismod tinciduntut laoreet doloremagna aliquam erat volutpat.</div>
                          </div>
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
-->              
              
              
            
              
            </div>  
          </div>

        </div>
      </div>

<!--start login------------------------------------------------------------------------------->
    <form class="login-screen" id="my-login-screen">
      <div class="view">
        <div class="page">
          <div class="page-content login-screen-content">
            <div class="login-screen-title">Login</div>
            <div class="list">
              <ul>
                <li class="item-content item-input">
                  <div class="item-inner">
                    <div class="item-title item-label">Email</div>
                    <div class="item-input-wrap">
                      <input type="email" name="email" placeholder="Alamat email" required validate>
                    </div>
                  </div>
                </li>
                <li class="item-content item-input">
                  <div class="item-inner">
                    <div class="item-title item-label">Password</div>
                    <div class="item-input-wrap">
                      <input type="password" name="password" placeholder="Password" minlength="10" required validate>
                    </div>
                  </div>
                </li>
                <li class="item-content item-input">
                  <div style="padding:20px 20px;justify-content:center;align-items:center;display:flex;width:100%;">
                  <div class="g-recaptcha" data-sitekey="6LcP1RskAAAAANtjMoK9vf0tL37hI_uRIxsQm9-k" data-callback="grecaptcharesponse" data-expired-callback="grecaptchaexpired" data-size="normal"></div>
                  </div>
                <li>
              </ul>
            </div>
            <div class="list">
              <div class="block-footer"><a href="#" class="button button-raised button-fill login-button">Login</a><a href="#" class="item-link list-button login-screen-close" data-login-screen="#my-login-screen">Batal</a></div>
              <p style="font-size:12px;color:grey;text-align:center">Lupa password akun? <a href="" class="reset-password-open">Lupa Password</a></p>
            </div>
          </div>
        </div>
      </div>
    </form> 
<!--start login------------------------------------------------------------------------------->


<!--start aktivasi------------------------------------------------------------------------------->     
    <form class="login-screen" id="my-aktivasi-screen">
      <div class="view">
        <div class="page">
          <div class="page-content login-screen-content">
            <div class="login-screen-title">Aktivasi Akun</div>
            <div class="list">
              <ul>
                <li class="item-content item-input"><b>Akun Relawan</b>
                </li>
                <li class="item-content item-input">
                  <div class="item-inner">
                    <div class="item-title item-label">Email *</div>
                    <div class="item-input-wrap">
                      <input type="email" name="email" placeholder="Alamat email" required validate>
                    </div>
                  </div>
                </li>
                <li class="item-content item-input">
                  <div class="item-inner">
                    <div class="item-title item-label">Password *</div>
                    <div class="item-input-wrap">
                      <input type="password" name="password" placeholder="Password" minlength="10" required validate>
                    </div>
                  </div>
                </li>
                <li class="item-content item-input">
                  <div class="item-inner">
                    <div class="item-title item-label">Konfirm Password *</div>
                    <div class="item-input-wrap">
                      <input type="password" name="konfirmpassword" placeholder="Konfirm Password" minlength="10" required validate>
                    </div>
                  </div>
                </li>
                <li class="item-content item-input"><b>Data Relawan</b>
                </li>
                <li class="item-content item-input">
                  <div class="item-inner">
                    <div class="item-title item-label">Nama Lengkap dan Gelar *</div>
                    <div class="item-input-wrap">
                      <input type="text" name="nama" placeholder="Nama lengkap dan gelar" required validate>
                    </div>
                  </div>
                </li>
                <li class="item-content item-input smart-select smart-select-init" data-open-in="popover">
                  <div class="item-inner">
                    <div class="item-title item-label">Jenis Kelamin *</div>
                    <div class="item-after">-- Jenis Kelamin --</div>
                    <div class="item-input-wrap">
                                  <select name="jeniskelamin" required validate>
                                    <option value="" disabled selected>-- Jenis Kelamin --</option>
                                    <option value="Laki-Laki">Laki-laki</option>
                                    <option value="Perempuan">Perempuan</option>
                                  </select>
                    </div>
                  </div>
                </li>
                <li class="item-content item-input">
                  <div class="item-inner">
                    <div class="item-title item-label">Tanggal Lahir *</div>
                    <div class="item-input-wrap">
                      <input type="text" name="tanggallahir" placeholder="Tanggal Lahir" readonly="readonly" class="calendar-input" required validate>
                    </div>
                  </div>
                </li>
                <li class="item-content item-input">
                  <div class="item-inner">
                    <div class="item-title item-label">Alamat Lengkap Domisili *</div>
                    <div class="item-input-wrap">
                      <input type="text" name="alamatdomisili" placeholder="Alamat Lengkap Domisili" required validate>
                    </div>
                  </div>
                </li>
                <li class="item-content item-input smart-select smart-select-init" data-open-in="popover">
                  <div class="item-inner">
                    <div class="item-title item-label">Profesi *</div>
                    <div class="item-after">-- Profesi --</div>
                    <div class="item-input-wrap">
                                  <select name="profesi" required validate>
                                    <option value="" disabled selected>-- Profesi --</option>
                                    <option value="Dokter Spesialis">Dokter Spesialis</option>
                                    <option value="Dokter Umum">Dokter Umum</option>
                                    <option value="Dokter Gigi">Dokter Gigi</option>
                                    <option value="Dokter Hewan">Dokter Hewan</option>
                                    <option value="Dokter">Dokter</option>
                                    <option value="Bidan">Bidan</option>
                                    <option value="Perawat">Perawat</option>
                                    <option value="Apoteker">Apoteker</option>
                                    <option value="Psikolog">Psikolog</option>
                                    <option value="Ahli Gizi">Ahli Gizi</option>
                                    <option value="Fisioterapis">Fisioterapis</option>
                                    <option value="RadioGrapher">RadioGrapher</option>
                                    <option value="Konselor">Konselor</option>
                                    <option value="Pekerja Sosial">Pekerja Sosial</option>
                                    <option value="Pengusaha">Pengusaha</option>
                                    <option value="Dosen">Dosen</option>
                                    <option value="Guru">Guru</option>
                                    <option value="Media">Media</option>
                                    <option value="Wiraswasta">Wiraswasta</option>
                                    <option value="Rescue">Rescue</option>
                                    <option value="Relawan">Relawan</option>
                                    <option value="Umum">Umum</option>
                                  </select>
                    </div>
                  </div>
                </li>
                <li class="item-content item-input smart-select smart-select-init" data-open-in="popover">
                  <div class="item-inner">
                    <div class="item-title item-label">Golongan Darah *</div>
                    <div class="item-after">-- Golongan Darah --</div>
                    <div class="item-input-wrap">
                                  <select name="golongandarah" required validate>
                                    <option value="" disabled selected>-- Golongan Darah --</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="AB">AB</option>
                                    <option value="O">O</option>
                                    <option value="-">-</option>
                                  </select>
                    </div>
                  </div>
                </li>
                <li class="item-content item-input">
                  <div class="item-inner">
                    <div class="item-title item-label">No HP/Whatsapp *</div>
                    <div class="item-input-wrap">
                      <input type="number" name="nohp" placeholder="No HP/Whatsapp" required validate>
                    </div>
                  </div>
                </li>
                <li class="item-content item-input smart-select smart-select-init" data-open-in="popover">
                  <div class="item-inner">
                    <div class="item-title item-label">Anggota Cabang *</div>
                    <div class="item-after">-- Cabang --</div>
                    <div class="item-input-wrap">
                                  <select name="cabang" required validate>
                                    <option value="" disabled selected>-- Cabang --</option>
                                    <option value="BSMI Jawa Timur">BSMI Jawa Timur</option>
                                    <option value="" disabled>-- ZONA 1 --</option>
                                    <option value="BSMI Kota Surabaya">BSMI Kota Surabaya</option>
                                    <option value="BSMI Kab Sidoarjo">BSMI Kab Sidoarjo</option>
                                    <option value="BSMI Kab Mojokerto">BSMI Kab Mojokerto</option>
                                    <option value="BSMI Kota Mojokerto">BSMI Kota Mojokerto</option>
                                    <option value="BSMI Kab Lamongan">BSMI Kab Lamongan</option>
                                    <option value="BSMI Kab Gresik">BSMI Kab Gresik</option>
                                    <option value="BSMI Kab Tuban">BSMI Kab Tuban</option>
                                    <option value="BSMI Kab Bojonegoro">BSMI Kab Bojonegoro</option>
                                    <option value="BSMI Kota Pasuruan">BSMI Kota Pasuruan</option>
                                    <option value="BSMI Kab Pasuruan">BSMI Kab Pasuruan</option>
                                    <option value="" disabled >-- ZONA 2 --</option>
                                    <option value="BSMI Kab Bangkalan">BSMI Kab Bangkalan</option>
                                    <option value="BSMI Kab Sampang">BSMI Kab Sampang</option>
                                    <option value="BSMI Kab Pamekasan">BSMI Kab Pamekasan</option>
                                    <option value="BSMI Kab Sumenep">BSMI Kab Sumenep</option>
                                    <option value="" disabled >-- ZONA 3 --</option>
                                    <option value="BSMI Kota Probolinggo">BSMI Kota Probolinggo</option>
                                    <option value="BSMI Kab Probolinggo">BSMI Kab Probolinggo</option>
                                    <option value="BSMI Kab Jember">BSMI Kab Jember</option>
                                    <option value="BSMI Kab Lumajang">BSMI Kab Lumajang</option>
                                    <option value="BSMI Kab Bondowoso">BSMI Kab Bondowoso</option>
                                    <option value="BSMI Kab Situbondo">BSMI Kab Situbondo</option>
                                    <option value="BSMI Kab Banyuwangi">BSMI Kab Banyuwangi</option>
                                    <option value="" disabled >-- ZONA 4 --</option>
                                    <option value="BSMI Kab Jombang">BSMI Kab Jombang</option>
                                    <option value="BSMI Kota Malang">BSMI Kota Malang</option>
                                    <option value="BSMI Kab Malang">BSMI Kab Malang</option>
                                    <option value="BSMI Kota Batu">BSMI Kota Batu</option>
                                    <option value="BSMI Kota Kediri">BSMI Kota Kediri</option>
                                    <option value="BSMI Kab Kediri">BSMI Kab Kediri</option>
                                    <option value="BSMI Kota Blitar">BSMI Kota Blitar</option>
                                    <option value="BSMI Kab Blitar">BSMI Kab Blitar</option>
                                    <option value="BSMI Kab Tulungagung">BSMI Kab Tulungagung</option>
                                    <option value="" disabled >-- ZONA 5 --</option>
                                    <option value="BSMI Kota Madiun">BSMI Kota Madiun</option>
                                    <option value="BSMI Kab Madiun">BSMI Kab Madiun</option>
                                    <option value="BSMI Kab Ngawi">BSMI Kab Ngawi</option>
                                    <option value="BSMI Kab Magetan">BSMI Kab Magetan</option>
                                    <option value="BSMI Kab Ponorogo">BSMI Kab Ponorogo</option>
                                    <option value="BSMI Kab Pacitan">BSMI Kab Pacitan</option>
                                    <option value="BSMI Kab Trenggalek">BSMI Kab Trenggalek</option>
                                    <option value="BSMI Kab Nganjuk">BSMI Kab Nganjuk</option>
                                  </select>
                    </div>
                  </div>
                </li>
                <li class="item-content item-input">
                  <div class="item-inner">
                    <div class="item-title item-label">Tahun Bergabung *</div>
                    <div class="item-input-wrap">
                      <input type="number" name="tahun" placeholder="Tahun Bergabung" required validate>
                    </div>
                  </div>
                </li>
                <li class="item-content item-input">
                  <div style="padding:20px 20px;justify-content:center;align-items:center;display:flex;width:100%;">
                    <p style="text-align:center; border:1px solid gray;padding:10px 10px;color:gray;">Anda tidak dapat melakukan perubahan detail setelah aktivasi. </p>
                  </div>
                <li>
                <li class="item-content item-input">
                  <div class="item-inner">
                    <div class="item-input-wrap">
                      <center><input type="checkbox" name="paraf" value="yes" placeholder="" required validate>Setuju dengan MyBSMI <a href="#" data-url="privacy.html" class="persetujuanaktivasi">PrivacyPolicy</a> dan <a href="#" data-url="tnc.html" class="persetujuanaktivasi">Terms&Conditions</a> </center> 
                    </div>
                  </div>
                </li>
                <li class="item-content item-input">
                  <div style="padding:20px 20px;justify-content:center;align-items:center;display:flex;width:100%;">
                  <div id="mybsmi-grecaptchaaktivasi" class="g-recaptcha1" data-sitekey="6LcP1RskAAAAANtjMoK9vf0tL37hI_uRIxsQm9-k" data-callback="grecaptcharesponse" data-expired-callback="grecaptchaexpired"></div>
                  </div>
                <li>
              </ul>
            </div>
            <div class="list">
              <div class="block-footer"><a href="#" class="button button-raised button-fill register-button">AKTIVASI</a><a href="#" class="item-link list-button close-login-button login-screen-close" data-login-screen="#my-aktivasi-screen">Batal</a></div>
            </div>
          </div>
        </div>
      </div>
    </form>          
<!--end register------------------------------------------------------------------------------->     

          
<!--start overlay------------------------------------------------------------------------------->          
<div id="overlay-welcome" style="background: rgba(0, 0, 0, 0.8);position: fixed;z-index: 10000;align-items: center;justify-content: center;display: flex;flex-direction:column;bottom: 0;left: 0;right: 0;top: 0;    background-image: url();background-size: cover;background-position: center top;">
  <div style="background:#fff;display: flex;flex-direction:column;margin: auto;align-items: center;justify-content: center;padding:20px 20px;">
    <img src="https://1.bp.blogspot.com/-I9V1NyLtG68/XmJRZ_RhTJI/AAAAAAAADgI/wJiuL0Wnjvc2jyoV8AMRsIp1YvSQs1QXwCLcBGAsYHQ/s1600/Logo%2BBSMI%2B%2528vector%2529.png" style="width:200px;height:300px;object-fit: contain;background-image:none;">
    <p style="font-size:16px;font-weight:bold;text-align:center;width:300px;margin-top:15px;margin-bottom:2px;">MyBSMI</p>
    <p style="font-size:14px;font-weight:normal;text-align:center;width:300px;margin-top:0px;margin-bottom:15px;">Selamat Datang</br>Relawan BSMI Jawa Timur</p>
    <button class="button button-fill login-screen-open" data-login-screen="#my-login-screen" style="width:100px;">LOGIN</button>
    <!--<p style="font-size:12px;color:grey;tex-align:center">Belum punya akun? <a href="" class="login-screen-open" data-login-screen="#my-aktivasi-screen">Aktivasi</a></p>-->
    <p style="font-size:12px;color:grey;tex-align:center">Belum punya akun? <a href="" class="mybsmi-aktivasiscreen">Aktivasi</a></p>
  </div>
  <div><p><a href="#" class="mybsmi-install display-none" target="_blank">Install MyBSMI App</a><a href="#" class="mybsmi-bukaapp display-none" target="_blank">Buka MyBSMI App</a></p></div>
</div>
<!--end overlay------------------------------------------------------------------------------->


    </div>
  </div>




  <script src="https://unpkg.com/framework7@7.1.2/framework7-bundle.min.js"></script>
  <script src="https://unpkg.com/chart.js"></script>
<!--start script------------------------------------------------------------------------------->
<script>
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////getparams/////////////////////////////////////////////////////////////////////////////
var getParams = function (url) {
	var params = {};
	var parser = document.createElement('a');
	parser.href = url;
	var query = parser.search.substring(1);
	var vars = query.split('&');
	for (var i = 0; i < vars.length; i++) {
		var pair = vars[i].split('=');
		params[pair[0]] = decodeURIComponent(pair[1]);
	}
	return params;
};
var params = getParams(window.location.href);
//////////////////////////////////////////////////////////////////////////////

var kodecabang = [
    ['BSMI Jawa Timur', '3500'],
    ['BSMI Kota Surabaya', '3578'],
    ['BSMI Kab Sidoarjo', '3515'],
    ['BSMI Kab Mojokerto', '3516'],
    ['BSMI Kota Mojokerto', '3576'],
    ['BSMI Kab Lamongan', '3524'],
    ['BSMI Kab Gresik', '3525'],
    ['BSMI Kab Tuban', '3523'],
    ['BSMI Kab Bojonegoro', '3522'],
    ['BSMI Kota Pasuruan', '3575'],
    ['BSMI Kab Pasuruan', '3514'],
    ['BSMI Kab Bangkalan', '3526'],
    ['BSMI Kab Sampang', '3527'],
    ['BSMI Kab Pamekasan', '3528'],
    ['BSMI Kab Sumenep', '3529'],
    ['BSMI Kota Probolinggo', '3574'],
    ['BSMI Kab Probolinggo', '3513'],
    ['BSMI Kab Jember', '3509'],
    ['BSMI Kab Lumajang', '3508'],
    ['BSMI Kab Bondowoso', '3511'],
    ['BSMI Kab Situbondo', '3512'],
    ['BSMI Kab Banyuwangi', '3510'],
    ['BSMI Kab Jombang', '3517'],
    ['BSMI Kota Malang', '3573'],
    ['BSMI Kab Malang', '3507'],
    ['BSMI Kota Batu', '3579'],
    ['BSMI Kota Kediri', '3571'],
    ['BSMI Kab Kediri', '3506'],
    ['BSMI Kota Blitar', '3572'],
    ['BSMI Kab Blitar', '3505'],
    ['BSMI Kab Tulungagung', '3504'],
    ['BSMI Kota Madiun', '3577'],
    ['BSMI Kab Madiun', '3519'],
    ['BSMI Kab Ngawi', '3521'],
    ['BSMI Kab Magetan', '3520'],
    ['BSMI Kab Ponorogo', '3502'],
    ['BSMI Kab Pacitan', '3501'],
    ['BSMI Kab Trenggalek', '3503'],
    ['BSMI Kab Nganjuk', '3518']
];

var $$ = Dom7;

var mybsmiaktivasi = 'd426d702f89bac9fb66b22ede9593b62a447bf4154dfac317a72fcf4f168172a';
var grecaptcharesponsedata = '';
var isLocal = false;

if ((window.location.href.indexOf("localhost") > -1)||(window.location.href.indexOf("127.0.0.1") > -1)) 
{
console.log('local development');
isLocal = true;
var access_token = params.access_token;
var apiuserurl = "https://script.google.com/macros/s/AKfycbwWFxUmhmfem1mHJT7HDqJoVFNkCmUkInvOOx2K1KZy/dev?access_token="+access_token;
var apidataurl = "https://script.google.com/macros/s/AKfycbxXCV5_Bj1-IqUtezfR_MPLrc-YRGq0pSWVQwPZ5K0/dev?access_token="+access_token;
}
else
{
var apiuserurl = "https://script.google.com/macros/s/AKfycbys-GEdilEu0nqdjDRUlEExkamYVIRsplNMEnLl2WiQQy3DxZoikpts7bnLotnT5IcwzQ/exec";
var apidataurl = "https://script.google.com/macros/s/AKfycbyyPrApY4R8xv-_m8LUz9XHhkdYeTPMovm8MkBXgTXlojx31nHz9GVdGa4Ikw8cELMN/exec";
}

if (params.mybsmi !== undefined )
{
  let mybsmi = params.mybsmi;
  mybsmi = mybsmi.replace('web+mybsmi://','');
  mybsmi = mybsmi.replace('javascript:','');
  mybsmi = safe(mybsmi);
  if ((mybsmi.startsWith("http://localhost:8080"))||(mybsmi.startsWith("https://mybsmi.bsmijatim.org")))
  {
    window.location.href = mybsmi;
  }
}

var app = new Framework7({
el: '#app',
theme: 'aurora',
name: 'MyBSMI',
id: 'mybsmi.bsmijatim.org',
view: {
  browserHistory: true,
  browserHistorySeparator: '#page',
},
on: {
  init() {
    fappready();
  },
},
routes: [
  {
    path: '/',
    url: '/',
    on: {
      pageAfterIn: function test (e, page) {
        //console.log(typeof(dashboarddata));
        if (typeof dashboarddata !== 'undefined'){getdefaultdatarun(dashboarddata);}
        if (window.deferredPrompt) fmybsminstallclick();
        if (window.mybsmiinstalled) fmybsmibukaapp();
        frefresh();
      },
    },
  },
  {
    path: '/profilku/',
    url: 'profilku.html',
    on: {
      pageAfterIn: function test (e, page) {
        fpageprofilku();
      },
    },
    beforeEnter: function ({ resolve, reject }) {          
          fperiksauserdata({ resolve, reject })
    },
  },
  {
    path: '/ekta/',
    url: 'ekta.html',
    on: {
      pageAfterIn: function test (e, page) {
        fpageekta();
      },
    },
    beforeEnter: function ({ resolve, reject }) {
        fperiksauserstatus({ resolve, reject })
    },
  },
  {
    path: '/aktivitas/',
    url: 'aktivitas.html',
    on: {
      pageAfterIn: function test (e, page) {
        fpageaktivitas();
      },
    },
    beforeEnter: function ({ resolve, reject }) {          
        fperiksauserdata({ resolve, reject })
    },
  },
  {
    path: '/bukusaku/',
    url: 'bukusaku.html',
    on: {
      pageAfterIn: function test (e, page) {
        fpagebukusaku();
      },
    },
    beforeEnter: function ({ resolve, reject }) {          
        fperiksauserdata({ resolve, reject })
    },
  },
  {
    path: '/twibbon/:aktivitasid',
    url: 'twibbon.html',
    on: {
      pageAfterIn: function test (e, page) {
        fpagetwibbon(page.route.params.aktivitasid);
      },
    },
    beforeEnter: function ({ resolve, reject }) {
      fperiksauserdata({ resolve, reject })
    },
  },
  {
    path: '/cabang/:cabangid',
    url: 'cabang.html',
    on: {
      pageAfterIn: function test (e, page) {
        fpagecabang(true,page.route.params.cabangid);
      },
    },
    beforeEnter: function ({ resolve, reject }) {
      fperiksauserdata({ resolve, reject })
    },
  },
  {
    path: '/relawan/:relawanid',
    url: 'relawan.html',
    on: {
      pageAfterIn: function test (e, page) {
        fpagerelawan(page.route.params.relawanid);
      },
    },
    beforeEnter: function ({ resolve, reject }) {
      fperiksauserdata({ resolve, reject })
    },
  },
  {
    path: '/riwayat/',
    url: 'riwayat.html',
    on: {
      pageAfterIn: function test (e, page) {
        fpageriwayat();
      },
    },
    beforeEnter: function ({ resolve, reject }) {
        fperiksauserdata({ resolve, reject })
    },
  },
  {
    path: '/pesan/',
    url: 'pesan.html',
    on: {
      pageAfterIn: function test (e, page) {
        fpagepesan(e, page);        
      },
    },
    beforeEnter: function ({ resolve, reject }) {
      function fperiksakesiapan({ resolve, reject })
      {
          if (typeof dashboarddata === 'undefined' || dashboarddata === null) {
            // variable is undefined or null
            setTimeout(function(){ fperiksakesiapan({ resolve, reject }); }, 1000);
            return;
          }
        resolve();
      }
      fperiksakesiapan({ resolve, reject })
    },
  },
  {
    path: '/bacapesan/:pesanId',
    url: 'bacapesan.html',
    on: {
      pageAfterIn: function test (e, page) {
        fpagebacapesan(page.route.params.pesanId);
        //console.log(page.route.params.pesanId)
      },
    },
    beforeEnter: function ({ resolve, reject }) {
      function fperiksakesiapan({ resolve, reject })
      {
          if (typeof dashboarddata === 'undefined' || dashboarddata === null) {
            // variable is undefined or null
            setTimeout(function(){ fperiksakesiapan({ resolve, reject }); }, 1000);
            return;
          }
        resolve();
      }
      fperiksakesiapan({ resolve, reject })
    },
  },
  {
    path: '/verifikator/',
    url: 'verifikator.html',
    on: {
      pageAfterIn: function test (e, page) {
        fpageverifikator();
      },
    },
    beforeEnter: function ({ resolve, reject }) {
      function fperiksakesiapan({ resolve, reject })
      {
          if (typeof dashboarddata === 'undefined' || dashboarddata === null) {
            // variable is undefined or null
            setTimeout(function(){ fperiksakesiapan({ resolve, reject }); }, 1000);
            return;
          }
            let data = JSON.parse(dashboarddata.user.usermydata)
            if (data.verifikator)
            {
                resolve();
            }
            else
            {
                app.dialog.alert('Tidak punya izin', 'Status')
                reject();
            }
      }
      fperiksakesiapan({ resolve, reject })
    },
  },
  {
    path: '/admin/',
    url: 'admin.html',
    on: {
      pageAfterIn: function test (e, page) {
        fpageadmin();
      },
    },
    beforeEnter: function ({ resolve, reject }) {
      function fperiksakesiapan({ resolve, reject })
      {
          if (typeof dashboarddata === 'undefined' || dashboarddata === null) {
            // variable is undefined or null
            setTimeout(function(){ fperiksakesiapan({ resolve, reject }); }, 1000);
            return;
          }
            let data = JSON.parse(dashboarddata.user.usermydata)
            if (data.admin)
            {
                resolve();
            }
            else
            {
                app.dialog.alert('Tidak punya izin', 'Status')
                reject();
            }
      }
      fperiksakesiapan({ resolve, reject })
    },
  },
  {
    path: '(.*)',
    url: '404.html',
  },
],
});

function fperiksauserdata({ resolve, reject })
{
    if (typeof dashboarddata === 'undefined' || dashboarddata === null) {
      // variable is undefined or null
      setTimeout(function(){ fperiksauserdata({ resolve, reject }); }, 1000);
      return;
    }

      if (dashboarddata.user.userphoto !== '')
      {
        resolve();
      }
      else
      {
        flengkapidata();
        reject();
      }

}

function fperiksauserstatus({ resolve, reject })
{
    if (typeof dashboarddata === 'undefined' || dashboarddata === null) {
      // variable is undefined or null
      setTimeout(function(){ fperiksauserstatus({ resolve, reject }); }, 1000);
      return;
    }
    
       if (dashboarddata.user.userstatus === 'Terverifikasi')
       {
          fperiksauserdata({ resolve, reject })
       }
       else if (dashboarddata.user.userstatus === 'Terbatas')
       {

          if (dashboarddata.user.userphoto !== '')
          {

            let data = JSON.parse(dashboarddata.user.usermydata)
            if (data.verifikasiidentitas)
            {
              app.dialog.alert('Proses verifikasi', 'Status')
              reject();
            }
            else
            {
              fverifikasidata();
              reject();
            }

          }
          else
          {
            flengkapidata();
            reject();
          }

       }
       else if (dashboarddata.user.userstatus === 'Tertolak')
       {
          app.dialog.alert('Verifikasi gagal hubungi admin', 'Status')
          reject();
       }
       else
       {
          reject();
       }
}

//////////on app ready////////////////////////////////////////////////////
function fappready()
{
  console.log('app ready');
  fonesignal();
  
}

//////////on dom ready////////////////////////////////////////////////////
window.addEventListener('DOMContentLoaded', () => {
  console.log('dom ready');
});

function frefresh()
{
  $$('.mybsmi-refresh').on('click', function () {
    location.reload();
  });
}

function fonesignal()
{
    if (typeof dashboarddata === 'undefined' || dashboarddata === null) {
      // variable is undefined or null
      setTimeout(function(){ fonesignal(); }, 1000);
      return;
    }
    
    if (!isLocal)
    {
      //try {

            function onManageWebPushSubscriptionButtonClicked(event) {
                getSubscriptionState().then(function(state) {
                    if (state.isPushEnabled) {
                        /* Subscribed, opt them out */
                        OneSignal.setSubscription(false);
                    } else {
                        if (state.isOptedOut) {
                            /* Opted out, opt them back in */
                            OneSignal.setSubscription(true);
                        } else {
                            /* Unsubscribed, subscribe them */
                            OneSignal.registerForPushNotifications();
                        }
                    }
                });
                event.preventDefault();
            }

            function updateMangeWebPushSubscriptionButton(buttonSelector) {
                var hideWhenSubscribed = false;
                var subscribeText = "Subscribe to Notifications";
                var unsubscribeText = "Unsubscribe from Notifications";

                getSubscriptionState().then(function(state) {
                    var buttonText = !state.isPushEnabled || state.isOptedOut ? subscribeText : unsubscribeText;

                    var element = document.querySelector(buttonSelector);
                    if (element === null) {
                        return;
                    }

                    element.removeEventListener('click', onManageWebPushSubscriptionButtonClicked);
                    element.addEventListener('click', onManageWebPushSubscriptionButtonClicked);
                    element.textContent = buttonText;

                    if (hideWhenSubscribed && state.isPushEnabled) {
                        element.style.display = "none";
                    } else {
                        element.style.display = "";
                    }
                });
            }

            function getSubscriptionState() {
                return Promise.all([
                  OneSignal.isPushNotificationsEnabled(),
                  OneSignal.isOptedOut()
                ]).then(function(result) {
                    var isPushEnabled = result[0];
                    var isOptedOut = result[1];

                    return {
                        isPushEnabled: isPushEnabled,
                        isOptedOut: isOptedOut
                    };
                });
            }
            
            window.OneSignal = window.OneSignal || [];

            OneSignal.push(function() {
                  // If we're on an unsupported browser, do nothing
                  if (!OneSignal.isPushNotificationsSupported()) {
                      return;
                  }

                  OneSignal.SERVICE_WORKER_PARAM = { scope: '/push/onesignal/' };
                  OneSignal.SERVICE_WORKER_PATH = 'push/onesignal/OneSignalSDKWorker.js'
                  OneSignal.SERVICE_WORKER_UPDATER_PATH = 'push/onesignal/OneSignalSDKWorker.js'
            
                  OneSignal.init({
                    appId: "142b9d52-507c-4326-bc6e-d234d208f2cd",
                    safari_web_id: "web.onesignal.auto.194684e9-1eab-45d0-91dc-36dcc25bd22e",
                    autoResubscribe: true,
                    notifyButton: {
                      enable: false,
                    },
                    promptOptions: {
                      actionMessage: 'MyBSMI ingin menampilkan notifikasi',
                      acceptButton: 'Lanjutkan',
                      cancelButton: 'Nanti Saja',
                    },
                    welcomeNotification: {
                      disable: true,
                    },
                    /* Your other init settings ... */
                    notificationClickHandlerMatch: 'origin', /* See above documentation: 'origin' relaxes tab matching requirements, 'exact' is default */
                    notificationClickHandlerAction: 'focus', /* See above documentation: 'focus' does not navigate the targeted tab, 'navigate' is default */
                    /* ... */
                  });          
                  OneSignal.setDefaultTitle("MyBSMI");          
                  OneSignal.on('permissionPromptDisplay', function () {
                    console.log("The prompt displayed");
                  });
                  OneSignal.isPushNotificationsEnabled(function(isEnabled) {
                    if (isEnabled)
                      console.log("Push notifications are enabled!");
                    else
                      console.log("Push notifications are not enabled yet.");
                      if (mybsmigetNotificationPermission === 'granted')
                      {
                        //OneSignal.setSubscription(true);
                      }    
                  });
                  
                  //updateMangeWebPushSubscriptionButton('#my-notification-button');          
                  // Occurs when the user's subscription changes to a new value.
                  OneSignal.on('subscriptionChange', function (isSubscribed) {
                    console.log("The user's subscription state is now:", isSubscribed);
                    //updateMangeWebPushSubscriptionButton('#my-notification-button');
                    fupdateusernotifikasi(isSubscribed);
                  });
                  
                  OneSignal.on('notificationPermissionChange', function(permissionChange) {
                    var currentPermission = permissionChange.to;
                    console.log('New permission state:', currentPermission);
                    $$('#mybsmi-promptoverlay').remove();
                    if (currentPermission === 'granted')
                    {
                      fupdateusernotifikasi(true);
                    }
                    else if (currentPermission === 'denied')
                    {
                    }
                    else if (currentPermission === 'default')
                    {
                    }
                  });
                  OneSignal.getUserId(function(userId) {
                    console.log("OneSignal User ID:", userId);
                    // (Output) OneSignal User ID: 270a35cd-4dda-4b3f-b04e-41d7463a2316    
                  });
                  OneSignal.on('notificationDisplay', function(event) {
                    console.warn('OneSignal notification displayed:', event);
                    window.mybsminotificationDisplay = true;
                    let url = event.url;
                    if (window.mybsmiaddListenerForNotificationOpened) 
                    {              
                      window.location.assign(url);
                      location.reload();
                    }
                  });
                  OneSignal.on('notificationDismiss', function(event) {
                    console.warn('OneSignal notification dismissed:', event);
                  });
                  OneSignal.setExternalUserId(dashboarddata.user.useruid);
                  OneSignal.getExternalUserId().then(function(externalUserId){
                    console.log("externalUserId: ", externalUserId);
                  });
                  OneSignal.on('popoverShown', function() {
                    console.log('Slide Prompt Shown');
                  });
                  OneSignal.on('popoverAllowClick', function() {
                    console.log('Slide Prompt popoverAllowClick');
                    $$('.mybsmi-promptinfo').removeClass('display-none')
                  });
                  OneSignal.on('popoverCancelClick', function() {
                    console.log('Slide Prompt popoverCancelClick');
                    $$('#mybsmi-promptoverlay').remove();
                  });
                  OneSignal.on('popoverClosed', function() {
                    console.log('Slide Prompt popoverClosed');
                  });
            });
            OneSignal.push(["getNotificationPermission", function(permission) {
                console.log("Site Notification Permission:", permission);
                // (Output) Site Notification Permission: default
                window.mybsmigetNotificationPermission = permission;
            }]);

            const onNotificationClicked = function (data) 
            {
                console.log("Received NotificationOpened:");
                console.log(data);
                if ((app.views.current.history.length !== 2) || (app.views.current.router.currentPageEl.baseURI !== data.url))
                {
                 window.mybsmiaddListenerForNotificationOpened = true;
                }
                else
                {
                  var toastBottom = app.toast.create({ text: data.content, closeTimeout: 5000,position: 'center', });toastBottom.open();
                }
                console.log(app.views.current.history.length);
                let url = data.url;
                if (window.mybsminotificationDisplay) 
                {              
                  window.location.assign(url);
                  location.reload();
                }
            }                
            const handler = function (data) {
              // call your primary handler
              onNotificationClicked(data);

              // add another handler right away
              OneSignal.addListenerForNotificationOpened(handler);
            };
            OneSignal.push(["addListenerForNotificationOpened", handler]);
      //} catch(err){}
    }    
}

function fupdateusernotifikasi(data)
{
      let mypreloader = app.dialog.preloader();
      app.request({
        url: apidataurl,
        method: 'POST',
        cache: false,
        data : { token:mybsmiusertoken, command: 'updateusernotifikasi', data:data}, 
        success: function (data, status, xhr)
          {
            mypreloader.close();
            var status = JSON.parse(data).status;
            var content = JSON.parse(data).data;
            if (status == "success")
            {
              //console.log(content);
            }
            else if (status == "failed")
            {
              //console.log("failed");
              app.dialog.alert(content,'Terjadi Kesalahan');
            }
            else
            {
              //console.log("failed");
              app.dialog.alert(content,'Terjadi Kesalahan');
            }
          },
        error: function (xhr, status, message)
          {
            //console.log(message);
            mypreloader.close();
            app.dialog.alert("Server sedang sibuk",'Terjadi Kesalahan');
          },
      })
}

function fonesignalprompt(judul = 'Terima Kasih',msg = 'Beritahu jika ada hal penting')
{
  console.log('prompt');
  
  OneSignal.push(["getNotificationPermission", function(permission) {
      console.log("Site Notification Permission:", permission);
      // (Output) Site Notification Permission: default
      fonesignalpromptrun(judul,msg,permission)
  }]);
}

function fonesignalpromptrun(judul,msg,permission)
{
  var dialog = app.dialog.create({
    content:''////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
      +'<div style="width:100%;">'
      +'  <div style="display:flex;flex-direction:column;align-items:center;justify-content: center;">'
      +'      <img id="img" src="" style="width:150px;height:150px;margin: 10px 10px;object-fit: cover;">'
      +'      <p style="font-weight:bold;text-align:center;" class="mybsmi-judulprompt">'+judul+'</p>'
      +'      <div class="data-table"></div>'
+'                <div class="list media-list no-margin-top display-none mybsmi-promptlist"><ul><li>'
+'                  <label class="item-checkbox item-content">'
+'                    <input type="checkbox" name="demo-media-checkbox" id="mybsmi-promptcheck" value="1" />'
+'                    <i class="icon icon-checkbox"></i>'
+'                    <div class="item-inner">'
+'                      <div class="item-title-row">'
+'                        <div class="item-title"></div>'
+'                        <div class="item-after"></div>'
+'                      </div>'
+'                      <div class="item-subtitle">Kirim Pemberitahuan</div>'
+'                      <div class="item-text mybsmi-msgprompt" style="margin-bottom:10px;overflow:auto;">'+msg+'</div>'
+'                    </div>'
+'                  </label>'
+'                </li></ul></div>'
      +'  </div>'
      +'</div>',//////////////////////////////////////////////////////////////////////////////////////////////////
    closeByBackdropClick: false,
    destroyOnClose: true,
    verticalButtons: false,
    on: {
      opened: function (dialog, e) {
        //console.log('Dialog opened')
        let src = "icon512.png";
        $$('#img').attr('src',src);
        $$('#mybsmi-promptcheck').on('click', function () {
          let cek = $$('#mybsmi-promptcheck').attr('disabled')
          if (!cek)
          {
            dialog.close();
            console.log('chek');
            $$('#mybsmi-promptcheck').attr('disabled','true');            
            const para = document.createElement("div");
            para.id = 'mybsmi-promptoverlay';
            para.innerHTML = '<div style="background: rgba(0, 0, 0, 0.8);position: fixed;z-index: 1000000000000000;align-items: center;justify-content: center;display: flex;bottom: 0;left: 0;right: 0;top: 0;"><p class="text-align-center padding text-color-white mybsmi-promptinfo display-none">Klik Izinkan (Allow)</p></div>';         
            document.body.appendChild(para);            
            $$('.mybsmi-promptinfo').on('click', function () {
              $$('#mybsmi-promptoverlay').remove();
            });
            //OneSignal.showNativePrompt();
            OneSignal.showSlidedownPrompt({force: true});            
          }
        });
        if (permission === 'default')
        {
            $$('.mybsmi-promptlist').removeClass('display-none');
        }        
      }
    },
    buttons: [
      {
        text: 'OK',
        close:true,
        color: 'gray',
        onClick: function(dialog, e)
          {

          }
      },
    ]
  });
  dialog.open();
}


//////onesignal////////////////////////////////////////////////////////////





/////////install//////////////////////////////////////////////////
//https://web.dev/codelab-make-installable/
window.addEventListener('beforeinstallprompt', (event) => {
  // Prevent the mini-infobar from appearing on mobile.
  event.preventDefault();
  console.log('', 'beforeinstallprompt', event);
  // Stash the event so it can be triggered later.
  window.deferredPrompt = event;
  // Remove the 'hidden' class from the install button container.
  //$$('.mybsmi-install').removeClass('display-none');
  fmybsminstallclick();
});

function fmybsminstallclick()
{
  $$('.mybsmi-install').removeClass('display-none');
  $$('.mybsmi-install').on('click', async function () {
    console.log('', 'butInstall-clicked');
    const promptEvent = window.deferredPrompt;
    if (!promptEvent) {
      // The deferred prompt isn't available.
      return;
    }
    // Show the install prompt.
    promptEvent.prompt();
    // Log the result
    const result = await promptEvent.userChoice;
    console.log('', 'userChoice', result);
    // Reset the deferred prompt variable, since
    // prompt() can only be called once.
    window.deferredPrompt = null;
    // Act on the user's choice
    if (result === 'accepted') {
      console.log('User accepted the install prompt.');
    } else if (result === 'dismissed') {
      console.log('User dismissed the install prompt');
    }
    // Hide the install button.
    $$('.mybsmi-install').addClass('display-none');
  });
  $$('.mybsmi-bukaapp').addClass('display-none');
  if (localStorage.getItem("mybsmiinstalled") !== null)
  {
    localStorage.removeItem("mybsmiinstalled");
  }
}

function fmybsmibukaapp()
{
  const os = detectOS();
  const browserName = getBrowserName();
  const display = getPWADisplayMode();
  if (display === 'browser')
  {
      console.log('display :'+display);
      if (os === 'Android')
      {
        console.log('os :'+os);
        if (browserName === 'Chrome')
        {
          $$('.mybsmi-bukaapp').removeClass('display-none');
          $$('.mybsmi-bukaapp').on('click', function () {
            window.open(window.location.href, "_blank");
          });
        }
        else if (browserName === 'Samsung')
        {
          $$('#overlay-welcome .mybsmi-bukaapp').text('MyBSMI App Tersedia');
          $$('#overlay-welcome .mybsmi-bukaapp').removeClass('display-none');
          $$('#overlay-welcome .mybsmi-bukaapp').on('click', function () {
            //window.open(window.location.href, "_blank");
          });
        }
      }
      else if (os === 'Windows')
      {
        console.log('os :'+os);
        if (browserName === 'Edge')
        {
          console.log('browserName :'+browserName);
          $$('.mybsmi-bukaapp').removeClass('display-none');
          $$('.mybsmi-bukaapp').on('click', function () {
          let url = 'web+mybsmi://'+window.location.href;
            window.open(url, "_blank");
          });      
        }
      }
  }
}

window.addEventListener('appinstalled', (event) => {
  console.log('', 'appinstalled', event);
  // Clear the deferredPrompt so it can be garbage collected
  window.deferredPrompt = null;
  $$('.mybsmi-install').addClass('display-none');
  window.mybsmiinstalled = true;
  localStorage.setItem("mybsmiinstalled",true)
  let timeout = setTimeout(fmybsmibukaapp, 20000);
});

function getPWADisplayMode() {
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
  if (document.referrer.startsWith('android-app://')) {
    return 'twa';
  } else if (navigator.standalone || isStandalone) {
    return 'standalone';
  }
  return 'browser';
}

//console.log(getPWADisplayMode());

window.matchMedia('(display-mode: standalone)').addEventListener('change', (evt) => {
  let displayMode = 'browser';
  if (evt.matches) {
    displayMode = 'standalone';
  }
  // Log display mode change to analytics
  console.log('DISPLAY_MODE_CHANGED', displayMode);
});

async function tesinstall()
{
  if ('getInstalledRelatedApps' in navigator) {
      const relatedApps = await navigator.getInstalledRelatedApps();
      //console.log('instaled: '+relatedApps.length > 0);
      if (relatedApps.length > 0) {
        //window.open(window.location.href, "_blank");
        console.log('installed');
        if (getPWADisplayMode() === 'browser')
        {
          //window.open(window.location.href, "_blank");
          //const anchor = document.createElement("a");
          //anchor.setAttribute('href', window.location.href);
          //anchor.setAttribute('target', '_blank');
          //anchor.click();
          //openapp();
          //window.location.href = 'https://mybsmi.bsmijatim.org';
          window.mybsmiinstalled = true;
          fmybsmibukaapp();
          
        }
      }else{
        console.log('not installed');
        const os = detectOS();
        const browserName = getBrowserName();
        if ((os === 'Windows')&&(browserName === 'Edge'))
        {
          if (localStorage.getItem("mybsmiinstalled") !== null)
          {
            let isInstalled = localStorage.getItem("mybsmiinstalled");
            if (isInstalled)
            {
              window.mybsmiinstalled = true;
              fmybsmibukaapp();
            }
          }
        }
      }
      relatedApps.forEach((app) => {
        console.log(app.id, app.platform, app.url);
      });
  } else {
    console.log('getInstalledRelatedApps not supported');
  }
}

if (!isSecureContext) {  
  location.protocol = 'https:';
}

(async() => {
  window.addEventListener('load', () => {
    navigator.registerProtocolHandler('web+mybsmi', '/?mybsmi=%s');
  });
  //tesinstall();
})();

window.addEventListener('DOMContentLoaded', () => {
  // replace standalone with your display used in manifest
  window.matchMedia('(display-mode: standalone)')
      .addListener(event => {
          if (event.matches) {
             // From browser to standalone
             console.log('From browser to standalone');
          } else {
             // From standalone to browser
             console.log('From standalone to browser');
          }
      });
  tesinstall();
  console.log(isStandalone());
});

function isStandalone() {
  // For iOS
  if(window.navigator.standalone) return true

  // For Android
  if(window.matchMedia('(display-mode: standalone)').matches) return true

  // If neither is true, it's not installed
  return false
}


function openapp()
{
  var dialog = app.dialog.create({
    content:''////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
      +'<div style="width:100%;">'
      +'  <div style="display:flex;flex-direction:column;align-items:center;justify-content: center;">'
      +'      <img id="img" src="" style="width:150px;height:150px;margin: 10px 10px;object-fit: cover;">'
      +'      <p style="font-weight:normal;">MyBSMI App Tersedia</p>'
      +'      <div class="data-table"></div>'
      +'  </div>'
      +'</div>',//////////////////////////////////////////////////////////////////////////////////////////////////
    closeByBackdropClick: false,
    destroyOnClose: true,
    verticalButtons: false,
    on: {
      opened: function () {
        //console.log('Dialog opened')
        let src = "icon512.png";
        $$('#img').attr('src',src);
      }
    },
    buttons: [
      {
        text: 'Nanti Saja',
        close:true,
        color: 'gray',
        onClick: function(dialog, e)
          {

          }
      },
      {
        text: 'Buka App',
        close:true,
        color: 'red',
        onClick: function(dialog, e)
          {
            window.open(window.location.href, "_blank");
          }
      },
    ]
  });
  dialog.open();
}

const isInStandaloneMode = () =>
      (window.matchMedia('(display-mode: standalone)').matches) || (window.navigator.standalone) || document.referrer.includes('android-app://');

 if (isInStandaloneMode()) {
    console.log("webapp is installed")
}

function detectOS() {
    const platform = navigator.platform.toLowerCase(),
        iosPlatforms = ['iphone', 'ipad', 'ipod', 'ipod touch'];

    if (platform.includes('mac')) return 'MacOS';
    if (iosPlatforms.includes(platform)) return 'iOS';
    if (platform.includes('win')) return 'Windows';
    if (/android/.test(navigator.userAgent.toLowerCase())) return 'Android';
    if (/linux/.test(platform)) return 'Linux';

    return 'unknown';
}

const getBrowserName = () => {
  let browserInfo = navigator.userAgent;
  let browser;
  if (browserInfo.includes('Opera') || browserInfo.includes('Opr')) {
    browser = 'Opera';
  } else if (browserInfo.includes('Edg')) {
    browser = 'Edge';
  } else if (browserInfo.includes('Samsung')) {
    browser = 'Samsung'
  } else if (browserInfo.includes('Chrome')) {
    browser = 'Chrome';
  } else if (browserInfo.includes('Safari')) {
    browser = 'Safari';
  } else if (browserInfo.includes('Firefox')) {
    browser = 'Firefox'
  } else {
    browser = 'unknown'
  }
    return browser;
}
/////////install//////////////////////////////////////////////////





app.on('pageInit', function (page) {
  //console.log('Page is now pageInit');
  let mypreloader = app.dialog.preloader();
  setTimeout(function () {mypreloader.close();}, 1000);
  //console.log(page.router.currentRoute);
});

app.on('pageAfterIn', function (page) {
  //console.log('Page is pageAfterIn');
  //mypreloader.close();

let myprofile = ''
+'      <div class="right">'
+'        <a class="link popover-open" data-popover=".profile-popover">'
+'          <span class="margin-right-half"></span>'
+'          <img src="avatar.png" class="avatar mybsmi-avatar"><span class="badge color-blue mybsmi-avatar-badge" style="left:-8px;bottom:-5px;display:none;"><i class="icon f7-icons" style="font-size:12px;">checkmark_seal</i></span>'
+'        </a>'
+'      </div>'

  //$$('.navbar-inner .title').append(myprofile);
});

//console.log(app.views.current);
//console.log(app.views.current.router.initialUrl);
var currentrouturl = app.views.current.router.initialUrl;
var currentmybsmimenu = $$('a[href="'+currentrouturl+'"]');
currentmybsmimenu.addClass('active-link');


// Fix col sizes
function fixCols() {
setTimeout(function() {
$$('.events-col').css('height', $$('.charts-col').height() + 'px');
});
}
fixCols();
$$(window).on('resize', fixCols);



////////////////////////////////////////////////////
$$('.mybsmi-menu').on('click', function (e) {
  $$('.mybsmi-menu').removeClass('active-link');
  $$(this).addClass('active-link');
});
/////////////////////////////////////////////////////





//aktivasi kalender///////////////////////////
var calendar = app.calendar.create({
inputEl: '.calendar-input',
dateFormat: 'd-m-yyyy',
openIn: 'popover'
});
//aktivasi kalender///////////////////////////





//form-aktivasi/////////////////////////////
$$('.mybsmi-aktivasiscreen').on('click', function () {
  app.dialog.prompt("PIN", "MyBSMI", async function (pin) {
    
    const buf = await crypto.subtle.digest("SHA-256", new TextEncoder("utf-8").encode(pin));
    var pinhash = Array.prototype.map.call(new Uint8Array(buf), x=>(('00'+x.toString(16)).slice(-2))).join('');
    //console.log(pinhash);
    if (pinhash === mybsmiaktivasi)
    {
      app.loginScreen.open('#my-aktivasi-screen');
      window.grecaptchaid = grecaptcha.render( 'mybsmi-grecaptchaaktivasi');
    }
  }
  )
});

$$('.persetujuanaktivasi').on('click', function () {
   let url = $$(this).attr('data-url');
   //console.log(url);
   //window.open(url);
   myviewer('https://mybsmi.netlify.app/'+url);
});

$$('#my-aktivasi-screen .register-button').on('click', function () {

  if (!$$('#my-aktivasi-screen')[0].checkValidity()) {
        //console.log('Check Validity!');
        return;
  }
  
  if ((grecaptcharesponsedata == undefined) || (grecaptcharesponsedata == '')){return;}

  var email = $$('#my-aktivasi-screen [name="email"]').val();
  var password = $$('#my-aktivasi-screen [name="password"]').val();
  var konfirmpassword = $$('#my-aktivasi-screen [name="konfirmpassword"]').val();
  var nama = "'"+$$('#my-aktivasi-screen [name="nama"]').val();
  var jeniskelamin = "'"+$$('#my-aktivasi-screen [name="jeniskelamin"]').val();
  var tanggallahir = "'"+$$('#my-aktivasi-screen [name="tanggallahir"]').val();
  var alamatdomisili = "'"+$$('#my-aktivasi-screen [name="alamatdomisili"]').val();
  var profesi = "'"+$$('#my-aktivasi-screen [name="profesi"]').val();
  var golongandarah = "'"+$$('#my-aktivasi-screen [name="golongandarah"]').val();
  var nohp = "'"+$$('#my-aktivasi-screen [name="nohp"]').val();
  var cabang = "'"+$$('#my-aktivasi-screen [name="cabang"]').val();
  var tahun = "'"+$$('#my-aktivasi-screen [name="tahun"]').val();
  
  if(password != konfirmpassword) 
  {
    app.dialog.alert('Password dan Konfirm Password Harus Sama','Terjadi Kesalahan');
    return;
  }
  let mypreloader = app.dialog.preloader();
  app.request({
    url: apiuserurl,
    method: 'POST',
    cache: false,
    data : { command: 'aktivasi', grecaptcharesponsedata: grecaptcharesponsedata, email: email,password: password, nama: nama, jeniskelamin: jeniskelamin, tanggallahir: tanggallahir, alamatdomisili: alamatdomisili, profesi: profesi, golongandarah:golongandarah, nohp: nohp, cabang: cabang, tahun: tahun  }, 
    success: function (data, status, xhr)
      {
        //console.log(data);
        mypreloader.close();

        var status = JSON.parse(data).status;
        var data = JSON.parse(data).data;
        if (status == "success")
        {
          app.loginScreen.close('#my-aktivasi-screen');
          $$('#my-aktivasi-screen')[0].reset();
          //$$('#overlay-welcome').hide();
          app.dialog.alert('Pembuatan akun telah berhasil. Klik halaman login untuk masuk menggunakan email dan password. Hubungi admin jika butuh bantuan. Terima kasih.','Berhasil');
        }
        else if (status == "failed")
        {
          app.dialog.alert(data,'Terjadi Kesalahan');
        }
        else
        {
          app.dialog.alert(data,'Terjadi Kesalahan');
        }
      },
    error: function (xhr, status, message)
      {
        //console.log(message);
        mypreloader.close();
        app.dialog.alert("Server sedang sibuk",'Terjadi Kesalahan');
      },
  })
  grecaptcha.reset(grecaptchaid);grecaptcharesponsedata = '';
});
//end form aktivasi//////////////////////////







//start form-login/////////////////////////////
$$('#my-login-screen .login-button').on('click', function () {
  if (!$$('#my-login-screen')[0].checkValidity()) {
        //console.log('Check Validity!');
        return;
  }
  
  if ((grecaptcharesponsedata == undefined) || (grecaptcharesponsedata == '')){return;}
  
  var email = $$('#my-login-screen [name="email"]').val();
  var password = $$('#my-login-screen [name="password"]').val();
  let mypreloader = app.dialog.preloader();
  app.request({
    url: apiuserurl,
    method: 'POST',
    cache: false,
    data : { command: 'login',grecaptcharesponsedata: grecaptcharesponsedata, email: email,password: password}, 
    success: function (data, status, xhr)
      {
        //console.log(data);
        mypreloader.close();
                
        var status = JSON.parse(data).status;
        var data = JSON.parse(data).data;
        if (status == "success")
        {
          app.loginScreen.close('#my-login-screen');
          $$('#my-login-screen')[0].reset();
          $$('#overlay-welcome').hide();
          var json = {email:email,token:data.token};
          window.mybsmiuseremail = email;
          window.mybsmiusertoken = data.token;
          window.localStorage["mybsmiuser"] = JSON.stringify(json);
          window.dashboarddata = data;
          getdefaultdatarun(data);
        }
        else if (status == "failed")
        {
          app.dialog.alert(data,'Terjadi Kesalahan');
          $$('#my-login-screen')[0].reset();
        }
        else if (status == "verifikasiemail")
        {
          //app.dialog.alert(data,'Terjadi Kesalahan');
            $$('#my-login-screen')[0].reset();
            var dialog = app.dialog.create({
              text: 'Akun membutuhkan verifikasi email',
              closeByBackdropClick: true,
              on: {
                opened: function () {
                  console.log('Dialog opened')
                }
              },
              buttons: [
                {
                  text: 'Kirim Email',
                  close:true,
                  onClick: function(dialog, e)
                    {
                        let mypreloader = app.dialog.preloader();
                        app.request({
                          url: apiuserurl,
                          method: 'POST',
                          cache: false,
                          data : { command: 'verifikasiemail', email: email,password: password  }, 
                          success: function (data, status, xhr)
                            {
                              //console.log(data);
                              mypreloader.close();

                              var status = JSON.parse(data).status;
                              var data = JSON.parse(data).data;
                              if (status == "success")
                              {
                                dialog.close();
                                app.dialog.alert('Mohon periksa kotak masuk atau kotak spam email anda','Email terkirim');
                              }
                              else if (status == "failed")
                              {
                                app.dialog.alert(data,'Terjadi Kesalahan');
                              }
                              else if (status == "dayliquotalimit")
                              {
                                app.dialog.alert('Saat ini server mencapai limit pengiriman email harian mohon coba lagi besok.','Terjadi Masalah');
                              }
                              else
                              {
                                app.dialog.alert('Tidak dapat memproses data','Terjadi Kesalahan');
                              }
                            },
                          error: function (xhr, status, message)
                            {
                              //console.log(message);
                              mypreloader.close();
                              app.dialog.alert("Server sedang sibuk",'Terjadi Kesalahan');
                            },
                        })
                    }
                }
              ],
            })
            dialog.open();          
        }
        else if (status == "verifikasidata")
        {
          app.dialog.alert('Akun masih dalam proses verifikasi data','Proses Verifikasi');
          $$('#my-login-screen')[0].reset();
        }
        else if (status == "suspen")
        {
          app.dialog.alert(data,'Pemberitahuan');///////////////////////////////////////////////////////////////////////////////////////
          $$('#my-login-screen')[0].reset();
        }
        else
        {
          app.dialog.alert('Tidak dapat memproses data','Terjadi Kesalahan');
          $$('#my-login-screen')[0].reset();
        }
      },
    error: function (xhr, status, message)
      {
        //console.log(message);
        mypreloader.close();
        app.dialog.alert('Server sedang sibuk','Terjadi Kesalahan');
      },
  })
  grecaptcha.reset();grecaptcharesponsedata = '';
});
document.getElementById('my-login-screen').onkeydown = function(e){
   if(e.keyCode == 13){
     $$('#my-login-screen .login-button').click();
   }
};
//end form-login/////////////////////////////







/////////////verifikasiemail//////////////////

var code = params.verifikasi;//console.log(code);

if (code !== undefined)
{
  let mypreloader = app.dialog.preloader();
  app.request({
    url: apiuserurl,
    method: 'GET',
    cache: false,
    data : { command: 'verifikasiemail', code: code}, 
    success: function (data, status, xhr)
      {
        //console.log(data);
        mypreloader.close();

        var status = JSON.parse(data).status;
        var data = JSON.parse(data).data;
        if (status == "success")
        {
            var dialog = app.dialog.create({
              text: 'Alamat email berhasil diverifikasi',
              on: {
                opened: function () {
                  //console.log('Dialog opened')
                }
              },
              buttons: [
                {
                  text: 'OK',
                  close:false,
                  onClick: function(dialog, e)
                    {
                      window.location.href = 'https://mybsmi.bsmijatim.org';
                    }
                }
              ]
            })
            dialog.open();
        }
        else if (status == "failed")
        {
          app.dialog.alert(data,'Terjadi Kesalahan');
        }
        else
        {
          app.dialog.alert(data,'Terjadi Kesalahan');
        }
      },
    error: function (xhr, status, message)
      {
        //console.log(message);
        mypreloader.close();
        app.dialog.alert("Server sedang sibuk",'Terjadi Kesalahan');
      },
  })
}

//endverifikasiemail/////////////////////////





////pencarian///////////////////////////////////////////////
//var params = getParams(window.location.href);
var cari = params.cari;
if (cari !== undefined)
{
  let mypreloader = app.dialog.preloader();
  app.request({
    url: apidataurl,
    method: 'GET',
    cache: false,
    data : { command: 'pencarian', cari: cari}, 
    success: function (data, status, xhr)
      {
        //console.log(data);
        mypreloader.close();

        var status = JSON.parse(data).status;
        var data = JSON.parse(data).data;
        if (status == "success")
        {
            //console.log(data);
            var dialog = app.dialog.create({
              title: 'Data ditemukan',
              content: '<p>Nama : '+safe(data.nama)+'</p><p>Cabang : '+safe(data.cabang)+'</p>',
              on: {
                opened: function () {
                  //console.log('Dialog opened')
                }
              },
              buttons: [
                {
                  text: 'OK',
                  close:true,
                  onClick: function(dialog, e)
                    {
                      window.location.href = 'https://mybsmi.bsmijatim.org';
                    }
                }
              ]
            })
            dialog.open();
        }
        else if (status == "failed")
        {
          app.dialog.alert(data,'Terjadi Kesalahan');
        }
        else
        {
          app.dialog.alert(data,'Terjadi Kesalahan');
        }
      },
    error: function (xhr, status, message)
      {
        //console.log(message);
        mypreloader.close();
        app.dialog.alert("Server sedang sibuk",'Terjadi Kesalahan');
      },
  })
}
////pencarian//////////////////////////////////////////////




//////dev mode/////////////////////////////////////////////////////////
if (isLocal)
{
  app.dialog.prompt('', 'DEV MODE', function (pwd){fdevmode(pwd);})
}

function fdevmode(pwd)
{
  let mypreloader = app.dialog.preloader();
  let devmodeurl = 'https://script.google.com/macros/s/AKfycbztYLCDVY-nZyQJFK7QhIRboEcuRUWPIrfkGzbU6bUnTEn909HgWhwc1VadGotPDIkp7Q/exec';
  app.request({
    url: devmodeurl,
    method: 'POST',
    cache: false,
    data : { password: pwd}, 
    success: function (data, status, xhr)
      {
        //console.log(data);
        mypreloader.close();

        var status = JSON.parse(data).status;
        var data = JSON.parse(data).data;
        if (status == "success")
        {
            //console.log(data);
            window.location.href = '/?access_token='+data;
        }
        else if (status == "failed")
        {
          app.dialog.alert(data,'Terjadi Kesalahan');
        }
        else
        {
          app.dialog.alert(data,'Terjadi Kesalahan');
        }
      },
    error: function (xhr, status, message)
      {
        //console.log(message);
        mypreloader.close();
        app.dialog.alert("Server sedang sibuk",'Terjadi Kesalahan');
      },
  })
}
///////dev mode/////////////////////////////////////////////////////////





//start check session/////////////////////////
if (localStorage.getItem("mybsmiuser") !== null) {
  var json = window.localStorage["mybsmiuser"];
  var email = JSON.parse(json).email;
  var token = JSON.parse(json).token
  let mypreloader = app.dialog.preloader();
  app.request({
    url: apiuserurl,
    method: 'POST',
    cache: false,
    data : { command: 'loginwithtoken', email: email, password: token}, 
    success: function (data, status, xhr)
      {
        //console.log(data);
        mypreloader.close();
                
        var status = JSON.parse(data).status;
        var data = JSON.parse(data).data;
        if (status == "success")
        {
          //console.log(data);
          $$('#overlay-welcome').hide();
          window.mybsmiuseremail = email;
          window.mybsmiusertoken = token;
          window.dashboarddata = data;
          getdefaultdatarun(data);
        }
        else if (status == "failed")
        {
          localStorage.removeItem("mybsmiuser");
        }
        else
        {
        }
      },
    error: function (xhr, status, message)
      {
        //console.log(message);
        mypreloader.close();
      },
  })
} 
//end check session///////////////////////////






///logout button/////////////////////////
function flogout()
{
$$('.my-logout').on('click', function () {
  localStorage.removeItem("mybsmiuser");
  window.mybsmiuseremail = '';
  window.mybsmiusertoken = '';
  app.popover.close('.profile-popover', false);
  $$('#overlay-welcome').css('display','flex');
  //let mypreloader = app.dialog.preloader();
  window.location.href = 'https://bsmijatim.org'
});
}
///logout button/////////////////////////






////start getdefaultdata///////////////////////////
function getdefaultdata(render=true)
{
  let mypreloader = app.dialog.preloader();
  app.request({
    url: apidataurl,
    method: 'POST',
    cache: false,
    data : { token:mybsmiusertoken, command: 'getdefaultdata'}, 
    success: function (data, status, xhr)
      {
        mypreloader.close();
        var status = JSON.parse(data).status;
        var content = JSON.parse(data).data;
        if (status == "success")
        {
          //console.log(content);
          if (render){getdefaultdatarun(content)}
          window.dashboarddata = content;
        }
        else if (status == "failed")
        {
          //console.log("failed");
          app.dialog.alert(content,'Terjadi Kesalahan');
        }
        else
        {
          //console.log("failed");
          app.dialog.alert(content,'Terjadi Kesalahan');
        }
      },
    error: function (xhr, status, message)
      {
        console.log(message);
        mypreloader.close();
        app.dialog.alert("Server sedang sibuk",'Terjadi Kesalahan');
      },
  })
}

function getdefaultdatarun(data)
{ //console.log(data)
  $$('.mybsmi-currentusernama').text(safe(data.user.usernama));
  if (data.user.userphoto !== '') {$$('.mybsmi-avatar').attr('src','https://drive.google.com/uc?export=view&id='+safe(data.user.userphoto));}
  if (data.user.userstatus === "Terverifikasi"){$$('.mybsmi-avatar-badge').css('display','flex');};
  flogout();
  
  var relawan = -1;
  var cabang = 0;
  var rekapitulasiprov = '';
  var rekapitulasicabang = '';
  var datacabang = data.cabang;
  datacabang.sort(function(a, b){return b.relawan - a.relawan});
  for(i=0;i<datacabang.length;i++)
  {
    let kode;
    for(var j=0;j<kodecabang.length;j++)
    {
      if (datacabang[i].cabang === kodecabang[j][0])
      {
        kode = kodecabang[j][1];
      }
    }
    
    if (datacabang[i].cabang == 'BSMI Jawa Timur')
    {
      rekapitulasiprov += '<tr> <td class="label-cell"><a href="/cabang/'+kode+'">'+safe(datacabang[i].cabang)+'</a></td> <td class="numeric-cell">'+safe(datacabang[i].relawan-1)+'</td> </tr>';
    }
    else
    {
    rekapitulasicabang += '<tr> <td class="label-cell"><a href="/cabang/'+kode+'">'+safe(datacabang[i].cabang)+'</a></td> <td class="numeric-cell">'+safe(datacabang[i].relawan)+'</td> </tr>';
    cabang = cabang+1;
    }
    relawan = relawan+datacabang[i].relawan;
  }
  $$('.mybsmi-rekapitulasicabang').html(rekapitulasicabang);
  $$('.mybsmi-rekapitulasiprov').html(rekapitulasiprov);

  var ratiorelawan = relawan/(relawan*10);
  var gauge1 = app.gauge.get('#mybsmi-relawan');
  gauge1.update({
    el: '#mybsmi-relawan',
    value: ratiorelawan,
    valueText: relawan,
  })  

  var ratiocabang = cabang/38;
  var gauge2 = app.gauge.get('#mybsmi-cabang');
  gauge2.update({
    el: '#mybsmi-cabang',
    value: ratiocabang,
    valueText: cabang,
  })
  
  let ver = JSON.parse(data.user.usermydata)
  if (ver.verifikator)
  {
    $$('.mybsmi-verifikatormenu').show();
  }  
  if (ver.admin)
  {
    $$('.mybsmi-adminmenu').show();
  }  
  
}
///end getdefaultdata//////////////////////////////




//////fpagecabang/////////////////////////////////////////////
function fpagecabang(run = true,cabangid)
{
  //console.log(cabangid);
  if (typeof mybsmicabangdata === 'undefined' || mybsmicabangdata === null)
  {
      let mypreloader = app.dialog.preloader();
      app.request({
        url: apidataurl,
        method: 'POST',
        cache: false,
        data : { token:mybsmiusertoken, command: 'getcabangdata'}, 
        success: function (data, status, xhr)
          {
            mypreloader.close();
            var status = JSON.parse(data).status;
            var content = JSON.parse(data).data;
            if (status == "success")
            {
              //console.log(content);
              window.mybsmicabangdata = content;
              if (run) fpagecabangrun(content,cabangid);
            }
            else if (status == "failed")
            {
              //console.log("failed");
              app.dialog.alert(content,'Terjadi Kesalahan');
            }
            else
            {
              //console.log("failed");
              app.dialog.alert(content,'Terjadi Kesalahan');
            }
          },
        error: function (xhr, status, message)
          {
            //console.log(message);
            mypreloader.close();
            app.dialog.alert("Server sedang sibuk",'Terjadi Kesalahan');
          },
      })
  }
  else
  {
    if (run) fpagecabangrun(mybsmicabangdata,cabangid);
  }

  $$('.mybsmi-cabangrefresh').on('click', function () {
    //mybsmicabangdata = null
    //fpagecabang()
  })
}

function fpagecabangrun(content,cabangid)
{
  //console.log(cabangid);
  for (i=0;i<kodecabang.length;i++)
  {
    if (kodecabang[i][1] === cabangid) cabangnama = kodecabang[i][0];
  }
  //console.log(cabangnama);
  $$('.mybsmi-cabangnama').text(cabangnama);
  var data = '<div class="data-table data-table-collapsible data-table-init"><table><thead><tr><th></th><th>Nama</th><th>Cabang</th><th>Aktif</th></tr></thead><tbody>';
  for (i=content.length-1;i>-1;i--)
  {
      if ((content[i][1] === '0OOBNq02038mf3ZfIdV7')&&(mybsmiuseremail !== 'nuzulz@gmail.com')){continue;}else{if ((content[i][1] === '0OOBNq02038mf3ZfIdV7')&&(!isLocal)) continue;}
      
      if ((content[i][2] === 'Terbatas')||(content[i][2] === 'Terverifikasi')||(content[i][2] === 'Tertolak')){}else{continue;}
      
      if (content[i][4] === cabangnama){}else{continue;}
      
      let date = new Intl.DateTimeFormat("id-ID", { hour12:false,dateStyle: "short" , timeStyle: "short",  timeZone: "Asia/Jakarta"}).format(new Date(content[i][0]));date = date.split(' ');date = date[0];
      
      data += '<tr class="mybsmi-admin-item-'+safe(content[i][1])+'"><td data-collapsible-title=""><img src="avatar.png" style="width:1.5em;aspet-ratio 1/1;object-fit:cover;border-radius:50% 50%;overflow:hidden;"></td><td data-collapsible-title="Nama"><a class="mybsmi-cabangaction" data-user="'+btoa(JSON.stringify(content[i]))+'">'+safe(content[i][3])+'</a></td><td data-collapsible-title="Aktif">'+safe(content[i][4])+'</td><td data-collapsible-title="Aktif">'+safe(date)+'</td></tr>';
  }
  data += '</tbody></table></div>';
  $$('.mybsmi-cabang').html(data);
  
  for (i=content.length-1;i>-1;i--)
  {
    let url = 'https://drive.google.com/uc?export=view&id='+safe(content[i][5]);
    $$('.mybsmi-admin-item-'+safe(content[i][1])+' img').attr('src',url);
  }

  $$('.mybsmi-cabang a.mybsmi-cabangaction').on('click', function (e) {
        let base64 = this.attributes["data-user"].value;
        let data = JSON.parse(atob(base64));
        //console.log(data);
        let url = "/relawan/"+safe(data[1]);
        //console.log(url);
        app.views.main.router.navigate(url);
  });
}
//////fpagecabang///////////////////////////////////////////////





//////////////////////////////////////////////////////////////
function fpagerelawan(relawanid)
{

  fpagecabang(false);
  function fperiksakesiapan()
  {
      if (typeof mybsmicabangdata === 'undefined' || mybsmicabangdata === null) {
        setTimeout(function(){ fperiksakesiapan(); }, 1000);
        return;
      }

      for (var i=0;i<mybsmicabangdata.length;i++)
      {
        if (relawanid === mybsmicabangdata[i][1])
        {
          fpagerelawanrun(mybsmicabangdata[i]);
        }
      }
  }
  fperiksakesiapan()
}

function fpagerelawanrun(data)
{
  //console.log(data);
  let date = new Intl.DateTimeFormat("id-ID", { hour12:false,dateStyle: "short" , timeStyle: "short",  timeZone: "Asia/Jakarta"}).format(new Date(data[0]));date = date.split(' ');date = date[0];
  let html = ''
+'    <img class="mybsmi-relawan-userphoto" src="avatar.png" style="width:150px;height:150px;margin: 20px 10px 0px;border-radius: 50%;object-fit: cover;"><span class="badge color-blue mybsmi-relawan-avatar-badge" style="bottom:20px;right:-40px;display:none;"><i class="icon f7-icons" style="font-size:12px;">checkmark_seal</i></span>'
+'    <p class="mybsmi-relawan-data text-align-center"><span style="font-weight:bold;">'+safe(data[3])+'</span><br><span style="font-weight:normal;">'+safe(data[4])+' | '+safe(data[6])+' Bintang</span><br><span style="font-weight:normal;">Aktif '+safe(date)+'</span><br><br><span><a href="#" class="button button-fill color-red display-none mybsmi-relawan-kirimpesan">Kirim Pesan</a></span><p>';
  $$('.mybsmi-relawan').html(html);
  let src = "https://drive.google.com/uc?export=view&id="+safe(data[5]);
  $$('.mybsmi-relawan-userphoto').attr('src',src);
  if (data[2] === "Terverifikasi") $$('.mybsmi-relawan-avatar-badge').css("display","block");
  if (data[1] !== dashboarddata.user.useruid) $$('.mybsmi-relawan-kirimpesan').removeClass('display-none');
  $$('.mybsmi-relawan-kirimpesan').on('click', function (e) {
        fkirimpesan(data[1],data[3],data[5])
  });
}
////////////////////////////////////////////////////////////





///grecaptcha/////////////////////////////////
function grecaptcharesponse(data)
{
  //console.log(data);
  grecaptcharesponsedata = data;
}

function grecaptchaexpired()
{
  //console.log('expired');
  grecaptcharesponsedata = '';
}
///grecaptcha/////////////////////////////////




////fpageprofilku////////////////////////////
function fpageprofilku()
{
    var data = dashboarddata.user;
    $$('.mybsmi-profilku .mybsmi-userphoto').attr('src','https://drive.google.com/uc?export=view&id='+safe(data.userphoto));
    let bintang = JSON.parse(data.usermydata).bintang;//console.log(bintang);
    if (typeof bintang === 'undefined' || bintang === null) bintang = 0;
    $$('.mybsmi-profilku .mybsmi-bintang').text(safe(bintang)+' bintang');
    $$('.mybsmi-profilku .mybsmi-usernama').text(safe(data.usernama));
    $$('.mybsmi-profilku .mybsmi-userjeniskelamin').text(safe(data.userjeniskelamin));
    $$('.mybsmi-profilku .mybsmi-usertanggallahir').text(safe(data.usertanggallahir));
    $$('.mybsmi-profilku .mybsmi-userprofesi').text(safe(data.userprofesi));
    $$('.mybsmi-profilku .mybsmi-usergolongandarah').text(safe(data.usergolongandarah));
    $$('.mybsmi-profilku .mybsmi-useralamatdomisili').text(safe(data.useralamatdomisili));
    $$('.mybsmi-profilku .mybsmi-useremail').text(safe(data.useremail));
    $$('.mybsmi-profilku .mybsmi-usernohp').text(safe(data.userhp));
    $$('.mybsmi-profilku .mybsmi-usercabang').text(safe(data.usercabang));
    $$('.mybsmi-profilku .mybsmi-usertahunbergabung').text(safe(data.usertahunbergabung));
    if (data.userstatus === "Terverifikasi"){$$('.mybsmi-avatar-badge').css('display','flex');};
    $$('.mybsmi-lihatprofil').on('click', function (e) {
        let url = "/relawan/"+safe(data.useruid);
        app.views.main.router.navigate(url);          
    });
}
////fpageprofilku////////////////////////////




///////RESET PASSWORD BUTTON/////////////////////////////////////////////////////////////////////////////////////////////////
function resetpasswordbutton()
{
    $$(".reset-password-open").click(function(){
      resetpasswordopen();
    });
}

resetpasswordbutton();

function resetpasswordopen()
{
    var dynamicPopup = app.popup.create({
      content: '<div class="popup" style="background:#fff">'+
      '<div class="block">'+
      
        '<form id="resetpasswordform" class="login-screen-content"><div class="login-screen-title">Reset Password</div> <div class="list"> <ul> <li class="item-content item-input"> <div class="item-inner"> <div class="item-title item-label">Email</div> <div class="item-input-wrap"> <input id="resetpasswordemail" type="email" name="email" placeholder="Masukkan email" required validate> </div> </div> </li> <li class="item-content item-input"> <div style="padding:20px 20px;justify-content:center;align-items:center;display:flex;width:100%;"> <div id="mybsmi-lupapassword" class="g-recaptcha" data-sitekey="6LcP1RskAAAAANtjMoK9vf0tL37hI_uRIxsQm9-k" data-callback="grecaptcharesponse" data-expired-callback="grecaptchaexpired"></div> </div> <li> </ul> </div> <div class="list"> <div class="block-footer"><a href="#" class="button button-raised button-fill resetpasswordemailsubmit">SUBMIT</a><center><a href="#" class="item-link list-button actions-close popup-close">Batal</a></center></div> </div></form>'+
        
       '</div></div>',
    });     
    dynamicPopup.open();
    grecaptcha.render( 'mybsmi-lupapassword');
        
    $$(".resetpasswordemailsubmit").click(function(){
      resetpasswordemail(dynamicPopup);
    });  
}

function resetpasswordemail(dynamicPopup)
{
    if (!$$('#resetpasswordform')[0].checkValidity()) {
        //console.log('Check Validity!');
        return;
    }
    
    if ((grecaptcharesponsedata == undefined) || (grecaptcharesponsedata == '')){return;}
    
    var email = $$('#resetpasswordform [name="email"]').val();
    //console.log(email);
      
      let mypreloader = app.dialog.preloader(); 
      app.request({
          method: "POST",
          data : {command:'resetpasswordemail',email: email, password: 'pwd',grecaptcharesponsedata: grecaptcharesponsedata},
          url: apiuserurl,
          error: function(xhr, status, message) 
            {
              //console.log(message);
              mypreloader.close();
              dynamicPopup.close();  
              //var toastBottom = app.toast.create({ text: 'Server sedang sibuk', closeTimeout: 5000,position: 'center', });toastBottom.open();  
              app.dialog.alert('Server sedang sibuk','Terjadi Kesalahan');       
            },
          success: function(data, status, xhr) 
            {
              //console.log(data);
              mypreloader.close(); 
              //var toastBottom = app.toast.create({ text: jqXHR.responseText, closeTimeout: 2000,position: 'center', });toastBottom.open();
              var json = JSON.parse(data); 
              var status = json['status'];
              var msg = json['data'];
              if (status === "success")
              {
                dynamicPopup.close();
                resetpasswordotpform(email,msg);
              }
              else if ((status === "error") || (status === "failed")) 
              {
                dynamicPopup.close();
                //var toastBottom = app.toast.create({ text: msg, closeTimeout: 5000,position: 'center', });toastBottom.open();
                app.dialog.alert(msg,'Terjadi Kesalahan');
              }
              else
              {
                dynamicPopup.close();
                //var toastBottom = app.toast.create({ text: msg, closeTimeout: 5000,position: 'center', });toastBottom.open();
                app.dialog.alert(msg,'Terjadi Kesalahan');
              }
              
            }
      }); 
      
}
function resetpasswordotpform(email,hash)
{
    var dynamicPopup = app.popup.create({
      content: '<div class="popup" style="background:#fff">'+
      '<div class="block">'+
      
        '<form id="resetpasswordotpform" class="login-screen-content"><div class="login-screen-title">Reset Password</div><center><p>Kode OTP telah dikirimkan ke email anda. Periksa di inbox atau folder spam. </p><p>Kedaluwarsa dalam <span id="otpexpired">120</span> detik</p></center> <div class="list"> <ul> <li class="item-content item-input"> <div class="item-inner"> <div class="item-title item-label">Kode OTP</div> <div class="item-input-wrap"> <input id="resetpasswordotp" type="text" name="otp" placeholder="Masukkan kode OTP" pattern="[0-9]{6}" required validate> </div> </div> </li> <li class="item-content item-input"> <div style="padding:20px 20px;justify-content:center;align-items:center;display:flex;width:100%;"> <div id="mybsmi-lupapasswordotp" class="g-recaptcha" data-sitekey="6LcP1RskAAAAANtjMoK9vf0tL37hI_uRIxsQm9-k" data-callback="grecaptcharesponse" data-expired-callback="grecaptchaexpired"></div> </div> <li></ul> </div> <div class="list"> <div class="block-footer"><a href="#" class="button button-raised button-fill resetpasswordotpsubmit">SUBMIT</a><center><a href="#" class="item-link list-button actions-close popup-close">Batal</a></center></div> </div></form>'+
        
       '</div></div>',
    });     
    dynamicPopup.open();
    grecaptcha.render( 'mybsmi-lupapasswordotp');
    
    otpexpired();
    
    $$(".resetpasswordotpsubmit").click(function(){
      resetpasswordotp(dynamicPopup,email,hash);
    }); 
}

function otpexpired()
{
    setTimeout(function () {
          var expired = $$('#otpexpired').text();
          if (expired != 0)
          {
            var newexpired = expired-1;
            $$('#otpexpired').text(newexpired);
            otpexpired();
          }
    }, 1000);
}

function resetpasswordotp(dynamicPopup,email,hash)
{
    if (!$$('#resetpasswordotpform')[0].checkValidity()) {
        //console.log('Check Validity!');
        return;
    }
    
    if ((grecaptcharesponsedata == undefined) || (grecaptcharesponsedata == '')){return;}
    
    var otp = $$('#resetpasswordotpform [name="otp"]').val();
    //console.log(email);
      
      let mypreloader = app.dialog.preloader(); 
      app.request({
          method: "POST",
          data : {command:'resetpasswordotp',email:email,password:'pwd',hash:hash,otp:otp,grecaptcharesponsedata: grecaptcharesponsedata},
          url: apiuserurl,
          error: function(xhr, status, message) 
            {
              //console.log(message);
              mypreloader.close(); 
              dynamicPopup.close(); 
              //var toastBottom = app.toast.create({ text: 'Server sedang sibuk', closeTimeout: 5000,position: 'center', });toastBottom.open();          
              app.dialog.alert('Server sedang sibuk','Terjadi Kesalahan');
            },
          success: function(data, status, xhr) 
            {
              //console.log(data);
              mypreloader.close(); 
              dynamicPopup.close();
              var json = JSON.parse(data); 
              var status = json['status'];
              var msg = json['data'];
              if (status === "success")
              {
              resetpasswordinputform(msg,email);
              }
              else if (status === "failed")
              {
                //var toastBottom = app.toast.create({ text: msg, closeTimeout: 5000,position: 'center', });toastBottom.open();
                app.dialog.alert(msg,'Terjadi Kesalahan');
              }
              else
              {
                //var toastBottom = app.toast.create({ text: msg, closeTimeout: 5000,position: 'center', });toastBottom.open();
                app.dialog.alert(msg,'Terjadi Kesalahan');
              }
            }
      }); 
}

function resetpasswordinputform(data,email)
{
    var dynamicPopup = app.popup.create({
      content: '<div class="popup" style="background:#fff">'+
      '<div class="block">'+
      
        '<form id="resetpasswordinputform" class="login-screen-content"><div class="login-screen-title">Reset Password</div><p><center>Masukkan password baru anda. </center></p> <div class="list"> <ul> <li class="item-content item-input"> <div class="item-inner"> <div class="item-title item-label">Password</div> <div class="item-input-wrap"> <input id="resetpasswordinput" type="password" name="password" placeholder="Masukkan password baru" minlength="10" required validate> </div> </div> </li> </ul> </div> <div class="list"> <div class="block-footer"><a href="#" class="button button-raised button-fill resetpasswordinputsubmit">SUBMIT</a><center><a href="#" class="item-link list-button actions-close popup-close">Batal</a></center></div> </div></form>'+
        
       '</div></div>',
    });     
    dynamicPopup.open();
    
    $$(".resetpasswordinputsubmit").click(function(){
      resetpasswordinput(dynamicPopup,data,email);
    }); 
}

function resetpasswordinput(dynamicPopup,data,email)
{
    if (!$$('#resetpasswordinputform')[0].checkValidity()) {
        //console.log('Check Validity!');
        return;
    }
    var password = $$('#resetpasswordinputform [name="password"]').val();
    //console.log(email);
      
      let mypreloader = app.dialog.preloader(); 
      app.request({
          method: "POST",
          data : {command:'resetpasswordinput',email:email,key:data,password:password},
          url: apiuserurl,
          error: function(xhr, status, message) 
            {
              //console.log(message);
              mypreloader.close();  
              dynamicPopup.close();
              //var toastBottom = app.toast.create({ text: 'Server sedang sibuk', closeTimeout: 5000,position: 'center', });toastBottom.open();  
              app.dialog.alert('Server sedang sibuk','Terjadi Kesalahan');        
            },
          success: function(data, status, xhr) 
            {
              //console.log(data);
              mypreloader.close(); 
              dynamicPopup.close();
              var json = JSON.parse(data); 
              var status = json['status'];
              var msg = json['data'];
              if (status === "success")
              {
                //var toastBottom = app.toast.create({ text: msg, closeTimeout: 5000,position: 'center', });toastBottom.open();
                app.dialog.alert(msg,'Berhasil');
              }
              else if (status === "failed")
              {
                //var toastBottom = app.toast.create({ text: msg, closeTimeout: 5000,position: 'center', });toastBottom.open();
                app.dialog.alert(msg,'Terjadi Kesalahan');
              }
              else
              {
                //var toastBottom = app.toast.create({ text: msg, closeTimeout: 5000,position: 'center', });toastBottom.open();
                app.dialog.alert(msg,'Terjadi Kesalahan');
              }
            }
      }); 
}
///////RESET PASSWORD BUTTON/////////////////////////////////////////////////////////////////////////////////////////////////




///////lengkapi data/////////////////////////////////////
function flengkapidata()
{
  var dialog = app.dialog.create({
    text: 'Silahkan lengkapi data Anda untuk membuka fitur ini.',
    closeByBackdropClick: false,
    destroyOnClose: true,
    on: {
      opened: function () {
        //console.log('Dialog opened')
      }
    },
    buttons: [
      {
        text: 'Nanti Saja',
        close:true,
        color: 'gray',
        onClick: function(dialog, e)
          {
          }
      },
      {
        text: 'Lengkapi Data',
        close:true,
        onClick: function(dialog, e)
          {
            flengkapiphoto();
          }
      },
    ]
  });
  dialog.open();
}

function flengkapiphoto()
{
  var dialog = app.dialog.create({
    title: 'Photo',
    closeByBackdropClick: false,
    destroyOnClose: true,
    content: '<div style="width:100%;">'
      +'<form runat="server" style="display:flex;flex-direction:column;align-items:center;justify-content: center;">'
      +'<img id="mybsmiuploadphotopreview" src="avatar.png" style="width:150px;height:150px;margin: 10px 10px;border-radius: 50%;object-fit: cover;">'
      +'<input accept="image/jpeg" type="file" id="mybsmiuploadphoto" />'
      +'</form>'
      +'</div>',
    on: {
      opened: function () {
          mybsmiuploadphoto.onchange = evt => {
            const [file] = mybsmiuploadphoto.files
            if (file) {
              if (file.size > 524288)
              {
                //app.dialog.alert('File tidak boleh lebih dari 500 KB','Terjadi Kesalahan');
                var toastBottom = app.toast.create({ text: 'File tidak boleh lebih dari 500 KB', closeTimeout: 5000,position: 'center', });toastBottom.open();
                mybsmiuploadphoto.value = '';
                mybsmiuploadphotopreview.src = 'avatar.png'
              }
              else
              {
                mybsmiuploadphotopreview.src = URL.createObjectURL(file)
              }
            }
            else
            {
              mybsmiuploadphotopreview.src = 'avatar.png'
            }
          }
      }
    },
    buttons: [
      {
        text: 'Cancel',
        close:true,
        color: 'gray',
        onClick: function(dialog, e)
          {
          }
      },
      {
        text: 'Upload',
        close:false,
        onClick: function(dialog, e)
          {
            const [file] = mybsmiuploadphoto.files
            if (file) {
              const fr = new FileReader();
              fr.onload = function(e) {
                const obj = {
                  filename: file.name,
                  mimeType: file.type,
                  bytes: [...new Int8Array(e.target.result)]
                };
                fuploadphoto(dialog,obj);
              };
              fr.readAsArrayBuffer(file);
            }
            else
            {
              var toastBottom = app.toast.create({ text: 'Anda belum memilih photo', closeTimeout: 5000,position: 'center', });toastBottom.open();
            }
          }
      },
    ]
  });
  dialog.open();


}

function fuploadphoto(dialog,obj)
{
  //console.log(obj);
  var data = JSON.stringify(obj);
  dialog.close();
  let mypreloader = app.dialog.preloader();
  app.request({
    url: apidataurl,
    method: 'POST',
    cache: false,
    data : { token:mybsmiusertoken, command: 'uploaduserphoto', data: data}, 
    success: function (data, status, xhr)
      {
        mypreloader.close();        
        var status = JSON.parse(data).status;
        var content = JSON.parse(data).data;
        if (status == "success")
        {
          //console.log(content);
          var toastBottom = app.toast.create({ text: 'Upload photo berhasil', closeTimeout: 5000,position: 'center', });toastBottom.open();
          getdefaultdata();
          
        }
        else if (status == "failed")
        {
          //console.log("failed");
          app.dialog.alert(content,'Terjadi Kesalahan');
        }
        else
        {
          //console.log("failed");
          app.dialog.alert(content,'Terjadi Kesalahan');
        }
      },
    error: function (xhr, status, message)
      {
        //console.log(message);
        mypreloader.close();
        dialog.close();
        app.dialog.alert("Server sedang sibuk",'Terjadi Kesalahan');
      },
  });
}
//////lengkapi data/////////////////////////////////////////////////



///////verifikasi data///////////////////////////////////////////////
function fverifikasidata()
{
  var dialog = app.dialog.create({
    title: 'Permintaan Verifikasi',
    text: 'Silahkan verifikasi identitas Anda untuk membuka fitur ini. Anda perlu menyiapkan kartu identitas untuk mengajukan verifikasi.',
    closeByBackdropClick: false,
    destroyOnClose: true,
    on: {
      opened: function () {
        //console.log('Dialog opened')
      }
    },
    buttons: [
      {
        text: 'Nanti Saja',
        close:true,
        color: 'gray',
        onClick: function(dialog, e)
          {
          }
      },
      {
        text: 'Verifikasi',
        close:true,
        onClick: function(dialog, e)
          {
            fverifikasiidentitas();
          }
      },
    ]
  });
  dialog.open();
}

function fverifikasiidentitas()
{
  var dialog = app.dialog.create({
    title: 'Permintaan Verifikasi',
    closeByBackdropClick: false,
    destroyOnClose: true,
    content: '<div style="width:100%;height:60vh;overflow:auto;">'
      +'<form id="mybsmi-formverifikasiidentitas" runat="server" style="display:flex;flex-direction:column;align-items:center;justify-content: center;">'
      +'  <img id="mybsmiuploadphotopreview" src="ktpplaceholder.png" style="width:200px;height:150px;margin: 10px 10px;object-fit: contain;">'
      +'  <input accept="image/jpeg" type="file" name="mybsmiuploadphoto" id="mybsmiuploadphoto" required validate/>'
      +'  <div class="list no-hairlines-md">'
      +'    <ul>'
      +'        <li class="item-content item-input"><div class="item-inner"><div class="item-input-wrap">'
      +'            Isi Sesuai Identitas'
      +'            </div></div>'
      +'        </li>'
      +'        <li class="item-content item-input"><div class="item-inner"><div class="item-input-wrap">'
      +'            <input type="text" name="nik" placeholder="NIK" required validate/>'
      +'            </div></div>'
      +'        </li>'
      +'        <li class="item-content item-input"><div class="item-inner"><div class="item-input-wrap">'
      +'            <input type="text" name="nama" placeholder="Nama" required validate/>'
      +'            </div></div>'
      +'        </li>'
      +'        <li class="item-content item-input"><div class="item-inner"><div class="item-input-wrap">'
      +'            <input type="text" name="ttl" placeholder="Tempat/Tgl Lahir" required validate/>'
      +'            </div></div>'
      +'        </li>'
      +'        <li class="item-content item-input"><div class="item-inner"><div class="item-input-wrap">'
      +'            <input type="text" name="jeniskelamin" placeholder="Jenis Kelamin" required validate/>'
      +'            </div></div>'
      +'        </li>'
      +'        <li class="item-content item-input"><div class="item-inner"><div class="item-input-wrap">'
      +'            <input type="text" name="alamat" placeholder="Alamat" required validate/>'
      +'            </div></div>'
      +'        </li>'
      +'        <li class="item-content item-input"><div class="item-inner"><div class="item-input-wrap">'
      +'            <input type="text" name="rtrw" placeholder="RT/RW" required validate/>'
      +'            </div></div>'
      +'        </li>'
      +'        <li class="item-content item-input"><div class="item-inner"><div class="item-input-wrap">'
      +'            <input type="text" name="keldesa" placeholder="Kel/Desa" required validate/>'
      +'            </div></div>'
      +'        </li>'
      +'        <li class="item-content item-input"><div class="item-inner"><div class="item-input-wrap">'
      +'            <input type="text" name="kecamatan" placeholder="Kecamatan" required validate/>'
      +'            </div></div>'
      +'        </li>'
      +'        <li class="item-content item-input"><div class="item-inner"><div class="item-input-wrap">'
      +'            <input type="text" name="kabupaten" placeholder="Kabupaten" required validate/>'
      +'            </div></div>'
      +'        </li>'
      +'        <li class="item-content item-input"><div class="item-inner"><div class="item-input-wrap">'
      +'            <input type="text" name="provinsi" placeholder="Provinsi" required validate/>'
      +'            </div></div>'
      +'        </li>'
      +'        <li class="item-content item-input"><div class="item-inner"><div class="item-input-wrap">'
      +'            <input type="text" name="agama" placeholder="Agama" required validate/>'
      +'            </div></div>'
      +'        </li>'
      +'        <li class="item-content item-input"><div class="item-inner"><div class="item-input-wrap">'
      +'            <input type="text" name="statusperkawinan" placeholder="Status Perkawinan" required validate/>'
      +'            </div></div>'
      +'        </li>'
      +'        <li class="item-content item-input"><div class="item-inner"><div class="item-input-wrap">'
      +'            <input type="text" name="pekerjaan" placeholder="Pekerjaan" required validate/>'
      +'            </div></div>'
      +'        </li>'
      +'        <li class="item-content item-input"><div class="item-inner"><div class="item-input-wrap">'
      +'            <input type="text" name="kewarganegaraan" placeholder="Kewarganegaraan" required validate/>'
      +'            </div></div>'
      +'        </li>'
      +'        <li class="item-content item-input"><div class="item-inner"><div class="item-input-wrap">'
      +'            <input type="text" name="berlakuhingga" placeholder="Berlaku Hingga" required validate/>'
      +'            </div></div>'
      +'        </li>'
      +'    </ul>'
      +'  </div>'
      +'</form>'
      +'</div>',
    on: {
      opened: function () {
          mybsmiuploadphoto.onchange = evt => {
            const [file] = mybsmiuploadphoto.files
            if (file) {
              if (file.size > 524288)
              {
                //app.dialog.alert('File tidak boleh lebih dari 500 KB','Terjadi Kesalahan');
                var toastBottom = app.toast.create({ text: 'File tidak boleh lebih dari 500 KB', closeTimeout: 5000,position: 'center', });toastBottom.open();
                mybsmiuploadphoto.value = '';
                mybsmiuploadphotopreview.src = 'ktpplaceholder.png'
              }
              else
              {
                mybsmiuploadphotopreview.src = URL.createObjectURL(file)
              }
            }
            else
            {
              mybsmiuploadphotopreview.src = 'ktpplaceholder.png'
            }
          }
      }
    },
    buttons: [
      {
        text: 'Cancel',
        close:true,
        color: 'gray',
        onClick: function(dialog, e)
          {
          }
      },
      {
        text: 'Verifikasi',
        close:false,
        onClick: function(dialog, e)
          {            
            const [file] = mybsmiuploadphoto.files
            if (file) {
              if (!$$('#mybsmi-formverifikasiidentitas')[0].checkValidity()) {
                    //console.log('Check Validity!');
                    return;
              }
              var dataform = JSON.stringify(app.form.convertToData('#mybsmi-formverifikasiidentitas'));//console.log(dataform);
              const fr = new FileReader();
              fr.onload = function(e) {
                const obj = {
                  filename: file.name,
                  mimeType: file.type,
                  bytes: [...new Int8Array(e.target.result)],
                  ktp: dataform
                };
                fkirimverifikasiidentitas(dialog,obj);
              };
              fr.readAsArrayBuffer(file);
            }
            else
            {
              var toastBottom = app.toast.create({ text: 'Pilih file KTP', closeTimeout: 5000,position: 'center', });toastBottom.open();
            }
          }
      },
    ]
  });
  dialog.open();
}

function fkirimverifikasiidentitas(dialog,obj)
{
  //console.log(obj);
  var data = JSON.stringify(obj);
  dialog.close();
  let mypreloader = app.dialog.preloader();
  app.request({
    url: apidataurl,
    method: 'POST',
    cache: false,
    data : { token:mybsmiusertoken, command: 'verifikasiidentitas', data: data}, 
    success: function (data, status, xhr)
      {
        mypreloader.close();        
        var status = JSON.parse(data).status;
        var content = JSON.parse(data).data;
        if (status == "success")
        {
          //console.log(content);
          //app.dialog.alert("Permintaan verifikasi telah terkirim. Proses verifikasi bisa membutuhkan beberapa hari. Terima kasih.",'Permintaan Verifikasi');
          fonesignalprompt('Permintaan Verifikasi Terkirim','Beri tahu jika proses verifikasi selesai');
          getdefaultdata();
        }
        else if (status == "failed")
        {
          //console.log("failed");
          app.dialog.alert(content,'Terjadi Kesalahan');
        }
        else
        {
          //console.log("failed");
          app.dialog.alert(content,'Terjadi Kesalahan');
        }
      },
    error: function (xhr, status, message)
      {
        //console.log(message);
        mypreloader.close();
        dialog.close();
        app.dialog.alert("Server sedang sibuk",'Terjadi Kesalahan');
      },
  });
}
///////verifikasi data///////////////////////////////////////////////





//////fpageekta///////////////////////////////////////////////////
function fpageekta()
{
    let data = JSON.parse(dashboarddata.user.usermydata)
    let now  = new Date(); 
    let ekta = data.ekta;
    let ektaberlaku = data.ektaberlaku;
    let ektaberlakucurrent = '31/12/'+now.getFullYear().toString();
    if ((ekta)&&(ektaberlaku === ektaberlakucurrent))
    {
        fgetekta();
    }
    else
    {
      let label = 'BUAT e-KTA';
      if (ekta)
      {
        label = 'PERBARUI e-KTA';
        app.dialog.alert('Masa berlaku e-KTA anda telah habis','Info');
      }
      $$('.mybsmi-ektabsmi').html('<a class="button button-fill">'+label+'</a>');
      $$('.mybsmi-ektabsmi a').on('click', function () {
            
            app.dialog.confirm('Pembuatan e-KTA memerlukan waktu 2-4 menit.', 'Pemberitahuan', function (){fbuatekta();})
      });
    }
}

function fbuatekta()
{
  let mypreloader = app.dialog.preloader();
  app.request({
    url: apidataurl,
    method: 'POST',
    cache: false,
    data : { token:mybsmiusertoken, command: 'buatekta'}, 
    success: function (data, status, xhr)
      {
        mypreloader.close();
        var status = JSON.parse(data).status;
        var content = JSON.parse(data).data;
        if (status == "success")
        {
          //console.log(content);
          convertekta();
        }
        else if (status == "failed")
        {
          //console.log("failed");
          app.dialog.alert(content,'Terjadi Kesalahan');
        }
        else
        {
          //console.log("failed");
          app.dialog.alert(content,'Terjadi Kesalahan');
        }
      },
    error: function (xhr, status, message)
      {
        //console.log(message);
        app.dialog.alert("Server sedang sibuk",'Terjadi Kesalahan');
        mypreloader.close();
      },
  })
}

function convertekta()
{
  let mypreloader = app.dialog.preloader();
  app.request({
    url: apidataurl,
    method: 'POST',
    cache: false,
    data : { token:mybsmiusertoken, command: 'convertekta'}, 
    success: function (data, status, xhr)
      {
        mypreloader.close();
        var status = JSON.parse(data).status;
        var content = JSON.parse(data).data;
        if (status == "success")
        {
          //console.log(content);
          fgetekta();
          getdefaultdata(false);
        }
        else if (status == "failed")
        {
          //console.log("failed");
          app.dialog.alert(content,'Terjadi Kesalahan');
        }
        else
        {
          //console.log("failed");
          app.dialog.alert(content,'Terjadi Kesalahan');
        }
      },
    error: function (xhr, status, message)
      {
        //console.log(message);
        app.dialog.alert("Server sedang sibuk",'Terjadi Kesalahan');
        mypreloader.close();
      },
  })
}

function fgetekta()
{

  if (typeof mybsmiekta === 'undefined' || mybsmiekta === null)
  {
      let mypreloader = app.dialog.preloader();
      app.request({
        url: apidataurl,
        method: 'POST',
        cache: false,
        data : { token:mybsmiusertoken, command: 'getekta'}, 
        success: function (data, status, xhr)
          {
            mypreloader.close();
            var status = JSON.parse(data).status;
            var content = JSON.parse(data).data;
            if (status == "success")
            {
              //console.log(content);
              window.mybsmiekta = content;
              //$$('.mybsmi-ektabsmi').html('<img id="imgekta" src="" style="width:100%;max-width:200px;cursor:pointer;" onclick="javascript:myimage(this)">');
              //let src = "https://drive.google.com/uc?export=view&id="+safe(content);
              //$$('#imgekta').attr('src',src);
              showekta();
            }
            else if (status == "failed")
            {
              //console.log("failed");
              app.dialog.alert(content,'Terjadi Kesalahan');
            }
            else
            {
              //console.log("failed");
              app.dialog.alert(content,'Terjadi Kesalahan');
            }
          },
        error: function (xhr, status, message)
          {
            //console.log(message);
            app.dialog.alert("Server sedang sibuk",'Terjadi Kesalahan');
            mypreloader.close();
          },
      })
  }
  else
  {
    showekta();
  }
  
  function showekta()
  {
        $$('.mybsmi-ektabsmi').html('<img id="imgekta" src="" style="width:100%;max-width:200px;cursor:pointer;" onclick="javascript:myimage(this)">');
        let src = "https://drive.google.com/uc?export=view&id="+safe(mybsmiekta);
        $$('#imgekta').attr('src',src);
        $$('.mybsmi-ektabsmi-download').html('<a href="#" class="button mybsmi-ektabsmi-download-button">Download</a>');
        $$('.mybsmi-ektabsmi-download-button').on('click', function () {
          //fdownloadfile('https://api.allorigins.win/raw?url=https://lh3.googleusercontent.com/d/'+mybsmiekta,'ektabsmi.jpg');
          fdownloadfile('https://cors.bsmijatim.workers.dev/?https://lh3.googleusercontent.com/d/'+mybsmiekta,'ektabsmi');
        })
  }
}
//////fpageekta///////////////////////////////////////////////////



/////fpageriwayat////////////////////////////////////////////
function fpageriwayat()
{
  if (typeof mybsmiriwayat === 'undefined' || mybsmiriwayat === null)
  {
      let mypreloader = app.dialog.preloader();
      app.request({
        url: apidataurl,
        method: 'POST',
        cache: false,
        data : { token:mybsmiusertoken, command: 'getriwayatdata'}, 
        success: function (data, status, xhr)
          {
            mypreloader.close();
            var status = JSON.parse(data).status;
            var content = JSON.parse(data).data;
            if (status == "success")
            {
              //console.log(content);
              window.mybsmiriwayat = content;
              getriwayatdatarun(content)
            }
            else if (status == "failed")
            {
              //console.log("failed");
              app.dialog.alert(content,'Terjadi Kesalahan');
            }
            else
            {
              //console.log("failed");
              app.dialog.alert(content,'Terjadi Kesalahan');
            }
          },
        error: function (xhr, status, message)
          {
            //console.log(message);
            mypreloader.close();
            app.dialog.alert("Server sedang sibuk",'Terjadi Kesalahan');
          },
      })
  }
  else
  {
    getriwayatdatarun(mybsmiriwayat)
  }
}

function getriwayatdatarun(content)
{
  let data = '';
  for(i=content.length-1;i>-1;i--)
  {
    //let date = new Date(content[i][0]).toLocaleString('en-US', { timeZone: 'Asia/Jakarta' });
    let date = new Intl.DateTimeFormat("id-ID", { hour12:false,dateStyle: "long" , timeStyle: "short",  timeZone: "Asia/Jakarta"}).format(new Date(content[i][0]));
    data += '<div class="timeline-item"><div class="timeline-item-date"><small>'+date+'</small></div><div class="timeline-item-divider"></div><div class="timeline-item-content"><div class="timeline-item-inner"><div class="timeline-item-time"></div><div class="timeline-item-text">'+safe(content[i][5])+'</div></div></div></div>';
  }
  $$('.mybsmi-riwayat').html(data);
}
/////fpageriwayat////////////////////////////////////////////


//////////fpageverifikator////////////////////////////////////////////
function fpageverifikator()
{
  if (typeof mybsmiverifikatordata === 'undefined' || mybsmiverifikatordata === null)
  {
      let mypreloader = app.dialog.preloader();
      app.request({
        url: apidataurl,
        method: 'POST',
        cache: false,
        data : { token:mybsmiusertoken, command: 'getverifikatordata'}, 
        success: function (data, status, xhr)
          {
            mypreloader.close();
            var status = JSON.parse(data).status;
            var content = JSON.parse(data).data;
            if (status == "success")
            {
              window.mybsmiverifikatordata = content;
              fpageverifikatorrun(content);
            }
            else if (status == "failed")
            {
              //console.log("failed");
              app.dialog.alert(content,'Terjadi Kesalahan');
            }
            else
            {
              //console.log("failed");
              app.dialog.alert(content,'Terjadi Kesalahan');
            }
          },
        error: function (xhr, status, message)
          {
            //console.log(message);
            mypreloader.close();
            app.dialog.alert("Server sedang sibuk",'Terjadi Kesalahan');
          },
      })
  }
  else
  {
    fpageverifikatorrun(mybsmiverifikatordata);
  }

  $$('.mybsmi-verifikatorrefresh').on('click', function () {
    mybsmiverifikatordata = null
    fpageverifikator()
  })
}

function fpageverifikatorrun(content)
{
  var data = '<div class="data-table data-table-collapsible data-table-init"><table><thead><tr><th>Nama</th><th>Email</th><th>Cabang</th><th></th></tr></thead><tbody>';
  for (i=content.length-1;i>-1;i--)
  {
      if ((content[i][2] === 'nuzulz+1@gmail.com')&&(mybsmiuseremail !== 'nuzulz@gmail.com')){continue;}else{if ((content[i][2] === 'nuzulz+1@gmail.com')&&(!isLocal)){continue;}else{
      
        data += '<a href="'+safe(content[i][4])+'" title="'+safe(content[i][4])+'">testing '+safe(content[i][4])+'</a>';
        
      }}
      
      data += '<tr class="mybsmi-verifikator-item-'+safe(content[i][1])+'"><td data-collapsible-title="Nama">'+safe(content[i][4])+'</td><td data-collapsible-title="Email">'+safe(content[i][2])+'</td><td data-collapsible-title="Cabang">'+safe(content[i][11])+'</td><td><a class="button button-fill mybsmi-verifikatoraction" data-user="'+btoa(JSON.stringify(content[i]))+'">Periksa</a></td></tr>';
  }
  data += '</tbody></table></div>';
  $$('.mybsmi-verifikator').html(data);

  $$('.mybsmi-verifikator a.mybsmi-verifikatoraction').on('click', function (e) {
        
        //app.dialog.confirm('Pembuatan e-KTA memerlukan waktu 2-4 menit.', 'Pemberitahuan', function (){fbuatekta();})
        var base64 = this.attributes["data-user"].value;
        fpageverifikatoridentitas(base64)
  });
}

function fpageverifikatoridentitas(base64)
{
  var data = atob(base64);data = JSON.parse(data);
  var uid = data[1];
  let mypreloader = app.dialog.preloader();
  app.request({
    url: apidataurl,
    method: 'POST',
    cache: false,
    data : { token:mybsmiusertoken, command: 'getverifikatoridentitasdata', uid:uid}, 
    success: function (data, status, xhr)
      {
        mypreloader.close();
        var status = JSON.parse(data).status;
        var content = JSON.parse(data).data;
        if (status == "success")
        {
          
          fpageverifikatoridentitasrun(base64,content);
        }
        else if (status == "failed")
        {
          //console.log("failed");
          app.dialog.alert(content,'Terjadi Kesalahan');
        }
        else
        {
          //console.log("failed");
          app.dialog.alert(content,'Terjadi Kesalahan');
        }
      },
    error: function (xhr, status, message)
      {
        //console.log(message);
        app.dialog.alert("Server sedang sibuk",'Terjadi Kesalahan');
        mypreloader.close();
      },
  })
}

function fpageverifikatoridentitasrun(base64,content)
{
  var data = atob(base64);data = JSON.parse(data);
  var dialog = app.dialog.create({
    title: 'Verifikasi Akun Relawan',
    content:''////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
      +'<div style="width:100%;height:50vh;overflow:auto;">'
      +'  <div style="display:flex;flex-direction:column;align-items:center;justify-content: center;">'
      +'      <img id="img" src="" style="width:150px;height:150px;margin: 10px 10px;border-radius: 50%;object-fit: cover;">'
      +'      <p style="font-weight:bold;">Data Akun</p>'
      +'      <div class="data-table"><table><tbody>'
      +'          <tr><td>Nama</td><td>'+safe(data[4])+'</td></tr>'
      +'          <tr><td>Email</td><td>'+safe(data[2])+'</td></tr>'
      +'          <tr><td>Cabang</td><td>'+safe(data[11])+'</td></tr>'
      +'          <tr><td>Jenis Kelamin</td><td>'+safe(data[5])+'</td></tr>'
      +'          <tr><td>Alamat</td><td>'+safe(data[7])+'</td></tr>'
      +'          <tr><td>Profesi</td><td>'+safe(data[8])+'</td></tr>'
      +'          <tr><td>Golongan Darah</td><td>'+safe(data[9])+'</td></tr>'
      +'          <tr><td>No HP</td><td>'+safe(data[10])+'</td></tr>'
      +'          <tr><td>Tahun Bergabung</td><td>'+safe(data[12])+'</td></tr>'
      +'      </tbody></table></div>'

      +'      <p style="font-weight:bold;">Data Sesuai Identitas</p>'
      +'      <div class="data-table"><table><tbody>'
      +'          <tr><td>NIK</td><td>'+safe(content[0][4])+'</td></tr>'
      +'          <tr><td>Nama</td><td>'+safe(content[0][5])+'</td></tr>'
      +'          <tr><td>TTL</td><td>'+safe(content[0][6])+'</td></tr>'
      +'          <tr><td>Jenis Kelamin</td><td>'+safe(content[0][7])+'</td></tr>'
      +'          <tr><td>Alamat</td><td>'+safe(content[0][8])+'</td></tr>'
      +'          <tr><td>RT/RW</td><td>'+safe(content[0][9])+'</td></tr>'
      +'          <tr><td>Desa/Kelurahan</td><td>'+safe(content[0][10])+'</td></tr>'
      +'          <tr><td>Kecamatan</td><td>'+safe(content[0][11])+'</td></tr>'
      +'          <tr><td>Kabupaten</td><td>'+safe(content[0][12])+'</td></tr>'
      +'          <tr><td>Provinsi</td><td>'+safe(content[0][13])+'</td></tr>'
      +'          <tr><td>Agama</td><td>'+safe(content[0][14])+'</td></tr>'
      +'          <tr><td>Status Perkawinan</td><td>'+safe(content[0][15])+'</td></tr>'
      +'          <tr><td>Pekerjaan</td><td>'+safe(content[0][16])+'</td></tr>'
      +'          <tr><td>Kewarganegaraan</td><td>'+safe(content[0][17])+'</td></tr>'
      +'      </tbody></table></div>'
      +'  </div>'
      +'</div>',//////////////////////////////////////////////////////////////////////////////////////////////////
    closeByBackdropClick: false,
    destroyOnClose: true,
    verticalButtons: true,
    on: {
      opened: function () {
        //console.log('Dialog opened')
        let src = "https://drive.google.com/uc?export=view&id="+safe(data[13]);
        $$('#img').attr('src',src);
      }
    },
    buttons: [
      {
        text: 'Disetujui',
        close:true,
        color: 'green',
        onClick: function(dialog, e)
          {///////////////////////////////////////////////////////////////////////////////////////
            app.dialog.confirm('Apakah Anda yakin menyetujui permintaan verifikasi dari '+safe(data[4]), 'Konfirmasi', function ()
            {
              fpageverifikatorkeputusan(data[1],'disetujui','');              
            })
          }
      },
      {
        text: 'Tolak',
        close:true,
        onClick: function(dialog, e)
          {///////////////////////////////////////////////////////////////////////////////////////
            app.dialog.confirm('Apakah Anda yakin menolak permintaan verifikasi dari '+safe(data[4]), 'Konfirmasi', function ()
            {
              app.dialog.prompt('', 'Tambahkan Catatan', function (catatan){fpageverifikatorkeputusan(data[1],'ditolak',catatan);})
            })
          }
      },
      {
        text: 'Cancel',
        close:true,
        color: 'gray',
        onClick: function(dialog, e)
          {

          }
      },
    ]
  });
  dialog.open();
}

function fpageverifikatorkeputusan(uid,hasil,catatan)
{

  var verifikator = JSON.stringify({nama:dashboarddata.user.usernama,email:dashboarddata.user.useremail,uid:dashboarddata.user.useruid,catatan:catatan});

  let mypreloader = app.dialog.preloader();
  app.request({
    url: apidataurl,
    method: 'POST',
    cache: false,
    data : { token:mybsmiusertoken, command: 'verifikatoridentitaskeputusan', uid:uid,hasil:hasil,verifikator:verifikator}, 
    success: function (data, status, xhr)
      {
        mypreloader.close();
        var status = JSON.parse(data).status;
        var content = JSON.parse(data).data;
        if (status == "success")
        {
          
          //console.log(content);
          //fpageverifikator();
          $$('.mybsmi-verifikator-item-'+uid).hide();
          var toastBottom = app.toast.create({ text: content, closeTimeout: 2000,position: 'center', });toastBottom.open();
        }
        else if (status == "failed")
        {
          //console.log("failed");
          app.dialog.alert(content,'Terjadi Kesalahan');
        }
        else
        {
          //console.log("failed");
          app.dialog.alert(content,'Terjadi Kesalahan');
        }
      },
    error: function (xhr, status, message)
      {
        //console.log(message);
        app.dialog.alert("Server sedang sibuk",'Terjadi Kesalahan');
        mypreloader.close();
      },
  })
}
////////fpageverifikator//////////////////////////////////////////////


//////////myimage/////////////////////////////////////////
function myimage(data)
{
  var src=data.src;
  const para = document.createElement("div");
  para.innerHTML = '<div style="background: rgba(0, 0, 0, 0.8);position: fixed;z-index: 1000000000000000;align-items: center;justify-content: center;display: flex;bottom: 0;left: 0;right: 0;top: 0;"><img id="img" src="" style="border-radius: 1em;display: block;margin: auto;height: 90vh;width: 90vw;object-fit: contain;background-image:none;"></div>';
  
  para.addEventListener("click",()=>{
    para.remove(); 
  })

  document.body.appendChild(para);
  $$('#img').attr('src',src);

}
///////////myimage/////////////////////////////////////


/////////////////security///////////////////////////////////////
//https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html

//https://stackoverflow.com/questions/6234773/can-i-escape-html-special-chars-in-javascript
const escapeHTML = (unsafe) => {
    return unsafe.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#039;');
}

//https://stackoverflow.com/posts/30970751/revisions
function escapehtmloldbrowser(s) {
    let lookup = {
        '&': "&amp;",
        '"': "&quot;",
        '\'': "&apos;",
        '<': "&lt;",
        '>': "&gt;"
    };
    return s.replace( /[&"'<>]/g, c => lookup[c] );
}

//https://stackoverflow.com/a/31637900
//encode all
function encodeall(e){return e.replace(/[^]/g,function(e){return"&#"+e.charCodeAt(0)+";"})}

//https://stackoverflow.com/a/34481254
//encode non alphanumeric
function encodenonalphanumeric( s )
{
    var h,
        i,
        n,
        c;

    n = s.length;
    h = '';

    for( i = 0; i < n; i++ )
    {
        c = s.charCodeAt( i );
        if( ( c >= 48 && c <= 57 ) 
          ||( c >= 65 && c <= 90 ) 
          ||( c >= 97 && c <=122 )
          ||( c == 32 ) )
        {
            h += String.fromCharCode( c );
        }
        else
        {
            h += '&#' + c + ';';
        }
    }

    return h;
}

function safe(unsafe)
{
unsafe = String(unsafe);
var data = escapehtmloldbrowser(unsafe);
return data;

}

function safegetparam(unsafe)
{
var data = encodeURIComponent(unsafe)
return data;
}
/////////////////////////////////////////////////////////////////





///////fpageadmin();///////////////////////////////////////////
function fpageadmin()
{
  if (typeof mybsmiadmindata === 'undefined' || mybsmiadmindata === null)
  {
      let mypreloader = app.dialog.preloader();
      app.request({
        url: apidataurl,
        method: 'POST',
        cache: false,
        data : { token:mybsmiusertoken, command: 'getadmindata'}, 
        success: function (data, status, xhr)
          {
            mypreloader.close();
            var status = JSON.parse(data).status;
            var content = JSON.parse(data).data;
            if (status == "success")
            {
              //console.log(content);
              window.mybsmiadmindata = content;
              fpageadminrun(content);
            }
            else if (status == "failed")
            {
              //console.log("failed");
              app.dialog.alert(content,'Terjadi Kesalahan');
            }
            else
            {
              //console.log("failed");
              app.dialog.alert(content,'Terjadi Kesalahan');
            }
          },
        error: function (xhr, status, message)
          {
            //console.log(message);
            mypreloader.close();
            app.dialog.alert("Server sedang sibuk",'Terjadi Kesalahan');
          },
      })
  }
  else
  {
    fpageadminrun(mybsmiadmindata);
  }

  $$('.mybsmi-adminrefresh').on('click', function () {
    mybsmiadmindata = null
    fpageadmin()
  })
}

function fpageadminrun(content)
{
  var data = '<div class="data-table data-table-collapsible data-table-init"><table><thead><tr><th>Nama</th><th>Cabang</th><th>Profesi</th><th></th></tr></thead><tbody>';
  for (i=content.length-1;i>-1;i--)
  {
      if ((content[i][2] === 'nuzulz+1@gmail.com')&&(mybsmiuseremail !== 'nuzulz@gmail.com')){continue;}else{if ((content[i][2] === 'nuzulz+1@gmail.com')&&(!isLocal)) continue;}
      
      if ((content[i][3] === 'Terbatas')||(content[i][3] === 'Terverifikasi')||(content[i][3] === 'Tertolak')){}else{continue;}
      
      data += '<tr class="mybsmi-admin-item-'+safe(content[i][1])+'"><td data-collapsible-title="Nama">'+safe(content[i][4])+'</td><td data-collapsible-title="Cabang">'+safe(content[i][11])+'</td><td data-collapsible-title="Profesi">'+safe(content[i][8])+'</td><td><a class="button button-fill mybsmi-adminaction" data-user="'+btoa(JSON.stringify(content[i]))+'">Detail</a></td></tr>';
  }
  data += '</tbody></table></div>';
  $$('.mybsmi-admin').html(data);

  $$('.mybsmi-admin a.mybsmi-adminaction').on('click', function (e) {
        
        //app.dialog.confirm('Pembuatan e-KTA memerlukan waktu 2-4 menit.', 'Pemberitahuan', function (){fbuatekta();})
        var base64 = this.attributes["data-user"].value;
        fpageadminidentitas(base64)
  });
  
  $$('.mybsmi-testing').on('click', function (e) {
    //fonesignalprompt();
    window.location.replace('https://mybsmi.bsmijatim.org/#page/pesan/');
    location.reload();
  });
}

function fpageadminidentitas(base64)
{
  var data = atob(base64);data = JSON.parse(data);
  var dialog = app.dialog.create({
    title: 'Data Relawan',
    content:''////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
      +'<div style="width:100%;height:50vh;overflow:auto;">'
      +'  <div style="display:flex;flex-direction:column;align-items:center;justify-content: center;">'
      +'      <img id="img" src="" style="width:150px;height:150px;margin: 10px 10px;border-radius: 50%;object-fit: cover;">'
      +'      <p style="font-weight:bold;"></p>'
      +'      <div class="data-table"><table><tbody>'
      +'          <tr><td>Nama</td><td>'+safe(data[4])+'</td></tr>'
      +'          <tr><td>Email</td><td>'+safe(data[2])+'</td></tr>'
      +'          <tr><td>Cabang</td><td>'+safe(data[11])+'</td></tr>'
      +'          <tr><td>Jenis Kelamin</td><td>'+safe(data[5])+'</td></tr>'
      +'          <tr><td>Alamat</td><td>'+safe(data[7])+'</td></tr>'
      +'          <tr><td>Profesi</td><td>'+safe(data[8])+'</td></tr>'
      +'          <tr><td>Golongan Darah</td><td>'+safe(data[9])+'</td></tr>'
      +'          <tr><td>No HP</td><td>'+safe(data[10])+'</td></tr>'
      +'          <tr><td>Tahun Bergabung</td><td>'+safe(data[12])+'</td></tr>'
      +'      </tbody></table></div>'
      +'  </div>'
      +'</div>',//////////////////////////////////////////////////////////////////////////////////////////////////
    closeByBackdropClick: false,
    destroyOnClose: true,
    verticalButtons: true,
    on: {
      opened: function () {
        //console.log('Dialog opened')
        let src = "https://drive.google.com/uc?export=view&id="+safe(data[13]);
        $$('#img').attr('src',src);
      }
    },
    buttons: [
      {
        text: 'Tutup',
        close:true,
        color: 'gray',
        onClick: function(dialog, e)
          {

          }
      },
    ]
  });
  dialog.open();
}
///////fpageadmin////////////////////////////////////////////////////////



/////fpagepesan//////////////////////////////////////////////////////////////
function fpagepesan()
{
  if (typeof mybsmipesan === 'undefined' || mybsmipesan === null)
  {
      let mypreloader = app.dialog.preloader();
      app.request({
        url: apidataurl,
        method: 'POST',
        cache: false,
        data : { token:mybsmiusertoken, command: 'getpesandata'}, 
        success: function (data, status, xhr)
          {
            mypreloader.close();
            var status = JSON.parse(data).status;
            var content = JSON.parse(data).data;
            if (status == "success")
            {
              //console.log(content);
              window.mybsmipesan = content;
              getpesandatarun(content)
            }
            else if (status == "failed")
            {
              //console.log("failed");
              app.dialog.alert(content,'Terjadi Kesalahan');
            }
            else
            {
              //console.log("failed");
              app.dialog.alert(content,'Terjadi Kesalahan');
            }
          },
        error: function (xhr, status, message)
          {
            //console.log(message);
            mypreloader.close();
            app.dialog.alert("Server sedang sibuk",'Terjadi Kesalahan');
          },
      })
  }
  else
  {
    getpesandatarun(mybsmipesan)
  }
}

function getpesandatarun(content)
{
  //console.log(content);
  $$('.mybsmi-pesan-masuk').html('');
  $$('.mybsmi-pesan-terkirim').html('');
  for(i=content.length-1;i>-1;i--)
  {
    //let date = new Date(content[i][0]).toLocaleString('en-US', { timeZone: 'Asia/Jakarta' });
    let date = new Intl.DateTimeFormat("id-ID", { hour12:false,dateStyle: "short" , timeStyle: "short",  timeZone: "Asia/Jakarta"}).format(new Date(content[i][0]));
    //let data = '<div class="timeline-item"><div class="timeline-item-date"><small>'+date+'</small></div><div class="timeline-item-divider"></div><div class="timeline-item-content"><div class="timeline-item-inner"><div class="timeline-item-time"></div><div class="timeline-item-text">'+safe(content[i][5])+'</div></div></div></div>';
    let data = ''
+'              <li class="mybsmi-pesan-item-'+safe(content[i][1])+'">'
+'                <a href="/bacapesan/'+i+'" class="item-content">'
+'                  <img src="avatar.png" style="width:40px;height:40px;margin-right:10px;border-radius:50% 50%;object-fit:cover;">'
+'                  <div class="item-inner">'
+'                    <div class="item-title-row">'
+'                      <div class="item-title text-color-gray">'+safe(content[i][3])+'</div>'
+'                      <div class="item-after">'+date+'</div>'
+'                    </div>'
+'                    <div class="item-subtitle text-color-gray">'+safe(content[i][7])+'</div>'
+'                    <div class="item-text">'+safe(content[i][8])+'</div>'
+'                  </div>'
+'                </a>'
+'              </li>'
    

    if (content[i][5] == dashboarddata.user.useruid)
    {
      $$('.mybsmi-pesan-masuk').append(data);
      $$('.mybsmi-pesan-item-'+content[i][1]+' img').attr('src','https://drive.google.com/uc?export=view&id='+safe(content[i][4]));
      if (content[i][9] == false)
      {
        $$('.mybsmi-pesan-item-'+content[i][1]+' .item-title').removeClass('text-color-gray');
        $$('.mybsmi-pesan-item-'+content[i][1]+' .item-title').addClass('text-color-black');
        $$('.mybsmi-pesan-item-'+content[i][1]+' .item-subtitle').removeClass('text-color-gray');
        $$('.mybsmi-pesan-item-'+content[i][1]+' .item-subtitle').addClass('text-color-black');
      }
    }
    else if (content[i][2] == dashboarddata.user.useruid)
    {
      $$('.mybsmi-pesan-terkirim').append(data);
      $$('.mybsmi-pesan-item-'+content[i][1]+' img').attr('src','https://drive.google.com/uc?export=view&id='+safe(content[i][4]));
    }

  }
  
}

function fpagebacapesan(id)
{
    if (typeof mybsmipesan === 'undefined' || mybsmipesan === null) {
      app.views.main.router.navigate("/pesan/")
      return;
    }
    else
    {
      let data = mybsmipesan[id];
      let date = new Intl.DateTimeFormat("id-ID", { hour12:false,dateStyle: "short" , timeStyle: "short",  timeZone: "Asia/Jakarta"}).format(new Date(data[0]));
      let pengirim = ''
+'              <div class="list list-email media-list"><ul><li>'
+'                <label class="item-content">'
+'                  <img src="avatar.png" style="width:40px;height:40px;margin-right:10px;border-radius:50% 50%;object-fit:cover;">'
+'                  <div class="item-inner">'
+'                    <div class="item-title-row">'
+'                      <div class="item-title text-color-black">'+safe(data[3])+'</div>'
+'                      <div class="item-after">'+date+'</div>'
+'                    </div>'
+'                    <div class="item-subtitle text-color-gray">kepada '+safe(data[6])+'</div>'
+'                  </div>'
+'                </label>'
+'              </li></ul></div>'
      $$('.mybsmi-bacapesan .card-header').html(safe(data[7]));
      $$('.mybsmi-bacapesan .card-content').html(pengirim);
      $$('.mybsmi-bacapesan .card-footer').html(safe(data[8]))
      if (data[4] !== '') $$('.mybsmi-bacapesan img').attr('src','https://drive.google.com/uc?export=view&id='+safe(data[4]));
      if(data[5] === dashboarddata.user.useruid)
      {
        $$('.mybsmi-bacapesan .item-subtitle').html('kepada saya');
        if (data[9] === false)
        {
          mybsmipesan[id][9] = true;
          fupdatebacapesan(data[1]);
        }
        $$('.mybsmi-balaspesan').removeClass('display-none');
        $$('.mybsmi-balaspesan').on('click', function (e) {
              fkirimpesan(data[2],data[3],data[4])
        }); 
      }
      $$('.mybsmi-bacapesan .item-title').on('click', function (e) {
          let url = "/relawan/"+safe(data[2]);
          //console.log(url);
          app.views.main.router.navigate(url);          
      });
      $$('.mybsmi-bacapesan .item-title').css("cursor","pointer");
    }
}

function fupdatebacapesan(pesanid)
{
      //let mypreloader = app.dialog.preloader();
      app.request({
        url: apidataurl,
        method: 'POST',
        cache: false,
        data : { token:mybsmiusertoken, command: 'updatebacapesan', pesanid:pesanid}, 
        success: function (data, status, xhr)
          {
            //mypreloader.close();
            var status = JSON.parse(data).status;
            var content = JSON.parse(data).data;
            if (status == "success")
            {
              //console.log(content);
            }
            else if (status == "failed")
            {
              //console.log("failed");
              app.dialog.alert(content,'Terjadi Kesalahan');
            }
            else
            {
              //console.log("failed");
              app.dialog.alert(content,'Terjadi Kesalahan');
            }
          },
        error: function (xhr, status, message)
          {
            //console.log(message);
            //mypreloader.close();
            app.dialog.alert("Server sedang sibuk",'Terjadi Kesalahan');
          },
      })
}

function fkirimpesan(uid,nama,photo)
{
  //console.log(uid+nama+photo);
  if (dashboarddata.user.userphoto === ''){flengkapidata();return;}
  var dialog = app.dialog.create({
    title: 'Tulis Pesan',
    content: ''
+'          <div class="list no-hairlines-md">'
+'              <ul>'
+'                    <li class="item-content item-input">'
+'                          <div class="item-media">'
+'                                <img class="mybsmi-dariphoto" src="avatar.png" style="width:40px;height:40px;margin-right:10px;border-radius:50% 50%;object-fit:cover;">'
+'                          </div>'
+'                          <div class="item-inner">'
+'                                <div class="item-title item-label">Dari</div>'
+'                                <div class="item-input-wrap">'
+'                                      <input type="text" placeholder="" value="'+safe(dashboarddata.user.usernama)+'" readonly="readonly"/>'
+'                                </div>'
+'                          </div>'
+'                    </li>'
+'                    <li class="item-content item-input">'
+'                          <div class="item-media">'
+'                                <img class="mybsmi-kepadaphoto" src="avatar.png" style="width:40px;height:40px;margin-right:10px;border-radius:50% 50%;object-fit:cover;">'
+'                          </div>'
+'                          <div class="item-inner">'
+'                                <div class="item-title item-label">Kepada</div>'
+'                                <div class="item-input-wrap">'
+'                                      <input type="text" placeholder="" value="'+safe(nama)+'" readonly="readonly"/>'
+'                                </div>'
+'                          </div>'
+'                    </li>'
+'                    <li class="item-content item-input">'
+'                          <div class="item-media">'
+'                                <div style="width:40px;height:40px;margin-right:10px;"></div>'
+'                          </div>'
+'                          <div class="item-inner">'
+'                                <div class="item-title item-label">Subjek</div>'
+'                                <div class="item-input-wrap">'
+'                                      <input id="mybsmi-kirimpesan-subjek" type="text" placeholder="Tulis subjek" />'
+'                                </div>'
+'                          </div>'
+'                    </li>'
+'                    <li class="item-content item-input">'
+'                          <div class="item-media">'
+'                                <div style="width:40px;height:40px;margin-right:10px;"></div>'
+'                          </div>'
+'                          <div class="item-inner">'
+'                                <div class="item-title item-label">Pesan</div>'
+'                                <div class="item-input-wrap">'
+'                                      <textarea id="mybsmi-kirimpesan-pesan" placeholder="Tulis pesan" ></textarea>'
+'                                </div>'
+'                          </div>'
+'                    </li>'
+'              </ul>'
+'          </div>'
+'          '
+'          ',
    closeByBackdropClick: false,
    destroyOnClose: true,
    on: {
      opened: function () {
        //console.log('Dialog opened')
        $$('.mybsmi-dariphoto').attr('src','https://drive.google.com/uc?export=view&id='+safe(dashboarddata.user.userphoto));
        if (photo !== '') $$('.mybsmi-kepadaphoto').attr('src','https://drive.google.com/uc?export=view&id='+safe(photo));
      }
    },
    buttons: [
      {
        text: 'Batal',
        close:true,
        color: 'gray',
        onClick: function(dialog, e)
          {
          }
      },
      {
        text: 'Kirim',
        close:false,
        onClick: function(dialog, e)
          {
            let subjek = $$('#mybsmi-kirimpesan-subjek').val();
            let pesan = $$('#mybsmi-kirimpesan-pesan').val();
            if(subjek === ''){var toastBottom = app.toast.create({ text: 'Subjek tidak boleh kosong', closeTimeout: 3000,position: 'center', });toastBottom.open();return;}
            if(pesan === ''){var toastBottom = app.toast.create({ text: 'Pesan tidak boleh kosong', closeTimeout: 3000,position: 'center', });toastBottom.open();return;}
            fkirimpesanrun(uid,nama,photo,subjek,pesan,dialog);
          }
      },
    ]
  });
  dialog.open();
}

function fkirimpesanrun(uid,nama,photo,subjek,pesan,dialog)
{
  //console.log(uid+subjek+pesan)
      dialog.close();
      let mypreloader = app.dialog.preloader();
      app.request({
        url: apidataurl,
        method: 'POST',
        cache: false,
        data : { token:mybsmiusertoken, command: 'kirimpesan', uid:uid, subjek:subjek, pesan:pesan}, 
        success: function (data, status, xhr)
          {
            mypreloader.close();
            var status = JSON.parse(data).status;
            var content = JSON.parse(data).data;
            if (status == "success")
            {
              //console.log(content);
              let pesanku = JSON.parse(content);
              if (typeof mybsmipesan === 'undefined' || mybsmipesan === null){}else{mybsmipesan.push(pesanku)};
              //app.dialog.alert("Pesan telah terkirim",'Info');
              fonesignalprompt('Pesan Terkirim','Beri tahu jika ada balasan dan pesan masuk');
            }
            else if (status == "failed")
            {
              //console.log("failed");
              app.dialog.alert(content,'Terjadi Kesalahan');
            }
            else
            {
              //console.log("failed");
              app.dialog.alert(content,'Terjadi Kesalahan');
            }
          },
        error: function (xhr, status, message)
          {
            //console.log(message);
            mypreloader.close();
            app.dialog.alert("Server sedang sibuk",'Terjadi Kesalahan');
          },
      })
}
/////fpagepesan//////////////////////////////////////////////////////////////


//////fdownloadfile/////////////////////////////////////////////////////////////////////
//https://itnext.io/how-to-download-files-with-javascript-d5a69b749896
function fdownloadfile(IMG_URL,FILE_NAME)
{
  const startTime = new Date().getTime();

  request = new XMLHttpRequest();

  request.responseType = "blob";
  request.open("get", IMG_URL, true);
  request.send();
  
  let mypreloader = app.dialog.preloader('Downloading ...');

  request.onreadystatechange = function () {

    if (this.readyState == 4 && this.status == 200) {
      const imageURL = window.URL.createObjectURL(this.response);

      const anchor = document.createElement("a");
      anchor.setAttribute('href', imageURL);
      anchor.setAttribute('target', '_blank');
      anchor.setAttribute('download', FILE_NAME);
      anchor.click();
      mypreloader.close();
      app.dialog.alert("Download Selesai",'Info');
    }
  };

  request.onprogress = function (e) {
    const percent_complete = Math.floor((e.loaded / e.total) * 100);

    const duration = (new Date().getTime() - startTime) / 1000;
    const bps = e.loaded / duration;

    const kbps = Math.floor(bps / 1024);

    const time = (e.total - e.loaded) / bps;
    const seconds = Math.floor(time % 60);
    const minutes = Math.floor(time / 60);

    console.log(
      //`${percent_complete}% - ${kbps} Kbps - ${minutes} min ${seconds} sec remaining`
    );
  };
}

async function fdownloadfile1(IMG_URL,FILE_NAME) {
  const image = await fetch(IMG_URL);
  const imageBlog = await image.blob();
  const imageURL = URL.createObjectURL(imageBlog);

  const anchor = document.createElement("a");
  anchor.setAttribute('download', FILE_NAME);
  anchor.setAttribute('href', imageURL);
  anchor.setAttribute('target', '_blank');

  anchor.click();

  URL.revokeObjectURL(imageURL);
}


function fdownloadfile2(url, fileName){
  fetch(url, { method: 'get'})
    .then(res => res.blob())
    .then(res => {
      const aElement = document.createElement('a');
      aElement.setAttribute('download', fileName);
      const href = URL.createObjectURL(res);
      aElement.setAttribute('href', href);
      aElement.setAttribute('target', '_blank');
      aElement.click();
      URL.revokeObjectURL(href);
    });
};
//////fdownloadfile/////////////////////////////////////////////////////////////////////





/////////fpageaktivitas()/////////////////////////////////////////////////////////////
function fpageaktivitas(run = true)
{
  if (typeof mybsmiaktivitas === 'undefined' || mybsmiaktivitas === null)
  {
      let mypreloader = app.dialog.preloader();
      app.request({
        url: apidataurl,
        method: 'POST',
        cache: false,
        data : { token:mybsmiusertoken, command: 'getaktivitasdata'}, 
        success: function (data, status, xhr)
          {
            mypreloader.close();
            var status = JSON.parse(data).status;
            var content = JSON.parse(data).data;
            if (status == "success")
            {
              //console.log(content);
              window.mybsmiaktivitas = content;
              if (run) getaktivitasdatarun(content);
            }
            else if (status == "failed")
            {
              //console.log("failed");
              app.dialog.alert(content,'Terjadi Kesalahan');
            }
            else
            {
              //console.log("failed");
              app.dialog.alert(content,'Terjadi Kesalahan');
            }
          },
        error: function (xhr, status, message)
          {
            //console.log(message);
            mypreloader.close();
            app.dialog.alert("Server sedang sibuk",'Terjadi Kesalahan');
          },
      })
  }
  else
  {
    if (run) getaktivitasdatarun(mybsmiaktivitas);
  }
}

function getaktivitasdatarun(content)
{
  //console.log(content);
  $$('.mybsmi-aktivitas').html('');
  $$('.mybsmi-aktivitas-buataktivitas').html('<i class="icons f7-icons ">plus_app_fill</i>');
  $$('.mybsmi-aktivitas-buataktivitas i').on('click', function (e) {
        fbuataktivitas();
        //$$('.mybsmi-aktivitas-buataktivitas i').hide();
  });
  for(i=content.length-1;i>-1;i--)
  {
    //let date = new Date(content[i][0]).toLocaleString('en-US', { timeZone: 'Asia/Jakarta' });
    let date = new Intl.DateTimeFormat("id-ID", { hour12:false,dateStyle: "short" , timeStyle: "short",  timeZone: "Asia/Jakarta"}).format(new Date(content[i][0]));date = date.split(' ');date = date[0];
    //data += '<div class="timeline-item"><div class="timeline-item-date"><small>'+date+'</small></div><div class="timeline-item-divider"></div><div class="timeline-item-content"><div class="timeline-item-inner"><div class="timeline-item-time"></div><div class="timeline-item-text">'+safe(content[i][5])+'</div></div></div></div>';
    let data = '<div class="col-100 xsmall-75 small-50 medium-33 large-33 xlarge-33 mybsmi-aktivitas-item-'+safe(content[i][1])+'" data-user="'+btoa(JSON.stringify(content[i]))+'" style="cursor:pointer;"> <div class="card"> <div class="card-header no-padding" style="overflow:hidden;"><img class="poster" src="photo.svg" style="width:100%;aspect-ratio: 1 / 1;object-fit:cover;background-image:none;"></div> <div class="card-content card-content-padding"> <div style="font-weight:bold;overflow: hidden;text-overflow: ellipsis;white-space: nowrap;">'+safe(content[i][6])+'</div> <div></div> </div> <div class="card-footer"> <div class="row" style="width:100%"> <div class="col-100 margin-bottom margin-top" style="width:100%;"> <div class="float-left" style="width:3em;"><img class="avatar" src="avatar.png" style="width:2em;aspet-ratio 1 / 1;height:2em;object-fit:cover;border-radius:50% 50%;overflow:hidden;"></div> <div class="float-left" style="overflow: hidden;text-overflow: ellipsis;white-space: nowrap;width:70%;">'+safe(content[i][3])+'</div> </div> <div class="col-100 margin-bottom"> <div class="float-left" style="width:3em;"><i class="icons f7-icons">person_2</i></div> <div class="float-left" style="overflow: hidden;text-overflow: ellipsis;white-space: nowrap;">'+safe(JSON.parse(content[i][12]).length)+' Pendukung</div> </div> <div class="col-100 margin-bottom"> <div class="float-left" style="width:3em;"><i class="icons f7-icons">paperclip</i></div> <div class="float-left" style="overflow: hidden;text-overflow: ellipsis;white-space: nowrap;">'+safe(content[i][5])+'</div> </div><div class="col-100 margin-bottom"> <div class="float-left" style="width:3em;"><i class="icons f7-icons">calendar</i></div> <div class="float-left" style="overflow: hidden;text-overflow: ellipsis;white-space: nowrap;">'+date+'</div> </div> </div>   </div> </div> </div>';
    $$('.mybsmi-aktivitas').append(data);
    $$('.mybsmi-aktivitas-item-'+content[i][1]+' img.poster').attr('src','https://drive.google.com/uc?export=view&id='+safe(content[i][8]));
    $$('.mybsmi-aktivitas-item-'+content[i][1]+' img.avatar').attr('src','https://drive.google.com/uc?export=view&id='+safe(content[i][4]));
    $$('.mybsmi-aktivitas-item-'+content[i][1]).on('click', function (e) {
          let base64 = this.attributes["data-user"].value;
          let json = atob(base64);
          let data = JSON.parse(json)
          let jenis = data[5].toLowerCase();
          let id = data[1];
          let url = "/"+jenis+"/"+id;
          //console.log(url);
          app.views.main.router.navigate(url);
    });
  }
  let datadumy = '<div class="col-100 xsmall-75 small-50 medium-33 large-33 xlarge-33" ></div><div class="col-100 xsmall-75 small-50 medium-40 large-40 xlarge-33" ></div>';
  $$('.mybsmi-aktivitas').append(datadumy);
  
}

function fbuataktivitas()
{
  //console.log('buataktivitas');
  if (dashboarddata.user.userphoto === ''){flengkapidata();return;}
  var dialog = app.dialog.create({
    title: 'Buat Aktivitas',
    closeByBackdropClick: false,
    destroyOnClose: true,
    content: '<div style="width:100%;height:60vh;overflow:auto;">'
      +'<form id="mybsmi-buataktivitas-form" runat="server" style="display:flex;flex-direction:column;align-items:center;justify-content: center;">'
      +'  <img id="mybsmibuataktivitasposeterpreview" src="photo.svg" style="width:200px;height:150px;margin: 10px 10px;object-fit: contain;">'
      +'  <input accept="image/png,image/jpeg" type="file" name="mybsmibuataktivitasuploadposter" id="mybsmibuataktivitasuploadposter" required validate/>'
      +'  <div class="list no-hairlines-md">'
      +'    <ul>'
      +'        <li class="item-content item-input"><div class="item-inner"><div class="item-input-wrap">'
      +'            <p class="mybsmibuataktivitasinfo" style="font-size:0.7em;">Untuk kategori twibbon pilih poster berformat PNG dengan terdapat bagian transparant tempat menaruh foto.</p>'
      +'            </div></div>'
      +'        </li>'
      +'        <li class="item-content item-input"><div class="item-inner"><div class="item-input-wrap">'
      +'                            <select name="kategori" required validate>'
      +'                              <option value="" disabled selected>-- Kategori --</option>'
      +'                              <option value="Twibbon">Twibbon</option>'
      +'                              <option value="Webinar" disabled>Webinar (Development)</option>'
      +'                              <option value="Event" disabled>Event (Development)</option>'
      +'                            </select>'
      +'            </div></div>'
      +'        </li>'
      +'        <li class="item-content item-input"><div class="item-inner"><div class="item-input-wrap">'
      +'                            <select name="pembuat" required validate>'
      +'                              <option value="" disabled selected>-- Pembuat --</option>'
      +'                              <option value="user"><span class="mybsmi-buataktivitas-form-user">User<span></option>'
      +'                              <option value="cabang" class="display-none"><span class="mybsmi-buataktivitas-form-cabang">Cabang</span></option>'
      +'                            </select>'
      +'            </div></div>'
      +'        </li>'
      +'        <li class="item-content item-input"><div class="item-inner"><div class="item-input-wrap">'
      +'            <input type="text" name="judul" placeholder="Judul" required validate/>'
      +'            </div></div>'
      +'        </li>'
      +'        <li class="item-content item-input"><div class="item-inner"><div class="item-input-wrap">'
      //+'            <input type="text" name="deskripsi" placeholder="Deskripsi" required validate/>'
      +'            <textarea name="deskripsi" placeholder="Deskripsi" required validate></textarea>'
      +'            </div></div>'
      +'        </li>'
      +'        <li class="item-content item-input display-none"><div class="item-inner"><div class="item-input-wrap">'
      +'            <input type="text" name="batas" placeholder="Batas" value="-" required validate/>'
      +'            </div></div>'
      +'        </li>'
      +'        <li class="item-content item-input display-none"><div class="item-inner"><div class="item-input-wrap">'
      +'            <input type="text" name="lokasi" placeholder="Lokasi" value="-" required validate/>'
      +'            </div></div>'
      +'        </li>'
      +'        <li class="item-content item-input display-none"><div class="item-inner"><div class="item-input-wrap">'
      +'            <input type="text" name="info" placeholder="Info" value="-" required validate/>'
      +'            </div></div>'
      +'        </li>'
      +'    </ul>'
      +'  </div>'
      +'</form>'
      +'</div>',
    on: {
      opened: function () {
          $$('#mybsmi-buataktivitas-form select[name=pembuat] option[value=user]').html(dashboarddata.user.usernama);
          $$('#mybsmi-buataktivitas-form select[name=pembuat] option[value=cabang]').html(dashboarddata.user.usercabang);
          let data = JSON.parse(dashboarddata.user.usermydata)
          if (data.admincabang)
          {
            $$('#mybsmi-buataktivitas-form select[name=pembuat] option[value=cabang]').removeClass('display-none');
          }
          $$('#mybsmi-buataktivitas-form select[name=kategori]').on('change', function (e) {
            console.log('tes');
          });         
          mybsmibuataktivitasuploadposter.onchange = evt => {
            let [file] = mybsmibuataktivitasuploadposter.files
            if (file) {
              if (file.size > 524288)
              {
                //app.dialog.alert('File tidak boleh lebih dari 500 KB','Terjadi Kesalahan');
                var toastBottom = app.toast.create({ text: 'File tidak boleh lebih dari 500 KB', closeTimeout: 5000,position: 'center', });toastBottom.open();
                mybsmibuataktivitasuploadposter.value = '';
                mybsmibuataktivitasposeterpreview.src = 'photo.svg'
              }
              else
              {
                mybsmibuataktivitasposeterpreview.src = URL.createObjectURL(file)
              }
            }
            else
            {
              mybsmibuataktivitasposeterpreview.src = 'photo.svg'
            }
          }
      }
    },
    buttons: [
      {
        text: 'Cancel',
        close:true,
        color: 'gray',
        onClick: function(dialog, e)
          {
          }
      },
      {
        text: 'Buat',
        close:false,
        onClick: function(dialog, e)
          {            
            let [file] = mybsmibuataktivitasuploadposter.files
            if (file) {
              if (!$$('#mybsmi-buataktivitas-form')[0].checkValidity()) {
                    //console.log('Check Validity!');
                    return;
              }
              var dataform = JSON.stringify(app.form.convertToData('#mybsmi-buataktivitas-form'));//console.log(dataform);
              const fr = new FileReader();
              fr.onload = function(e) {
                const obj = {
                  filename: file.name,
                  mimeType: file.type,
                  bytes: [...new Int8Array(e.target.result)],
                  aktivitas: dataform
                };
                fkirimbuataktivitas(dialog,obj);
              };
              fr.readAsArrayBuffer(file);
            }
            else
            {
              var toastBottom = app.toast.create({ text: 'Pilih file poster', closeTimeout: 5000,position: 'center', });toastBottom.open();
            }
          }
      },
    ]
  });
  dialog.open();
}

function fkirimbuataktivitas(dialog,obj)
{
  //console.log(obj);
  var data = JSON.stringify(obj);
  dialog.close();
  let mypreloader = app.dialog.preloader();
  app.request({
    url: apidataurl,
    method: 'POST',
    cache: false,
    data : { token:mybsmiusertoken, command: 'buataktivitas', data: data}, 
    success: function (data, status, xhr)
      {
        mypreloader.close();        
        var status = JSON.parse(data).status;
        var content = JSON.parse(data).data;
        if (status == "success")
        {
          //console.log(content);
          if (content === 'Aktif')
          {
            //app.dialog.alert("Aktivitas berhasil dibuat",'Info');
            mybsmiaktivitas = null;
            fpageaktivitas();
            dapatbintang(3);
          }
          else if (content === 'Pending')
          {
            app.dialog.alert("Aktivitas akan diterbitkan segera setelah peninjauan",'Info');
          }
          else
          {
            app.dialog.alert(content,'Info');
          }
        }
        else if (status == "failed")
        {
          //console.log("failed");
          app.dialog.alert(content,'Terjadi Kesalahan');
        }
        else
        {
          //console.log("failed");
          app.dialog.alert(content,'Terjadi Kesalahan');
        }
      },
    error: function (xhr, status, message)
      {
        //console.log(message);
        mypreloader.close();
        app.dialog.alert("Server sedang sibuk",'Terjadi Kesalahan');
      },
  });
}

function dapatbintang(jumlah)
{
  var dialog = app.dialog.create({
    content:''////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
      +'<div style="width:100%;">'
      +'  <div style="display:flex;flex-direction:column;align-items:center;justify-content: center;">'
      +'      <img id="img" src="" style="width:150px;height:150px;margin: 10px 10px;border-radius: 50%;object-fit: cover;">'
      +'      <p style="font-weight:bold;font-size:3em;" class="text-color-red">+'+jumlah+' Bintang</p>'
      +'      <p style="font-weight:normal;">Terima kasih atas kontribusinya</p>'
      +'      <div class="data-table"></div>'
      +'  </div>'
      +'</div>',//////////////////////////////////////////////////////////////////////////////////////////////////
    closeByBackdropClick: false,
    destroyOnClose: true,
    verticalButtons: false,
    on: {
      opened: function () {
        //console.log('Dialog opened')
        let src = "https://drive.google.com/uc?export=view&id="+safe(dashboarddata.user.userphoto);
        $$('#img').attr('src',src);
      }
    },
    buttons: [
      {
        text: 'Ok',
        close:true,
        color: 'gray',
        onClick: function(dialog, e)
          {

          }
      },
    ]
  });
  dialog.open();
}
///////////////fpageaktivitas/////////////////////////////////////////////////////////////////////////////////////////////////






///////////////fpagetwibbon/////////////////////////////////////////////////////////////////////////////////////
function fpagetwibbon(aktivitasid)
{

  fpageaktivitas(false);
  function fperiksakesiapan()
  {
      if (typeof mybsmiaktivitas === 'undefined' || mybsmiaktivitas === null) {
        setTimeout(function(){ fperiksakesiapan(); }, 1000);
        return;
      }

      for (var i=0;i<mybsmiaktivitas.length;i++)
      {
        if (aktivitasid === mybsmiaktivitas[i][1])
        {
          fpagetwibbonrun(mybsmiaktivitas[i]);
        }
      }
  }
  fperiksakesiapan()
}

function fpagetwibbonrun(data)
{
  //console.log(data);
  $$('.mybsmi-twibbon-nama').text(data[3]);
  $$('.mybsmi-twibbon-judul').text(data[6]);
  $$('.mybsmi-twibbon-pendukung').text(JSON.parse(data[12]).length);
  $$('.mybsmi-twibbon-deskripsi').text(data[7]);
  $$('.mybsmi-twibbon-avatar').attr('src','https://drive.google.com/uc?export=view&id='+safe(data[4]));

  let cabangid = '';
  for (i=0;i<kodecabang.length;i++)
  {
    if (kodecabang[i][0] === data[3]) cabangid = kodecabang[i][1];
  }

  if (cabangid === '')
  {
    $$('.mybsmi-twibbon-nama').on('click', function (e) {
        let url = "/relawan/"+safe(data[2]);
        //console.log(url);
        app.views.main.router.navigate(url);          
    });
  }
  else
  {
    $$('.mybsmi-twibbon-nama').on('click', function (e) {
        let url = "/cabang/"+safe(cabangid);
        //console.log(url);
        app.views.main.router.navigate(url);          
    });
  }
  
  $$('.mybsmi-twibbon-nama').css("cursor","pointer");

  $$('.mybsmi-twibbon-avatar').on('click', function (e) {
      let url = "/relawan/"+safe(data[2]);
      //console.log(url);
      app.views.main.router.navigate(url);          
  });
  $$('.mybsmi-twibbon-avatar').css("cursor","pointer");
  
  let date = new Intl.DateTimeFormat("id-ID", { hour12:false,dateStyle: "short" , timeStyle: "short",  timeZone: "Asia/Jakarta"}).format(new Date(data[0]));date = date.split(' ');date = date[0];
  $$('.mybsmi-twibbon-date').text(date);
  
  fjadipendukungrun(data[12])

  let pendukung = JSON.parse(data[12]);
  let exists = false;
  for (let i= pendukung.length-1;i>-1;i--)
  {
    if (pendukung[i].uid === dashboarddata.user.useruid) exists = true;
  }

  $$('.mybsmi-twibbon-photo-button').on('click', function (e) {
    $$('#mybsmi-twibbon-photo-upload').click();
  });
  $$('.mybsmi-twibbon-photo-download').on('click', function (e) {
    let canvas = document.getElementById("mybsmi-twibbon-canvas");
    fdownloadtwibbon(canvas, data[1]+'.png');
  });
  
  ///////////////loadposter/////////////////////////////////////////////
  let IMG_URL = 'https://cors.bsmijatim.workers.dev/?https://lh3.googleusercontent.com/d/'+safe(data[8]);
  let FILE_NAME = 'test'
  fdownloadfiletwibbonposter(IMG_URL,FILE_NAME);

   /////////////pilih photo///////////////////////////////////////////////
  let output = document.getElementById('mybsmi-twibbon-photo-upload');
  output.onchange = evt => {
    if (dashboarddata.user.userphoto === ''){flengkapidata();return;}
    const [file] = output.files
    if (file) {
        let output = document.getElementById('mybsmi-twibbon-photo');
        output.src = URL.createObjectURL(file)
        output.onload = function() {
          URL.revokeObjectURL(output.src)
          let canvasphoto = document.getElementById("mybsmi-twibbon-canvas-photo");
          canvasphoto.width = 1000;
          canvasphoto.height = 1000;
          let contextphoto = canvasphoto.getContext("2d", { willReadFrequently: true });
          contextphoto.clearRect(0, 0, canvasphoto.width, canvasphoto.height);
          let imgphoto = document.getElementById('mybsmi-twibbon-photo');
          
          ratio = imgphoto.width/imgphoto.height;
          width = canvasphoto.width;
          height = width/ratio;
          y = (width-height)/2;
          x = 0;
          if (height>width)
          {
            height = canvasphoto.height;
            width = height*ratio;
            x = (height-width)/2;
            y = 0;
          }    
          contextphoto.drawImage(imgphoto, 0, 0, imgphoto.width, imgphoto.height, x, y, width, height);
          
          let canvas = document.getElementById("mybsmi-twibbon-canvas");
          let context = canvas.getContext("2d", { willReadFrequently: true });
          let imgposter = document.getElementById('mybsmi-twibbon-poster');
          context.drawImage(imgphoto, 0, 0, imgphoto.width, imgphoto.height, x, y, width, height);
          context.drawImage(imgposter, 0, 0, canvas.width, canvas.height );
          $$('.mybsmi-twibbon-photo-button').hide();
          $$('.mybsmi-twibbon-photo-download').removeClass('display-none');
          $$('#zoom-slider').removeClass('display-none');
          if (!exists) fjadipendukung(data[1]);
          fgesertwibbonphoto();
          zoomtwibbonpoto()
        }

    }
  }
  
  /////////////////////zoomandpan///////////////////////////////////////
  let canvas = document.getElementById("mybsmi-twibbon-canvas");
  let context = canvas.getContext("2d", { willReadFrequently: true });
  let imgposter = document.getElementById('mybsmi-twibbon-poster');
  let canvasphoto = document.getElementById("mybsmi-twibbon-canvas-photo");
  let contextphoto = canvasphoto.getContext("2d", { willReadFrequently: true });
  let imgphoto = document.getElementById('mybsmi-twibbon-photo');  
  let ratio,width,height,y,x,myoffsetx,myoffsety;
  myoffsetx = 0;
  myoffsety = 0;

  function drawcanvas()
  {
          contextphoto.clearRect(0, 0, canvasphoto.width, canvasphoto.height);
          context.clearRect(0, 0, canvas.width, canvas.height);
          contextphoto.drawImage(imgphoto, 0, 0, imgphoto.width, imgphoto.height, x, y, width, height);
          var imgData = contextphoto.getImageData(0, 0, canvasphoto.width, canvasphoto.height);
          context.putImageData(imgData, 0, 0);
          context.drawImage(imgposter, 0, 0, canvas.width, canvas.height);
  }
  
  function zoomtwibbonpoto()
  {
      const slider = document.getElementById('zoom-slider');
      slider.value = 1;
      slider.min = 0.01;
      slider.max = 10;
      slider.step = 'any';
      slider.addEventListener('input', e => {
        //debugger
        contextphoto.clearRect(0, 0, canvasphoto.width, canvasphoto.height);
        const scale = e.target.value;//console.log('scale:'+scale);

        //contextphoto.scale(scale, scale); 
        //contextphoto.drawImage(imgphoto, 0, 0);
        //contextphoto.scale(1 / scale, 1 / scale);  
        
        let xsekarang = x;
        let ysekarang = y;

        ratio = imgphoto.width/imgphoto.height;
        width = canvasphoto.width;
        height = width/ratio;
        y = (width-height)/2;
        x = 0;
        if (height>width)
        {
          height = canvasphoto.height;
          width = height*ratio;
          x = (height-width)/2;
          y = 0;
        }
        
        
        width *= scale;
        height *= scale;
        
        let mx = (canvasphoto.width-width)/2-myoffsetx;
        let my = (canvasphoto.height-height)/2-myoffsety;
        
        x = mx;
        y = my;
        
        //console.log(x+ ':'+y);
               
        contextphoto.drawImage(imgphoto, 0, 0, imgphoto.width, imgphoto.height, mx, my, width, height);       
        context.clearRect(0, 0, canvas.width, canvas.height);
        var imgData = contextphoto.getImageData(0, 0, canvasphoto.width, canvasphoto.height);
        context.putImageData(imgData, 0, 0);
        context.drawImage(imgposter, 0, 0, canvas.width, canvas.height);
      });

      slider.ontouchstart=handleTouchStart;
      slider.ontouchend=handleTouchEnd;
      slider.onmousedown=handleMouseDown;
      slider.onmouseup=handleMouseUp;
      
      function handleTouchStart(e){
        context.globalAlpha = 0.2;
      }

      function handleTouchEnd(e){
        context.globalAlpha = 1.0;
        drawcanvas();
      }

      function handleMouseDown(e){
        context.globalAlpha = 0.2;
      }

      function handleMouseUp(e){
        context.globalAlpha = 1.0;
        drawcanvas();
      }

  }

  ///////////////////gesertwibbonphoto//////////////////////////////
  function fgesertwibbonphoto()
  {
    let canvas = document.getElementById("mybsmi-twibbon-canvas");
    let context = canvas.getContext("2d", { willReadFrequently: true });
    let imgposter = document.getElementById('mybsmi-twibbon-poster');
    let canvasphoto = document.getElementById("mybsmi-twibbon-canvas-photo");
    let contextphoto = canvasphoto.getContext("2d", { willReadFrequently: true });
    let imgphoto = document.getElementById('mybsmi-twibbon-photo');


    function reOffset(){
        var BB=canvas.getBoundingClientRect();
        offsetX=BB.left;
        offsetY=BB.top;        
    }
    
    var offsetX,offsetY;
    reOffset();
    window.onscroll=function(e){ reOffset(); }
    window.onresize=function(e){ reOffset(); }
    canvas.onresize=function(e){ reOffset(); }

    var isDragging=false;
    var startX,startY;
    var canvasWidth=canvas.width;
    var canvasHeight=canvas.height;
    var mx,my,nmyoffsetx,nmyoffsety;

    canvas.ontouchstart=handleTouchStart;
    canvas.ontouchend=handleTouchEnd;
    canvas.ontouchmove=handleTouchMove;
    canvas.onmousedown=handleMouseDown;
    canvas.onmousemove=handleMouseMove;
    canvas.onmouseup=handleMouseUp;
    canvas.onmouseout=handleMouseOut;
    
    function handleTouchStart(e){
      e.preventDefault();
      var touch = e.touches[0];
      startX=parseInt(touch.clientX-offsetX);
      startY=parseInt(touch.clientY-offsetY);
      // set the drag flag
      isDragging=true;
      context.globalAlpha = 0.2;
    }

    function handleTouchEnd(e){
      e.preventDefault();
      var touch = e.touches[0];
      //canMouseX=parseInt(touch.clientX-offsetX);
      //canMouseY=parseInt(touch.clientY-offsetY);
      // clear the drag flag
      isDragging=false;
      x = mx;
      y = my;
      myoffsetx += nmyoffsetx;
      myoffsety += nmyoffsety
      context.globalAlpha = 1.0;
      drawcanvas();
    }

    function handleTouchMove(e){
      e.preventDefault();
      var touch = e.touches[0];
      canMouseX=parseInt(touch.clientX-offsetX);
      canMouseY=parseInt(touch.clientY-offsetY);
      // if the drag flag is set, clear the canvas and draw the image
      if(isDragging){
          redraw(canMouseX,canMouseY);
      }
    }

    function handleMouseDown(e){
      startX=parseInt(e.clientX-offsetX);
      startY=parseInt(e.clientY-offsetY);
      // set the drag flag
      isDragging=true;
      context.globalAlpha = 0.2;
    }

    function handleMouseUp(e){
      canMouseX=parseInt(e.clientX-offsetX);
      canMouseY=parseInt(e.clientY-offsetY);
      // clear the drag flag
      isDragging=false;
      x = mx;
      y = my;
      myoffsetx += nmyoffsetx;
      myoffsety += nmyoffsety;
      context.globalAlpha = 1.0;
      drawcanvas();
    }

    function handleMouseOut(e){
      canMouseX=parseInt(e.clientX-offsetX);
      canMouseY=parseInt(e.clientY-offsetY);
      // user has left the canvas, so clear the drag flag
      //isDragging=false;
    }

    function handleMouseMove(e){
      canMouseX=parseInt(e.clientX-offsetX);
      canMouseY=parseInt(e.clientY-offsetY);
      // if the drag flag is set, clear the canvas and draw the image
      if(isDragging){
          //ctx.clearRect(0,0,canvasWidth,canvasHeight);
          //ctx.drawImage(img,canMouseX-128/2,canMouseY-120/2,128,120);
          //console.log(canMouseX+' : '+canMouseY);
          redraw(canMouseX,canMouseY);
      }
    }
    
    function redraw(myX,myY)
    {

          nmyoffsetx = (startX-myX)*4;
          nmyoffsety = (startY-myY)*4;
          
          mx = x-nmyoffsetx;
          my = y-nmyoffsety;
          
          contextphoto.clearRect(0, 0, canvasphoto.width, canvasphoto.height);
          context.clearRect(0, 0, canvas.width, canvas.height);
          contextphoto.drawImage(imgphoto, 0, 0, imgphoto.width, imgphoto.height, mx, my, width, height);
          var imgData = contextphoto.getImageData(0, 0, canvasphoto.width, canvasphoto.height);
          context.putImageData(imgData, 0, 0);
          context.drawImage(imgposter, 0, 0, canvas.width, canvas.height);
    }

  }
  
}



function fdownloadfiletwibbonposter(IMG_URL,FILE_NAME)
{
  const startTime = new Date().getTime();
  request = new XMLHttpRequest();
  request.responseType = "blob";
  request.open("get", IMG_URL, true);
  request.send();  
  let mypreloader = app.dialog.preloader();

  request.onreadystatechange = function () {
    if (this.readyState == 4 && this.status == 200) {
      const imageURL = window.URL.createObjectURL(this.response);
      mypreloader.close();
      let output = document.getElementById('mybsmi-twibbon-poster');
      output.src = imageURL;
      output.onload = function() {
      URL.revokeObjectURL(output.src)
      let canvas = document.getElementById("mybsmi-twibbon-canvas");
      canvas.width = 1000;
      canvas.height = 1000;
      let context = canvas.getContext("2d");
      let img1 = document.getElementById('mybsmi-twibbon-poster');
      context.drawImage(img1, 0, 0, canvas.width, canvas.height);
      }      
    }
  };

  request.onprogress = function (e) {
    const percent_complete = Math.floor((e.loaded / e.total) * 100);
    const duration = (new Date().getTime() - startTime) / 1000;
    const bps = e.loaded / duration;
    const kbps = Math.floor(bps / 1024);
    const time = (e.total - e.loaded) / bps;
    const seconds = Math.floor(time % 60);
    const minutes = Math.floor(time / 60);

    console.log(
      //`${percent_complete}% - ${kbps} Kbps - ${minutes} min ${seconds} sec remaining`
    );
  };
}

function fdownloadtwibbon(canvas, filename) {
  /// create an "off-screen" anchor tag
  var lnk = document.createElement('a'), e;

  /// the key here is to set the download attribute of the a tag
  lnk.download = filename;

  /// convert canvas content to data-uri for link. When download
  /// attribute is set the content pointed to by link will be
  /// pushed as "download" in HTML5 capable browsers
  lnk.href = canvas.toDataURL("image/png;base64");

  /// create a "fake" click-event to trigger the download
      if (document.createEvent) {
          e = document.createEvent("MouseEvents");
          e.initMouseEvent("click", true, true, window,
                          0, 0, 0, 0, 0, false, false, false,
                          false, 0, null);

          lnk.dispatchEvent(e);
      } else if (lnk.fireEvent) {
          lnk.fireEvent("onclick");
      }
}
///////////////fpagetwibbon/////////////////////////////////////////////////////////////////////////////////////



///////////////pendukung/////////////////////////////////////////////////////////////////////////////////////
function fjadipendukung(aktivitasid)
{
    //console.log(aktivitasid)
    let mypreloader = app.dialog.preloader();
    app.request({
      url: apidataurl,
      method: 'POST',
      cache: false,
      data : { token:mybsmiusertoken, command: 'jadipendukungaktivitas', aktivitasid:aktivitasid}, 
      success: function (data, status, xhr)
        {
          mypreloader.close();
          var status = JSON.parse(data).status;
          var content = JSON.parse(data).data;
          if (status == "success")
          {
            //console.log(content);
            fjadipendukungrun(content);
            dapatbintang(1);
          }
          else if (status == "failed")
          {
            //console.log("failed");
            //app.dialog.alert(content,'Terjadi Kesalahan');
          }
          else
          {
            //console.log("failed");
            //app.dialog.alert(content,'Terjadi Kesalahan');
          }
        },
      error: function (xhr, status, message)
        {
          //console.log(message);
          mypreloader.close();
          app.dialog.alert("Server sedang sibuk",'Terjadi Kesalahan');
        },
    })
}

function fjadipendukungrun(mydata)
{
  let pendukung = JSON.parse(mydata);
  let exists = false;
  $$('.mybsmi-twibbon-pendukungdetail').html('');
  $$('.mybsmi-twibbon-pendukung').text(pendukung.length);
  //console.log(pendukung);
  for (let i= pendukung.length-1;i>-1;i--)
  {
    if (pendukung[i].uid === dashboarddata.user.useruid) exists = true;
    let data = ''
+'          <div class="col-100 margin-bottom mybsmi-twibbon-pendukungdetail-item-'+safe(pendukung[i].uid)+'" style="width:100%">'
+'          <div class="float-left" style="width:3em;"><img src="avatar.png" style="width:1.5em;aspet-ratio 1/1;object-fit:cover;border-radius:50% 50%;overflow:hidden;"></div>'
+'          <div class="float-left" style="overflow: hidden;text-overflow: ellipsis;white-space: nowrap;width:70%">'+safe(pendukung[i].nama)+'</div>'
+'          </div>'
    $$('.mybsmi-twibbon-pendukungdetail').append(data);
    $$('.mybsmi-twibbon-pendukungdetail-item-'+pendukung[i].uid+' img').attr('src','https://drive.google.com/uc?export=view&id='+safe(pendukung[i].photo));
    $$('.mybsmi-twibbon-pendukungdetail-item-'+pendukung[i].uid).on('click', function (e) {
        let url = "/relawan/"+safe(pendukung[i].uid);
        //console.log(url);
        app.views.main.router.navigate(url);          
    });
    $$('.mybsmi-twibbon-pendukungdetail-item-'+pendukung[i].uid).css("cursor","pointer");
  }
}
/////////fpendukung/////////////////////////////////////////////////////////////



/////////relative_time/////////////////////////////////////////////////////////////////////////////
function relative_time(x) {
        if (!x) {
            return
        }
        var a = x;

        //a = a.trim(a);
        a = a.replace(/\.\d\d\d+/, "");
        a = a.replace(/-/, "/").replace(/-/, "/");
        a = a.replace(/T/, " ").replace(/Z/, " UTC");
        a = a.replace(/([\+\-]\d\d)\:?(\d\d)/, " $1$2");
        var b = new Date(a);
        var c = (arguments.length > 1) ? arguments[1] : new Date();
        var d = parseInt((c.getTime() - b) / 1000);
        d = (d < 2) ? 2 : d;
        var r = '';
        if (d < 60) {
            r = 'Baru saja dipublikasikan'
        } else if (d < 120) {
            r = '1 menit yang lalu'
        } else if (d < (45 * 60)) {
            r = (parseInt(d / 60, 10)).toString() + ' menit yang lalu'
        } else if (d < (2 * 60 * 60)) {
            r = '1 jam yang lalu'
        } else if (d < (24 * 60 * 60)) {
            r = '' + (parseInt(d / 3600, 10)).toString() + ' jam yang lalu'
        } else if (d < (48 * 60 * 60)) {
            r = '1 hari yang lalu'
        } else {
            r = (parseInt(d / 86400, 10)).toString() + ' hari yang lalu'
        }
        return (r.match('NaN') ? x : r)
}
/////////relative_time//////////////////////////////////////////////////////////////////////////////




///////////////////////////////////////////////////////////////////////////////////////////////////////
function fpagebukusaku(run = true)
{
  if (typeof mybsmibukusakudata === 'undefined' || mybsmibukusakudata === null)
  {
      let mypreloader = app.dialog.preloader();
      app.request({
        url: apidataurl,
        method: 'POST',
        cache: false,
        data : { token:mybsmiusertoken, command: 'getbukusakudata'}, 
        success: function (data, status, xhr)
          {
            mypreloader.close();
            var status = JSON.parse(data).status;
            var content = JSON.parse(data).data;
            if (status == "success")
            {
              //console.log(content);
              window.mybsmibukusakudata = content;
              if (run) getbukusakudatarun(content);
            }
            else if (status == "failed")
            {
              //console.log("failed");
              app.dialog.alert(content,'Terjadi Kesalahan');
            }
            else
            {
              //console.log("failed");
              app.dialog.alert(content,'Terjadi Kesalahan');
            }
          },
        error: function (xhr, status, message)
          {
            //console.log(message);
            mypreloader.close();
            app.dialog.alert("Server sedang sibuk",'Terjadi Kesalahan');
          },
      })
  }
  else
  {
    if (run) getbukusakudatarun(mybsmibukusakudata);
  }
}

function getbukusakudatarun(data)
{
  //console.log(data);
  for (let i=1;i<data.length;i++)
  {
    let html = ''
    +'            <div class="col-100 xsmall-75 small-50 medium-33 large-33 xlarge-33 mybsmi-bukusaku-item-'+i+'" data-index="'+i+'">'
    +'              <div class="card">'
    +                '<div class="card-header no-padding" style="overflow:hidden;"><img src="photo.svg" style="width:100%;aspect-ratio: 1 / 1;object-fit:cover;"></div>'
    +'                <div class="card-content card-content-padding">'
    +'                  <div style="font-weight:bold;overflow: hidden;text-overflow: ellipsis;white-space: nowrap;">'+safe(data[i][1])+'</div>'
    +'                  <div></div>'
    +'                </div>'
    +'                <div class="card-footer display-none">'                 
    +'                </div>'
    +'              </div>'
    +'            </div>';
    $$('.mybsmi-bukusaku').append(html);
    let url = 'https://lh3.googleusercontent.com/d/'+safe(data[i][0]);
    $$('.mybsmi-bukusaku-item-'+i+' img').attr('src',url);
    $$('.mybsmi-bukusaku-item-'+i).css('cursor','pointer');
    $$('.mybsmi-bukusaku-item-'+i).on('click', function (e) {
       //console.log($$(this).attr('data-index')) 
       let url = 'https://drive.google.com/file/d/'+safe(data[i][0])+'/preview';
       //let url = 'https://drive.google.com/uc?export=view&id='+safe(data[i][0]);
       //let url = 'https://drive.google.com/uc?export=view&id='+safe(data[i][0])+'#toolbar=0&navpanes=0&scrollbar=0&statusbar=0&messages=0&scrollbar=0';
       myviewer(url);         
    });
  }
  $$('.mybsmi-bukusaku').append('<div class="col-100 xsmall-75 small-50 medium-33 large-33 xlarge-33" ></div>');
  $$('.mybsmi-bukusaku').append('<div class="col-100 xsmall-75 small-50 medium-33 large-33 xlarge-33" ></div>');
}

function myviewer(data)
{
  
  const para = document.createElement("div");
  para.innerHTML = '<div style="background: rgba(0, 0, 0, 0.8);position: fixed;z-index: 1000000000000000;align-items: center;justify-content: center;display: flex;bottom: 0;left: 0;right: 0;top: 0;"><iframe id="mybsmi-iframe" src="" style="border-radius: 1em;display: block;margin: auto;height: 70vh;width: 90vw;object-fit: contain;background-image:none;background:#fff;"></div>';
  
  para.addEventListener("click",()=>{
    para.remove(); 
  })

  document.body.appendChild(para);
  $$('#mybsmi-iframe').attr('src',data);

}
////////////////////////////////////////////////////////////////////////////////////////////////////////
</script>
<!--end script------------------------------------------------------------------------------->  

<script>
  if (typeof navigator.serviceWorker !== 'undefined') {
    navigator.serviceWorker.register('sw.js')
  }
</script>
</body>
</html>